<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestReady Fridays</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Universal Menu -->
    <div id="universalMenu" class="universal-menu" style="display: none;">
        <div class="menu-toggle" onclick="toggleUniversalMenu()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="menu-content">
            <div class="menu-header">
                <h5><i class="fas fa-user"></i> Menu</h5>
                <button class="btn-close" onclick="toggleUniversalMenu()"></button>
            </div>
            <div class="menu-body">
                <div class="menu-item" onclick="viewProfile()">
                    <i class="fas fa-user-circle"></i>
                    <span>View Profile</span>
                </div>
                <div class="menu-item" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                    <span id="themeText">Dark Mode</span>
                </div>
                <div class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </div>
            </div>
        </div>
    </div>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .login-container {
            min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .logo {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .login-title {
            color: #333;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .role-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .role-btn {
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #666;
        }
        
        .role-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }
        
        .role-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        
        /* Universal Menu Styles */
        .universal-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        
        .menu-toggle {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-toggle:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        
        .menu-content {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .universal-menu.show .menu-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .menu-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h5 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .menu-header .btn-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
        }
        
        .menu-body {
            padding: 10px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.2s ease;
            color: #333;
        }
        
        .menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            color: #666;
        }
        
        .menu-item span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Dark mode styles for universal menu */
        body.dark-mode .menu-content {
            background: #2d3748;
            color: white;
        }
        
        body.dark-mode .menu-header {
            border-bottom-color: #4a5568;
        }
        
        body.dark-mode .menu-header h5 {
            color: white;
        }
        
        body.dark-mode .menu-item {
            color: white;
        }
        
        body.dark-mode .menu-item:hover {
            background-color: #4a5568;
        }
        
        body.dark-mode .menu-item i {
            color: #a0aec0;
        }
        
        .dashboard {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stars-display {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            color: #333;
            font-size: 1.2rem;
        }
        
        .content-tabs {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            border-bottom: 3px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: bold;
            padding: 15px 25px;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .learning-modules {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .module-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }
        
        .module-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .module-card.locked {
            opacity: 0.5;
            background: #f8f9fa;
            border-color: #dee2e6;
            cursor: not-allowed;
        }
        
        .module-card.locked .module-title::after {
            content: " (Locked)";
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .module-card.locked .module-actions button {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .module-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }
        
        .module-stars {
            background: #ffd700;
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .module-description {
            color: #666;
            margin-bottom: 20px;
        }
        
        .module-progress {
            margin-bottom: 15px;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .module-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            border-radius: 25px;
            font-weight: bold;
            padding: 8px 20px;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .game-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }
        
        .game-card.locked {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .game-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .game-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .game-cost {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .game-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            color: white;
            text-decoration: none;
        }
        
        .play-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Test Interface Styles */
        .modal {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .question-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .options-container {
            display: grid;
            gap: 10px;
        }
        
        .option-btn {
            text-align: left;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .list-group-numbered > li {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .alert {
            border-radius: 8px;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-light {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #e9ecef;
            color: #495057;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
        }
        
        body.dark-mode .login-card {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            border: 1px solid #444444;
        }
        
        body.dark-mode .dashboard-container {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
        }
        
        body.dark-mode .dashboard-header {
            background: rgba(40, 40, 40, 0.95);
            color: #ffffff;
            border-bottom: 2px solid #555555;
        }
        
        body.dark-mode .content-tabs {
            background: rgba(40, 40, 40, 0.95);
            color: #ffffff;
        }
        
        body.dark-mode .module-card {
            background: rgba(45, 45, 45, 0.9);
            color: #ffffff;
            border: 2px solid #666666;
        }
        
        body.dark-mode .module-card:hover {
            border-color: #007bff;
            background: rgba(55, 55, 55, 0.9);
        }
        
        body.dark-mode .module-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #ffffff;
        }
        
        body.dark-mode .game-card {
            background: rgba(45, 45, 45, 0.9);
            color: #ffffff;
            border: 2px solid #666666;
        }
        
        body.dark-mode .game-card:hover {
            border-color: #007bff;
            background: rgba(55, 55, 55, 0.9);
        }
        
        body.dark-mode .game-card.locked {
            background: rgba(35, 35, 35, 0.7);
            opacity: 0.7;
            border-color: #444444;
        }
        
        body.dark-mode .form-control {
            background: rgba(50, 50, 50, 0.9);
            border: 2px solid #666666;
            color: #ffffff;
        }
        
        body.dark-mode .form-control:focus {
            background: rgba(60, 60, 60, 0.9);
            border-color: #007bff;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        body.dark-mode .nav-tabs .nav-link {
            color: #cccccc;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555555;
        }
        
        body.dark-mode .nav-tabs .nav-link:hover {
            background: rgba(60, 60, 60, 0.9);
            color: #ffffff;
            border-color: #777777;
        }
        
        body.dark-mode .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: #ffffff;
            border-color: #007bff;
        }
        
        body.dark-mode .modal-content {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            border: 2px solid #555555;
        }
        
        body.dark-mode .modal-header {
            border-bottom: 2px solid #555555;
            background: rgba(40, 40, 40, 0.9);
        }
        
        body.dark-mode .modal-footer {
            border-top: 2px solid #555555;
            background: rgba(40, 40, 40, 0.9);
        }
        
        body.dark-mode .list-group-item {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid #666666;
            color: #ffffff;
        }
        
        body.dark-mode .alert-info {
            background: linear-gradient(135deg, #0d4f8c 0%, #1e5f99 100%);
            border: 2px solid #007bff;
            color: #ffffff;
        }
        
        body.dark-mode .alert-warning {
            background: linear-gradient(135deg, #8b5a00 0%, #b8860b 100%);
            border: 2px solid #ffc107;
            color: #ffffff;
        }
        
        body.dark-mode .alert-light {
            background: linear-gradient(135deg, #404040 0%, #505050 100%);
            border: 2px solid #666666;
            color: #ffffff;
        }
        
        /* Additional dark mode improvements */
        body.dark-mode .table {
            color: #ffffff;
        }
        
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: rgba(60, 60, 60, 0.5);
        }
        
        body.dark-mode .table-hover > tbody > tr:hover > td {
            background-color: rgba(80, 80, 80, 0.7);
        }
        
        body.dark-mode .card {
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #555555;
            color: #ffffff;
        }
        
        body.dark-mode .card-header {
            background: rgba(50, 50, 50, 0.9);
            border-bottom: 2px solid #666666;
        }
        
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: 2px solid #007bff;
        }
        
        body.dark-mode .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            border: 2px solid #6c757d;
            color: #ffffff;
        }
        
        /* Ensure all text is light in dark mode */
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5,
        body.dark-mode h6 {
            color: #ffffff !important;
        }
        
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode div,
        body.dark-mode label {
            color: #ffffff !important;
        }
        
        body.dark-mode .text-muted {
            color: #cccccc !important;
        }
        
        body.dark-mode .text-secondary {
            color: #cccccc !important;
        }
        
        body.dark-mode .badge {
            color: #ffffff !important;
        }
        
        body.dark-mode .small {
            color: #cccccc !important;
        }
        
        body.dark-mode .form-label {
            color: #ffffff !important;
        }
        
        body.dark-mode .form-text {
            color: #cccccc !important;
        }
        
        body.dark-mode .dropdown-menu {
            background: rgba(40, 40, 40, 0.95);
            border: 2px solid #555555;
        }
        
        body.dark-mode .dropdown-item {
            color: #ffffff !important;
        }
        
        body.dark-mode .dropdown-item:hover {
            background: rgba(60, 60, 60, 0.9);
            color: #ffffff !important;
        }
        
        /* Classroom code styling */
        .classroom-code-section {
            background: rgba(248, 249, 250, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .classroom-code {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: bold;
            color: #495057;
        }
        
        body.dark-mode .classroom-code-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.dark-mode .classroom-code {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
        
        /* Bootstrap utility classes for dark mode */
        body.dark-mode .text-primary {
            color: #80b3ff !important;
        }
        
        body.dark-mode .text-success {
            color: #90ee90 !important;
        }
        
        body.dark-mode .text-warning {
            color: #ffd700 !important;
        }
        
        body.dark-mode .text-danger {
            color: #ff6b6b !important;
        }
        
        body.dark-mode .text-info {
            color: #87ceeb !important;
        }
        
        body.dark-mode .text-light {
            color: #ffffff !important;
        }
        
        body.dark-mode .text-dark {
            color: #ffffff !important;
        }
        
        body.dark-mode a {
            color: #80b3ff !important;
        }
        
        body.dark-mode a:hover {
            color: #a0c4ff !important;
        }
        
        /* Admin table specific styling */
        body.dark-mode .table th {
            background-color: rgba(40, 40, 40, 0.9) !important;
            color: #ffffff !important;
            border-color: #555555 !important;
        }
        
        body.dark-mode .table td {
            color: #ffffff !important;
            border-color: #555555 !important;
        }
        
        body.dark-mode .table thead th {
            background-color: rgba(30, 30, 30, 0.95) !important;
            color: #ffffff !important;
            font-weight: bold;
        }
        
        /* Avatar styling for student display */
        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .student-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        /* Competition Leaderboard Styles */
        .leaderboard {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        
        .leaderboard-item:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-item .rank {
            width: 40px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .leaderboard-item .student-info {
            flex: 1;
            margin-right: 15px;
        }
        
        .leaderboard-item .student-info strong {
            display: block;
            font-size: 16px;
            color: #333;
        }
        
        .leaderboard-item .student-info small {
            color: #666;
            font-size: 12px;
        }
        
        .leaderboard-item .score {
            font-weight: bold;
            font-size: 16px;
            color: #007bff;
            text-align: right;
        }
        
        .competition-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .competition-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
    </style>
</head>
<body>
    
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 class="login-title">TestReady Fridays</h1>
            <p class="text-muted mb-4">Sign in with your ID or email</p>

            <!-- Universal Login Form -->
            <div id="universalLogin" class="login-form active">
                <h3>Sign In</h3>
                <form onsubmit="loginAuto(event)">
                    <div class="form-group">
                        <label class="form-label">ID or Email</label>
                        <input type="text" class="form-control" id="loginId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
            </div>

            <!-- Hide old role selection UI -->
            <div class="role-buttons" style="display:none;">
                <button class="role-btn" onclick="selectRole('student')">
                    <i class="fas fa-user-graduate"></i><br>
                    Student
                </button>
                <button class="role-btn" onclick="selectRole('teacher')">
                    <i class="fas fa-chalkboard-teacher"></i><br>
                    Teacher
                </button>
                <button class="role-btn" onclick="selectRole('admin')">
                    <i class="fas fa-user-shield"></i><br>
                    Admin
                </button>
            </div>
            
            <div class="text-center mt-3">
                <small class="text-muted">Don't have an account? <a href="#" onclick="showRegistration()" class="text-primary">Register here</a></small>
                    </div>
            
            <!-- Student Login Form (hidden) -->
            <div id="studentForm" class="login-form" style="display:none;">
                <h3>Student Login</h3>
                <form onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="studentId" required>
                  </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="studentPassword" required>
                </div>
                    <button type="submit" class="login-btn">Login as Student</button>
                </form>
              </div>
            
            <!-- Student Registration Form -->
            <div id="studentRegistration" class="login-form">
                <h3>Student Registration</h3>
                <form onsubmit="register('student', event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="regStudentName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="regStudentId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grade Level</label>
                        <select class="form-control" id="regStudentGrade" required>
                            <option value="">Select your grade</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="regStudentPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="regStudentConfirmPassword" required>
                    </div>
                    <button type="submit" class="login-btn">Register as Student</button>
                    <button type="button" class="btn btn-secondary mt-2" onclick="showLogin()">Back to Login</button>
                </form>
            </div>
            
            <!-- Teacher Login Form (hidden) -->
            <div id="teacherForm" class="login-form" style="display:none;">
                <h3>Teacher Login</h3>
                <form onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">Teacher ID</label>
                        <input type="text" class="form-control" id="teacherId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="teacherPassword" required>
                    </div>
                    <button type="submit" class="login-btn">Login as Teacher</button>
                </form>
            </div>
            
            <!-- Admin Login Form (hidden) -->
            <div id="adminForm" class="login-form" style="display:none;">
                <h3>Admin Login</h3>
                <form onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">Admin ID</label>
                        <input type="text" class="form-control" id="adminId" required>
          </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="adminPassword" required>
          </div>
                    <button type="submit" class="login-btn">Login as Admin</button>
                </form>
        </div>
      </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        
        <div class="dashboard-header">
            <div class="user-info">
                <div>
                    <h2><i class="fas fa-user-shield"></i> Admin Dashboard</h2>
                    <p>Welcome back, <span id="adminName">Admin</span>!</p>
                </div>
            </div>
        </div>
        
        <div class="content-tabs">
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                        <i class="fas fa-users"></i> All Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="adminTabContent">
                <!-- Users Tab -->
                <div class="tab-pane fade show active" id="users" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3><i class="fas fa-users"></i> All Users</h3>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-block me-2">
                                <select class="form-select" id="roleFilter" onchange="loadAllUsers()">
                                    <option value="all">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="student">Student</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadAllUsers()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th onclick="sortByRole()" style="cursor: pointer;">
                                        Role <i class="fas fa-sort" id="roleSortIcon"></i>
                                    </th>
                                    <th>Grade</th>
                                    <th>Stars</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3><i class="fas fa-chart-bar"></i> System Analytics</h3>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadAnalytics()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4" id="statsCards">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Users</h5>
                                    <h2 id="totalUsers">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Students</h5>
                                    <h2 id="totalStudents">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Teachers</h5>
                                    <h2 id="totalTeachers">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Stars</h5>
                                    <h2 id="totalStars">-</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>User Roles Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="roleChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Student Grade Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="gradeChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <h3><i class="fas fa-cog"></i> System Settings</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>System Health</h5>
                                </div>
                                <div class="card-body">
                                    <p><i class="fas fa-check-circle text-success"></i> Database: Connected</p>
                                    <p><i class="fas fa-check-circle text-success"></i> API: Online</p>
                                    <p><i class="fas fa-check-circle text-success"></i> All systems operational</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>System Information</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Version:</strong> 1.0.0</p>
                                    <p><strong>Database:</strong> SQLite</p>
                                    <p><strong>API Status:</strong> <span class="badge bg-success">Online</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="dashboard">
        
        <div class="dashboard-header">
            <div class="user-info">
                <div>
                    <h2><i class="fas fa-chalkboard-teacher"></i> Teacher Dashboard</h2>
                    <p>Welcome back, <span id="teacherName">Teacher</span>!</p>
                </div>
            </div>
        </div>
        
        <div class="content-tabs">
            <ul class="nav nav-tabs" id="teacherTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="classrooms-tab" data-bs-toggle="tab" data-bs-target="#classrooms" type="button" role="tab">
                        <i class="fas fa-chalkboard"></i> My Classrooms
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab">
                        <i class="fas fa-plus"></i> Create Content
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="competitions-tab" data-bs-toggle="tab" data-bs-target="#competitions" type="button" role="tab">
                        <i class="fas fa-trophy"></i> Competitions
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="teacherTabContent">
                <!-- Classrooms Tab -->
                <div class="tab-pane fade show active" id="classrooms" role="tabpanel">
                    <h3>My Classrooms</h3>
                    <div id="teacherClassroomsList">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Loading your classrooms...
                        </div>
                    </div>
                </div>
                
                <!-- Create Content Tab -->
                <div class="tab-pane fade" id="create" role="tabpanel">
                    <h3>Create Content</h3>
                      <div class="row">
                        <div class="col-md-4">
                            <div class="game-card">
                                <div class="game-icon text-primary">📝</div>
                                <div class="game-title">Create Quiz</div>
                                <div class="game-description">Create custom quizzes for your students</div>
                                <button class="play-btn" onclick="createQuiz()">Create Quiz</button>
                        </div>
                      </div>
                        <div class="col-md-4">
                            <div class="game-card">
                                <div class="game-icon text-warning">📊</div>
                                <div class="game-title">View Analytics</div>
                                <div class="game-description">Track student progress and performance</div>
                                <button class="play-btn" onclick="window.open('analytics-working.html', '_blank')">View Analytics</button>
                    </div>
                    </div>
                  </div>
                </div>
                
                <!-- Competitions Tab -->
                <div class="tab-pane fade" id="competitions" role="tabpanel">
                    <div class="container-fluid">
                        <h2 class="mb-4">🏆 Student Competitions & Leaderboards</h2>
                        
                        <!-- Competition Tabs -->
                        <ul class="nav nav-pills mb-4" id="competitionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="games-tab" data-bs-toggle="pill" data-bs-target="#games" type="button" role="tab">
                                    <i class="fas fa-gamepad"></i> Game Leaderboards
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="challenges-tab" data-bs-toggle="pill" data-bs-target="#challenges" type="button" role="tab">
                                    <i class="fas fa-brain"></i> Speed Challenges
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="overall-tab" data-bs-toggle="pill" data-bs-target="#overall" type="button" role="tab">
                                    <i class="fas fa-crown"></i> Overall Rankings
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="competitionTabContent">
                            <!-- Game Leaderboards -->
                            <div class="tab-pane fade show active" id="games" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0"><i class="fas fa-puzzle-piece"></i> Math Puzzle Game</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="leaderboard">
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥇</div>
                                                        <div class="student-info">
                                                            <strong>Hermione Granger</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">2,847 pts</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥈</div>
                                                        <div class="student-info">
                                                            <strong>Harry Potter</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">2,156 pts</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥉</div>
                                                        <div class="student-info">
                                                            <strong>Luna Lovegood</strong>
                                                            <small class="text-muted">Grade 6</small>
                                                        </div>
                                                        <div class="score">1,892 pts</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">4</div>
                                                        <div class="student-info">
                                                            <strong>Neville Longbottom</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">1,634 pts</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h5 class="mb-0"><i class="fas fa-atom"></i> Science Quiz Game</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="leaderboard">
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥇</div>
                                                        <div class="student-info">
                                                            <strong>Hermione Granger</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">3,421 pts</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥈</div>
                                                        <div class="student-info">
                                                            <strong>Cedric Diggory</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">2,987 pts</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥉</div>
                                                        <div class="student-info">
                                                            <strong>Luna Lovegood</strong>
                                                            <small class="text-muted">Grade 6</small>
                                                        </div>
                                                        <div class="score">2,543 pts</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">4</div>
                                                        <div class="student-info">
                                                            <strong>Harry Potter</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">2,234 pts</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Speed Challenges -->
                            <div class="tab-pane fade" id="challenges" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-warning text-white">
                                                <h5 class="mb-0"><i class="fas fa-stopwatch"></i> Math Speed Challenge</h5>
                                                <small>Fastest problem solving</small>
                                            </div>
                                            <div class="card-body">
                                                <div class="leaderboard">
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥇</div>
                                                        <div class="student-info">
                                                            <strong>Hermione Granger</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">45 sec</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥈</div>
                                                        <div class="student-info">
                                                            <strong>Harry Potter</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">52 sec</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥉</div>
                                                        <div class="student-info">
                                                            <strong>Luna Lovegood</strong>
                                                            <small class="text-muted">Grade 6</small>
                                                        </div>
                                                        <div class="score">58 sec</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <h5 class="mb-0"><i class="fas fa-book"></i> Reading Speed Challenge</h5>
                                                <small>Words per minute</small>
                                            </div>
                                            <div class="card-body">
                                                <div class="leaderboard">
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥇</div>
                                                        <div class="student-info">
                                                            <strong>Hermione Granger</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">280 WPM</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥈</div>
                                                        <div class="student-info">
                                                            <strong>Luna Lovegood</strong>
                                                            <small class="text-muted">Grade 6</small>
                                                        </div>
                                                        <div class="score">265 WPM</div>
                                                    </div>
                                                    <div class="leaderboard-item">
                                                        <div class="rank">🥉</div>
                                                        <div class="student-info">
                                                            <strong>Harry Potter</strong>
                                                            <small class="text-muted">Grade 7</small>
                                                        </div>
                                                        <div class="score">245 WPM</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Overall Rankings -->
                            <div class="tab-pane fade" id="overall" role="tabpanel">
                                <div class="card">
                                    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <h4 class="mb-0"><i class="fas fa-crown"></i> Overall Student Rankings</h4>
                                        <small>Combined performance across all activities</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Rank</th>
                                                        <th>Student</th>
                                                        <th>Grade</th>
                                                        <th>Total Points</th>
                                                        <th>Games Played</th>
                                                        <th>Avg Score</th>
                                                        <th>Streak</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr class="table-warning">
                                                        <td><strong>🥇 1st</strong></td>
                                                        <td><strong>Hermione Granger</strong></td>
                                                        <td>Grade 7</td>
                                                        <td><span class="badge bg-success">15,847</span></td>
                                                        <td>45</td>
                                                        <td>98%</td>
                                                        <td><span class="text-success">🔥 12 days</span></td>
                                                    </tr>
                                                    <tr class="table-light">
                                                        <td><strong>🥈 2nd</strong></td>
                                                        <td><strong>Harry Potter</strong></td>
                                                        <td>Grade 7</td>
                                                        <td><span class="badge bg-primary">12,234</span></td>
                                                        <td>38</td>
                                                        <td>92%</td>
                                                        <td><span class="text-success">🔥 8 days</span></td>
                                                    </tr>
                                                    <tr class="table-light">
                                                        <td><strong>🥉 3rd</strong></td>
                                                        <td><strong>Luna Lovegood</strong></td>
                                                        <td>Grade 6</td>
                                                        <td><span class="badge bg-info">11,567</span></td>
                                                        <td>42</td>
                                                        <td>89%</td>
                                                        <td><span class="text-success">🔥 5 days</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>4th</strong></td>
                                                        <td><strong>Cedric Diggory</strong></td>
                                                        <td>Grade 7</td>
                                                        <td><span class="badge bg-secondary">9,876</span></td>
                                                        <td>35</td>
                                                        <td>87%</td>
                                                        <td><span class="text-warning">🔥 3 days</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>5th</strong></td>
                                                        <td><strong>Neville Longbottom</strong></td>
                                                        <td>Grade 7</td>
                                                        <td><span class="badge bg-secondary">8,234</span></td>
                                                        <td>28</td>
                                                        <td>82%</td>
                                                        <td><span class="text-muted">🔥 1 day</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Competitions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list"></i> Active Competitions</h5>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary" onclick="updateCompetitionsDisplay()">
                                                <i class="fas fa-sync-alt"></i> Refresh
                                            </button>
                                            <button class="btn btn-sm btn-outline-success ms-2" onclick="createTestCompetition()">
                                                <i class="fas fa-plus"></i> Test Competition
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="teacherCompetitionsList">
                                            <!-- Competitions will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Competition Management -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5><i class="fas fa-plus-circle"></i> Create New Competition</h5>
                                        <p>Set up a new game or educational challenge for your students.</p>
                                        <button class="btn btn-primary" onclick="openCompetitionModal()">Create Competition</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5><i class="fas fa-chart-line"></i> Competition Analytics</h5>
                                        <p>View detailed statistics and participation rates for all competitions.</p>
                                        <button class="btn btn-success">View Analytics</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="dashboard">
        
        <div class="dashboard-header">
            <div class="user-info">
                <div>
                    <h2><i class="fas fa-user-graduate"></i> Student Dashboard</h2>
                    <p>Welcome back, <span id="studentName">Student</span>!</p>
                </div>
                <div class="stars-display">
                    <i class="fas fa-star"></i> <span id="studentStars">50</span> Stars
                    <small class="text-muted ms-2" id="syncStatus" style="display: none;">
                        <i class="fas fa-sync-alt fa-spin"></i> Syncing...
                    </small>
                </div>
            </div>
        </div>
        
        <div class="content-tabs">
            <ul class="nav nav-tabs" id="studentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning" type="button" role="tab">
                        <i class="fas fa-book"></i> Learning Modules
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="classrooms-student-tab" data-bs-toggle="tab" data-bs-target="#classrooms-student" type="button" role="tab">
                        <i class="fas fa-chalkboard"></i> My Classrooms
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="games-tab" data-bs-toggle="tab" data-bs-target="#games" type="button" role="tab">
                        <i class="fas fa-gamepad"></i> Games
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="testprep-tab" data-bs-toggle="tab" data-bs-target="#testprep" type="button" role="tab">
                        <i class="fas fa-graduation-cap"></i> Test Prep
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="competitions-student-tab" data-bs-toggle="tab" data-bs-target="#competitions-student" type="button" role="tab">
                        <i class="fas fa-trophy"></i> Competitions
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button" role="tab">
                        <i class="fas fa-chart-line"></i> Progress
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="studentTabContent">
                <!-- Learning Tab -->
                <div class="tab-pane fade show active" id="learning" role="tabpanel">
                    <h3>Learning Modules</h3>
                    <p>Complete modules to earn stars and unlock games!</p>
                    
                    <!-- Classroom Section -->
                    <div class="module-card mb-4">
                        <div class="module-header">
                            <div class="module-title">Join Classroom</div>
                            <div class="module-stars">+5 ⭐</div>
                  </div>
                        <div class="module-description">
                            Join your teacher's classroom to access custom quizzes and competitions!
                  </div>
                        <div class="module-actions">
                            <button class="btn btn-primary" onclick="showJoinClassroom()">Join Classroom</button>
                </div>
              </div>
              
                    <div class="learning-modules">
                        <div class="module-card" id="module1">
                            <div class="module-header">
                                <div class="module-title">Grade 3 Math Test Prep</div>
                                <div class="module-stars">+10 ⭐</div>
                    </div>
                            <div class="module-description">
                                Master addition, subtraction, multiplication, and division for state testing. Includes practice problems and test strategies.
                            </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <small>Progress: <span id="module1Progress">0</span>%</small>
                            </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module1')">Start Test Prep</button>
                    </div>
                  </div>
                  
                        <div class="module-card" id="module2">
                            <div class="module-header">
                                <div class="module-title">Grade 4 Math Practice</div>
                                <div class="module-stars">+12 ⭐</div>
            </div>
                            <div class="module-description">
                                Fractions, decimals, geometry, and measurement for standardized tests. Practice with real test questions.
              </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                   </div>
                                <small>Progress: <span id="module2Progress">0</span>%</small>
                 </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module2')">Start Test Prep</button>
                 </div>
               </div>
                        
                        <div class="module-card" id="module3">
                            <div class="module-header">
                                <div class="module-title">Grade 7 Writing Practice</div>
                                <div class="module-stars">+15 ⭐</div>
                      </div>
                            <div class="module-description">
                                Argumentative essay writing with rubric-based scoring. Practice with real writing prompts and feedback.
                            </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <small>Progress: <span id="module3Progress">0</span>%</small>
                            </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module3')">Start Test Prep</button>
                    </div>
                  </div>
                  
                        <div class="module-card" id="module4">
                            <div class="module-header">
                                <div class="module-title">Grade 8 Algebra Prep</div>
                                <div class="module-stars">+18 ⭐</div>
            </div>
                            <div class="module-description">
                                Linear equations, slope, and algebraic reasoning for high school readiness tests.
              </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                      </div>
                                <small>Progress: <span id="module4Progress">0</span>%</small>
                    </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module4')">Start Test Prep</button>
                  </div>
                </div>
                
                        <div class="module-card" id="module5">
                            <div class="module-header">
                                <div class="module-title">Test-Taking Strategies</div>
                                <div class="module-stars">+8 ⭐</div>
                    </div>
                            <div class="module-description">
                                Master general test strategies, time management, and anxiety reduction techniques.
                            </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <small>Progress: <span id="module5Progress">0</span>%</small>
                            </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module5')">Start Learning</button>
                            </div>
                        </div>
                    </div>
                  </div>
                  
                <!-- My Classrooms Tab -->
                <div class="tab-pane fade" id="classrooms-student" role="tabpanel">
                    <h3>My Classrooms</h3>
                    <p>View and access your classroom content.</p>
                    
                    <div id="studentClassroomsList">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Loading your classrooms...
                        </div>
                    </div>
                </div>
                  
                <!-- Games Tab -->
                <div class="tab-pane fade" id="games" role="tabpanel">
                    <h3>Games</h3>
                    <p>Spend stars to play games and have fun!</p>
                    
                    <div class="games-grid">
                        <div class="game-card" id="flappyGameCard">
                            <div class="game-icon text-warning">🎮</div>
                            <div class="game-title">Flappy Bird</div>
                            <div class="game-cost">Cost: 10 ⭐</div>
                            <div class="game-description">Test your reflexes and timing!</div>
                            <button class="play-btn" onclick="playGame('flappy')" id="flappyBtn">Play Game</button>
                    </div>
                        
                        <div class="game-card" id="memoryGameCard">
                            <div class="game-icon text-danger">🧠</div>
                            <div class="game-title">Memory Game</div>
                            <div class="game-cost">Cost: 12 ⭐</div>
                            <div class="game-description">Challenge your memory skills!</div>
                            <button class="play-btn" onclick="playGame('memory')" id="memoryBtn">Play Game</button>
                        </div>
                        
                        <div class="game-card" id="snakesGameCard">
                            <div class="game-icon text-success">🐍</div>
                            <div class="game-title">Snakes</div>
                            <div class="game-cost">Cost: 15 ⭐</div>
                            <div class="game-description">Control the snake and grow longer!</div>
                            <button class="play-btn" onclick="playGame('snakes')" id="snakesBtn">Play Game</button>
                        </div>
                    </div>
                  </div>
                  
                <!-- Test Prep Tab -->
                <div class="tab-pane fade" id="testprep" role="tabpanel">
                    <h3>Standardized Test Prep</h3>
                    <p>Watch helpful videos and practice questions to prepare for standardized tests. Earn stars for your efforts!</p>
                    
                    <!-- Video Section -->
                    <div class="mb-5">
                        <h4 class="mb-3"><i class="fas fa-video"></i> Test Prep Videos</h4>
                        <p class="text-muted mb-3">Watch videos to learn test-taking strategies and subject reviews. Earn 5 stars for each video completed!</p>
                        <div class="learning-modules">
                            <div class="module-card" id="video1">
                                <div class="module-header">
                                    <div class="module-title">Test-Taking Strategies</div>
                                    <div class="module-stars">+5 ⭐</div>
                                </div>
                                <div class="module-description">
                                    Learn essential strategies for multiple-choice tests, time management, and reducing test anxiety.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="watchVideo('video1', 'Test-Taking Strategies', 'https://www.youtube.com/embed/meLuJuhY608')">
                                        <i class="fas fa-play"></i> Watch Video
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card" id="video2">
                                <div class="module-header">
                                    <div class="module-title">Math Problem Solving</div>
                                    <div class="module-stars">+5 ⭐</div>
                                </div>
                                <div class="module-description">
                                    Master techniques for solving math problems quickly and accurately on standardized tests.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="watchVideo('video2', 'Math Problem Solving', 'https://www.youtube.com/embed/PQ_-T2qrmrg')">
                                        <i class="fas fa-play"></i> Watch Video
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card" id="video3">
                                <div class="module-header">
                                    <div class="module-title">Reading Comprehension Tips</div>
                                    <div class="module-stars">+5 ⭐</div>
                                </div>
                                <div class="module-description">
                                    Improve your reading comprehension skills with proven strategies for understanding passages and answering questions.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="watchVideo('video3', 'Reading Comprehension Tips', 'https://www.youtube.com/embed/Zc292b0QFZU')">
                                        <i class="fas fa-play"></i> Watch Video
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card" id="video4">
                                <div class="module-header">
                                    <div class="module-title">Science Test Strategies</div>
                                    <div class="module-stars">+5 ⭐</div>
                                </div>
                                <div class="module-description">
                                    Learn how to analyze data, interpret graphs, and apply scientific reasoning on tests.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="watchVideo('video4', 'Science Test Strategies', 'https://www.youtube.com/embed/5HNQM25k8UY')">
                                        <i class="fas fa-play"></i> Watch Video
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card" id="video5">
                                <div class="module-header">
                                    <div class="module-title">English Writing & Grammar</div>
                                    <div class="module-stars">+5 ⭐</div>
                                </div>
                                <div class="module-description">
                                    Master essay writing, grammar rules, and literary analysis techniques for standardized tests.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="watchVideo('video5', 'English Writing & Grammar', 'https://www.youtube.com/embed/eZ0DQNaHWLg')">
                                        <i class="fas fa-play"></i> Watch Video
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Practice Questions Section -->
                    <div class="mb-5">
                        <h4 class="mb-3"><i class="fas fa-question-circle"></i> Practice Questions</h4>
                        <p class="text-muted mb-3">Answer practice questions similar to those on standardized tests. Earn 3 stars for each correct answer!</p>
                        <div class="learning-modules">
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title">Math Practice Questions</div>
                                    <div class="module-stars">+3 ⭐ each</div>
                                </div>
                                <div class="module-description">
                                    Practice with 10 math questions covering algebra, geometry, and problem-solving.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="startPracticeTest('math')">
                                        <i class="fas fa-pencil-alt"></i> Start Practice
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title">Reading Practice Questions</div>
                                    <div class="module-stars">+3 ⭐ each</div>
                                </div>
                                <div class="module-description">
                                    Answer 10 reading comprehension questions based on sample passages.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="startPracticeTest('reading')">
                                        <i class="fas fa-pencil-alt"></i> Start Practice
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title">Science Practice Questions</div>
                                    <div class="module-stars">+3 ⭐ each</div>
                                </div>
                                <div class="module-description">
                                    Test your knowledge with 10 science questions on various topics.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="startPracticeTest('science')">
                                        <i class="fas fa-pencil-alt"></i> Start Practice
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title">English Practice Questions</div>
                                    <div class="module-stars">+3 ⭐ each</div>
                                </div>
                                <div class="module-description">
                                    Practice grammar, vocabulary, and writing skills with 10 English questions.
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="startPracticeTest('english')">
                                        <i class="fas fa-pencil-alt"></i> Start Practice
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                  
                <!-- Competitions Tab -->
                <div class="tab-pane fade" id="competitions-student" role="tabpanel">
                    <h3>🏆 Available Competitions</h3>
                    <p>Join competitions to compete with your classmates and earn recognition!</p>
                    
                    <div id="studentCompetitionsList">
                        <!-- Competitions will be loaded here -->
                    </div>
                </div>
                
                <!-- Progress Tab -->
                <div class="tab-pane fade" id="progress" role="tabpanel">
                    <h3>Your Progress</h3>
                    <p>Track your learning journey and achievements.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="module-card">
                                <h4>Total Stars Earned</h4>
                                <div class="stars-display" style="font-size: 2rem;">
                                    <i class="fas fa-star"></i> <span id="totalStars">50</span>
                    </div>
                      </div>
                    </div>
                        <div class="col-md-6">
                            <div class="module-card">
                                <h4>Modules Completed</h4>
                                <div class="text-success" style="font-size: 2rem;">
                                    <i class="fas fa-trophy"></i> <span id="completedModules">0</span>
                  </div>
                </div>
              </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let userStars = 0;
        let userGrade = null;
        let moduleProgress = {
            module1: 0,
            module2: 0,
            module3: 0,
            module4: 0,
            module5: 0
        };
        let completedModules = 0;
        let watchedVideos = [];
        let practiceTestProgress = {
            math: [],
            reading: [],
            science: [],
            english: []
        };
        
        // Theme management
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        // Load saved user data from localStorage and sync with database
        async function loadSavedUserData() {
            const savedUser = localStorage.getItem('currentUser');
            const savedStars = localStorage.getItem('userStars');
            const savedGrade = localStorage.getItem('userGrade');
            
            console.log('Loading saved user data:', {
                hasUser: !!savedUser,
                savedStars: savedStars,
                savedGrade: savedGrade
            });
            
            if (savedUser && savedStars && savedGrade) {
                try {
                    currentUser = JSON.parse(savedUser);
                    userGrade = savedGrade;
                    userStars = parseInt(savedStars) || 0; // Set userStars from localStorage
                    
                    console.log('Loaded from localStorage:', {
                        user: `${currentUser.firstName} ${currentUser.lastName}`,
                        stars: userStars,
                        grade: userGrade
                    });
                    
                    // Sync with database to get latest data
                    await syncWithDatabase();
                    
                    // Start periodic sync with database
                    startPeriodicSync();
                    
                    // If user is logged in, show appropriate dashboard
                    if (currentUser.role === 'student') {
                        showStudentDashboard();
                        // Force update display after dashboard is shown
                        setTimeout(() => {
                            updateStarsDisplay();
                            updateGameAvailability();
                        }, 100);
                    } else if (currentUser.role === 'teacher') {
                        showTeacherDashboard();
                    } else if (currentUser.role === 'admin') {
                        showAdminDashboard();
                    }
                } catch (error) {
                    console.error('Error loading saved user data:', error);
                    clearSavedUserData();
                }
            } else {
                console.log('No saved user data found, showing login page');
            }
        }
        
        // Sync user data with database
        async function syncWithDatabase() {
            if (!currentUser) {
                console.log('No current user, skipping sync');
                return;
            }
            
            try {
                console.log('Starting sync with database...');
                console.log('Current local stars:', userStars);
                console.log('Current user ID:', currentUser.id);
                
                // First, get latest user data from database
                console.log('Fetching latest data from database...');
                const latestUser = await apiCall(`users/${currentUser.id}`);
                
                if (latestUser) {
                    console.log('Database user data:', {
                        id: latestUser.id,
                        firstName: latestUser.firstName,
                        lastName: latestUser.lastName,
                        stars: latestUser.stars,
                        completedModules: latestUser.completedModules,
                        gamesPlayed: latestUser.gamesPlayed
                    });
                    
                    // Update local variables with database values
                    const oldStars = userStars;
                    userStars = latestUser.stars;
                    currentUser.stars = latestUser.stars;
                    currentUser.completedModules = latestUser.completedModules;
                    currentUser.completedQuizzes = latestUser.completedQuizzes;
                    currentUser.gamesPlayed = latestUser.gamesPlayed;
                    currentUser.recentActivity = latestUser.recentActivity;
                    
                    // Save updated data to localStorage
                    saveUserData();
                    
                    console.log('Sync completed:', {
                        user: `${currentUser.firstName} ${currentUser.lastName}`,
                        oldStars: oldStars,
                        newStars: userStars,
                        completedModules: currentUser.completedModules,
                        gamesPlayed: currentUser.gamesPlayed
                    });
                    
                    // Force update the display immediately after sync
                    if (currentUser.role === 'student') {
                        updateStarsDisplay();
                        updateGameAvailability();
                    }
                } else {
                    console.log('No user data received from database');
                }
            } catch (error) {
                console.error('Failed to sync with database:', error);
                // Fallback to localStorage data
                const localStars = parseInt(localStorage.getItem('userStars')) || 0;
                console.log('Falling back to localStorage stars:', localStars);
                userStars = localStars;
            }
        }
        
        // Save current state to database
        async function saveToDatabase() {
            if (!currentUser) {
                console.log('No current user, cannot save to database');
                return;
            }
            
            try {
                // Ensure we have the correct data format for the User model
                const dataToSave = {
                    id: currentUser.id,
                    email: currentUser.email,
                    password: currentUser.password, // Password from login response
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    grade: currentUser.grade,
                    role: currentUser.role,
                    stars: userStars,
                    completedModules: currentUser.completedModules || '[]',
                    completedQuizzes: currentUser.completedQuizzes || '[]',
                    gamesPlayed: currentUser.gamesPlayed || 0,
                    recentActivity: currentUser.recentActivity || '[]',
                    // Don't send createdAt and lastLogin as they might cause validation issues
                    // The API will handle these automatically
                    isActive: currentUser.isActive !== undefined ? currentUser.isActive : true
                };
                
                console.log('Saving to database:', {
                    userId: currentUser.id,
                    stars: userStars,
                    data: dataToSave
                });
                
                const result = await apiCall(`users/${currentUser.id}`, 'PUT', dataToSave);
                console.log('Successfully saved to database:', result);
            } catch (error) {
                console.error('Failed to save to database:', error);
                console.error('Error details:', {
                    message: error.message,
                    currentUser: currentUser,
                    userStars: userStars
                });
                throw error; // Re-throw so sync knows it failed
            }
        }
        
        // Save user data to localStorage
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('userStars', userStars.toString());
                localStorage.setItem('userGrade', userGrade || '');
            }
        }
        
        // Clear saved user data
        function clearSavedUserData() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userStars');
            localStorage.removeItem('userGrade');
        }
        
        // Periodic sync with database (every 2 minutes)
        function startPeriodicSync() {
            if (currentUser) {
                setInterval(async () => {
                    showSyncIndicator();
                    await syncWithDatabase();
                    updateStarsDisplay();
                    updateGameAvailability();
                    hideSyncIndicator();
                }, 120000); // Sync every 2 minutes
            }
        }
        
        // Show sync indicator
        function showSyncIndicator() {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.style.display = 'inline';
            }
        }
        
        // Hide sync indicator
        function hideSyncIndicator() {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.style.display = 'none';
            }
        }
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api/';
        
        // API Helper Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                console.log('API Call:', `${API_BASE_URL}${endpoint}`, { method, data });
                console.log('Data being sent:', JSON.stringify(data, null, 2));
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check if response has content
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                if (!responseText || responseText.trim() === '') {
                    console.log('Empty response received');
                    return null;
                }
                
                const result = JSON.parse(responseText);
                console.log('API Success:', result);
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // Test content data
        const testContent = {
            module1: {
                title: "Grade 3 Math Test Prep",
                questions: [
                    {
                        question: "What is 7 × 8?",
                        options: ["56", "54", "58", "60"],
                        correct: 0,
                        explanation: "7 × 8 = 56. You can think of this as 7 groups of 8, or 8 + 8 + 8 + 8 + 8 + 8 + 8 = 56."
                    },
                    {
                        question: "Sarah has 24 stickers. She wants to put them equally into 6 bags. How many stickers will be in each bag?",
                        options: ["3", "4", "5", "6"],
                        correct: 1,
                        explanation: "24 ÷ 6 = 4. This is a division problem where we're sharing 24 stickers equally among 6 bags."
                    },
                    {
                        question: "Which fraction is equivalent to 1/2?",
                        options: ["2/4", "1/3", "3/4", "2/3"],
                        correct: 0,
                        explanation: "1/2 = 2/4 because both represent the same amount. 1/2 means 1 out of 2 parts, and 2/4 means 2 out of 4 parts."
                    }
                ]
            },
            module2: {
                title: "Grade 4 Math Practice",
                questions: [
                    {
                        question: "What is 3/4 + 1/4?",
                        options: ["4/8", "1", "4/4", "2/4"],
                        correct: 1,
                        explanation: "3/4 + 1/4 = 4/4 = 1. When adding fractions with the same denominator, add the numerators."
                    },
                    {
                        question: "Convert 0.5 to a fraction.",
                        options: ["1/2", "5/10", "1/5", "5/1"],
                        correct: 0,
                        explanation: "0.5 = 5/10 = 1/2. The decimal 0.5 represents half of a whole."
                    }
                ]
            },
            module3: {
                title: "Grade 7 Writing Practice",
                prompt: "Write an argumentative essay about whether students should have homework on weekends. Support your position with at least two reasons and evidence.",
                rubric: {
                    thesis: "Clear position statement (10 points)",
                    evidence: "Two or more supporting reasons with evidence (20 points)",
                    organization: "Logical structure with introduction, body, conclusion (15 points)",
                    language: "Appropriate word choice and sentence variety (10 points)",
                    conventions: "Correct grammar, spelling, and punctuation (5 points)"
                }
            },
            module4: {
                title: "Grade 8 Algebra Prep",
                questions: [
                    {
                        question: "Solve for x: 2x + 5 = 13",
                        options: ["x = 4", "x = 6", "x = 8", "x = 9"],
                        correct: 0,
                        explanation: "2x + 5 = 13, so 2x = 13 - 5 = 8, therefore x = 8 ÷ 2 = 4"
                    },
                    {
                        question: "What is the slope of the line y = 3x + 2?",
                        options: ["2", "3", "5", "6"],
                        correct: 1,
                        explanation: "In the equation y = mx + b, m is the slope. So the slope of y = 3x + 2 is 3."
                    }
                ]
            },
            module5: {
                title: "Test-Taking Strategies",
                strategies: [
                    "Read all directions carefully before starting",
                    "Answer easy questions first, then return to difficult ones",
                    "Use process of elimination for multiple choice questions",
                    "Show all work for math problems, even if not required",
                    "Manage time effectively - don't spend too long on one question",
                    "Review answers if time permits",
                    "Stay calm and focused throughout the test"
                ]
            }
        };
        
        // Practice test questions
        const practiceQuestions = {
            math: [
                {
                    question: "If 3x - 7 = 20, what is the value of x?",
                    options: ["7", "9", "11", "13"],
                    correct: 1,
                    explanation: "Add 7 to both sides: 3x = 27. Then divide by 3: x = 9"
                },
                {
                    question: "What is the area of a rectangle with length 8 cm and width 5 cm?",
                    options: ["13 cm²", "26 cm²", "40 cm²", "80 cm²"],
                    correct: 2,
                    explanation: "Area = length × width = 8 × 5 = 40 cm²"
                },
                {
                    question: "What is 25% of 80?",
                    options: ["15", "20", "25", "30"],
                    correct: 1,
                    explanation: "25% = 0.25, so 0.25 × 80 = 20"
                },
                {
                    question: "If a train travels 240 miles in 4 hours, what is its average speed?",
                    options: ["50 mph", "60 mph", "70 mph", "80 mph"],
                    correct: 1,
                    explanation: "Speed = distance ÷ time = 240 ÷ 4 = 60 mph"
                },
                {
                    question: "What is the value of 2³ + 3²?",
                    options: ["13", "15", "17", "19"],
                    correct: 2,
                    explanation: "2³ = 8 and 3² = 9, so 8 + 9 = 17"
                },
                {
                    question: "If the ratio of boys to girls in a class is 3:5 and there are 15 boys, how many girls are there?",
                    options: ["20", "25", "30", "35"],
                    correct: 1,
                    explanation: "3:5 = 15:x, so x = (5 × 15) ÷ 3 = 25"
                },
                {
                    question: "What is the perimeter of a square with side length 6 cm?",
                    options: ["12 cm", "18 cm", "24 cm", "36 cm"],
                    correct: 2,
                    explanation: "Perimeter = 4 × side = 4 × 6 = 24 cm"
                },
                {
                    question: "Simplify: 5(x + 3) - 2x",
                    options: ["3x + 15", "3x + 3", "7x + 15", "7x + 3"],
                    correct: 0,
                    explanation: "5(x + 3) - 2x = 5x + 15 - 2x = 3x + 15"
                },
                {
                    question: "What is the median of the data set: 12, 8, 15, 9, 11?",
                    options: ["9", "10", "11", "12"],
                    correct: 2,
                    explanation: "First sort: 8, 9, 11, 12, 15. The middle value is 11"
                },
                {
                    question: "If y = 2x + 5 and x = 3, what is y?",
                    options: ["8", "9", "10", "11"],
                    correct: 3,
                    explanation: "y = 2(3) + 5 = 6 + 5 = 11"
                }
            ],
            reading: [
                {
                    passage: "The Amazon rainforest is the world's largest tropical rainforest. It covers 5.5 million square kilometers and is home to millions of species of plants and animals. Scientists believe that many species in the Amazon have not yet been discovered. The rainforest also plays a crucial role in regulating Earth's climate by absorbing carbon dioxide from the atmosphere.",
                    question: "According to the passage, why is the Amazon rainforest important for Earth's climate?",
                    options: [
                        "It produces oxygen for animals",
                        "It absorbs carbon dioxide from the atmosphere",
                        "It provides homes for millions of species",
                        "It covers 5.5 million square kilometers"
                    ],
                    correct: 1,
                    explanation: "The passage states that the rainforest 'plays a crucial role in regulating Earth's climate by absorbing carbon dioxide from the atmosphere.'"
                },
                {
                    passage: "Thomas Edison is often credited with inventing the light bulb, but this is not entirely accurate. Several inventors had created forms of electric light before Edison. However, Edison's major achievement was developing a practical, long-lasting light bulb that could be manufactured affordably for widespread use.",
                    question: "What was Edison's main contribution to the light bulb?",
                    options: [
                        "He invented the first electric light",
                        "He made a practical, affordable version",
                        "He discovered electricity",
                        "He invented the first battery"
                    ],
                    correct: 1,
                    explanation: "The passage states that Edison's 'major achievement was developing a practical, long-lasting light bulb that could be manufactured affordably.'"
                },
                {
                    passage: "Photosynthesis is the process by which plants use sunlight, water, and carbon dioxide to create oxygen and energy in the form of sugar. This process is essential for life on Earth because it provides oxygen for animals to breathe and serves as the foundation of most food chains.",
                    question: "What do plants produce during photosynthesis?",
                    options: [
                        "Water and carbon dioxide",
                        "Oxygen and sugar",
                        "Sunlight and water",
                        "Carbon dioxide and sugar"
                    ],
                    correct: 1,
                    explanation: "The passage clearly states that plants 'create oxygen and energy in the form of sugar' during photosynthesis."
                },
                {
                    passage: "The Great Wall of China is one of the most impressive architectural achievements in history. Built over many centuries by different dynasties, the wall stretches over 13,000 miles. Contrary to popular belief, it is not visible from space with the naked eye.",
                    question: "What does the passage say about viewing the Great Wall from space?",
                    options: [
                        "It is clearly visible from space",
                        "It can only be seen with a telescope",
                        "It is not visible with the naked eye",
                        "The passage doesn't mention this"
                    ],
                    correct: 2,
                    explanation: "The passage states: 'Contrary to popular belief, it is not visible from space with the naked eye.'"
                },
                {
                    passage: "Hibernation is a state of inactivity and metabolic depression in animals, characterized by lower body temperature, slower breathing, and lower metabolic rate. It allows animals to conserve energy during winter when food is scarce.",
                    question: "According to the passage, what is the main purpose of hibernation?",
                    options: [
                        "To stay warm during winter",
                        "To sleep for long periods",
                        "To conserve energy when food is scarce",
                        "To lower body temperature"
                    ],
                    correct: 2,
                    explanation: "The passage states that hibernation 'allows animals to conserve energy during winter when food is scarce.'"
                },
                {
                    passage: "Marie Curie was a pioneering scientist who conducted groundbreaking research on radioactivity. She was the first woman to win a Nobel Prize and remains the only person to win Nobel Prizes in two different sciences: Physics and Chemistry.",
                    question: "What makes Marie Curie unique among Nobel Prize winners?",
                    options: [
                        "She was the first woman to win",
                        "She won prizes in two different sciences",
                        "She studied radioactivity",
                        "She was a pioneering scientist"
                    ],
                    correct: 1,
                    explanation: "The passage states she 'remains the only person to win Nobel Prizes in two different sciences.'"
                },
                {
                    passage: "Earthquakes occur when tectonic plates in the Earth's crust suddenly shift or break. The point where the earthquake starts underground is called the hypocenter, while the point directly above it on the surface is called the epicenter.",
                    question: "What is the epicenter of an earthquake?",
                    options: [
                        "Where the earthquake starts underground",
                        "The point on the surface above where it starts",
                        "Where tectonic plates meet",
                        "The strongest point of the earthquake"
                    ],
                    correct: 1,
                    explanation: "The passage defines the epicenter as 'the point directly above it on the surface.'"
                },
                {
                    passage: "Bees play a vital role in agriculture through pollination. As bees collect nectar from flowers, pollen sticks to their bodies and is transferred to other flowers, allowing plants to reproduce. Without bees, many crops would fail to produce fruits and vegetables.",
                    question: "How do bees help plants reproduce?",
                    options: [
                        "By collecting nectar",
                        "By transferring pollen between flowers",
                        "By eating fruits and vegetables",
                        "By making honey"
                    ],
                    correct: 1,
                    explanation: "The passage explains that 'pollen sticks to their bodies and is transferred to other flowers, allowing plants to reproduce.'"
                },
                {
                    passage: "The water cycle is the continuous movement of water on, above, and below the surface of Earth. Water evaporates from oceans and lakes, forms clouds, falls as precipitation, and eventually returns to bodies of water, completing the cycle.",
                    question: "What happens to water after it evaporates in the water cycle?",
                    options: [
                        "It falls as precipitation",
                        "It forms clouds",
                        "It returns to oceans",
                        "It freezes"
                    ],
                    correct: 1,
                    explanation: "The passage describes the sequence: water evaporates, 'forms clouds,' then 'falls as precipitation.'"
                },
                {
                    passage: "Shakespeare wrote 37 plays during his lifetime, including comedies, tragedies, and histories. His works have been translated into every major language and are performed more often than those of any other playwright.",
                    question: "What can be inferred about Shakespeare's influence?",
                    options: [
                        "He only wrote tragedies",
                        "His works are still very popular today",
                        "He wrote in many languages",
                        "He wrote 37 books"
                    ],
                    correct: 1,
                    explanation: "The passage indicates his works 'are performed more often than those of any other playwright,' showing continued popularity."
                }
            ],
            science: [
                {
                    question: "What is the chemical symbol for water?",
                    options: ["H₂O", "CO₂", "O₂", "H₂"],
                    correct: 0,
                    explanation: "Water is composed of two hydrogen atoms and one oxygen atom, written as H₂O."
                },
                {
                    question: "Which planet is known as the Red Planet?",
                    options: ["Venus", "Mars", "Jupiter", "Saturn"],
                    correct: 1,
                    explanation: "Mars is called the Red Planet due to iron oxide (rust) on its surface."
                },
                {
                    question: "What is the powerhouse of the cell?",
                    options: ["Nucleus", "Ribosome", "Mitochondria", "Chloroplast"],
                    correct: 2,
                    explanation: "Mitochondria produce energy (ATP) for the cell, earning them the nickname 'powerhouse of the cell.'"
                },
                {
                    question: "What type of energy does a moving car have?",
                    options: ["Potential energy", "Kinetic energy", "Chemical energy", "Nuclear energy"],
                    correct: 1,
                    explanation: "Kinetic energy is the energy of motion, which a moving car possesses."
                },
                {
                    question: "What is the process by which plants make their own food?",
                    options: ["Respiration", "Digestion", "Photosynthesis", "Fermentation"],
                    correct: 2,
                    explanation: "Photosynthesis is the process where plants use sunlight to convert carbon dioxide and water into glucose and oxygen."
                },
                {
                    question: "Which of the following is NOT a state of matter?",
                    options: ["Solid", "Liquid", "Gas", "Energy"],
                    correct: 3,
                    explanation: "Energy is not a state of matter. The three common states are solid, liquid, and gas."
                },
                {
                    question: "What force pulls objects toward the center of the Earth?",
                    options: ["Friction", "Magnetism", "Gravity", "Tension"],
                    correct: 2,
                    explanation: "Gravity is the force that attracts objects toward each other, including toward the center of the Earth."
                },
                {
                    question: "Which organ in the human body pumps blood?",
                    options: ["Liver", "Lungs", "Heart", "Kidney"],
                    correct: 2,
                    explanation: "The heart pumps blood throughout the body, delivering oxygen and nutrients."
                },
                {
                    question: "What is the center of an atom called?",
                    options: ["Electron", "Proton", "Neutron", "Nucleus"],
                    correct: 3,
                    explanation: "The nucleus is the center of an atom and contains protons and neutrons."
                },
                {
                    question: "Which of these is a renewable energy source?",
                    options: ["Coal", "Natural gas", "Solar power", "Oil"],
                    correct: 2,
                    explanation: "Solar power is renewable because sunlight is constantly available, unlike fossil fuels which are finite."
                }
            ],
            english: [
                {
                    question: "Which sentence uses correct subject-verb agreement?",
                    options: [
                        "The group of students are going on a field trip.",
                        "The group of students is going on a field trip.",
                        "The group of students were going on a field trip.",
                        "The group of students have going on a field trip."
                    ],
                    correct: 1,
                    explanation: "The subject is 'group' (singular), so it requires the singular verb 'is.' The phrase 'of students' is just a prepositional phrase modifying 'group.'"
                },
                {
                    question: "Identify the sentence with the correct use of a comma.",
                    options: [
                        "After the game we went out for pizza.",
                        "After the game, we went out for pizza.",
                        "After, the game we went out for pizza.",
                        "After the game we went, out for pizza."
                    ],
                    correct: 1,
                    explanation: "A comma is needed after an introductory phrase ('After the game') to separate it from the main clause."
                },
                {
                    question: "Which word is a synonym for 'diligent'?",
                    options: ["Lazy", "Hardworking", "Careless", "Slow"],
                    correct: 1,
                    explanation: "'Diligent' means showing care and effort in one's work, which is synonymous with 'hardworking.'"
                },
                {
                    question: "What is the past tense of the verb 'to write'?",
                    options: ["Writed", "Wrote", "Written", "Writing"],
                    correct: 1,
                    explanation: "'Wrote' is the simple past tense of the irregular verb 'to write.' 'Written' is the past participle."
                },
                {
                    question: "Which sentence uses 'their' correctly?",
                    options: [
                        "Their going to the store later.",
                        "The students left there backpacks in the classroom.",
                        "The team celebrated their victory.",
                        "Put the books over their."
                    ],
                    correct: 2,
                    explanation: "'Their' is a possessive pronoun. The team possessed the victory. 'They're' = they are, 'there' = location."
                },
                {
                    question: "Identify the sentence fragment.",
                    options: [
                        "Running through the park on a sunny day.",
                        "She ran through the park.",
                        "The children played in the park.",
                        "We enjoyed our time at the park."
                    ],
                    correct: 0,
                    explanation: "A sentence fragment lacks a complete subject-verb structure. 'Running through the park on a sunny day' has no subject performing the action."
                },
                {
                    question: "Which is the correct plural form of 'child'?",
                    options: ["Childs", "Childes", "Children", "Childrens"],
                    correct: 2,
                    explanation: "'Children' is the correct irregular plural form of 'child.' It doesn't follow the standard 's' or 'es' rule."
                },
                {
                    question: "What type of figurative language is used: 'The classroom was a zoo'?",
                    options: ["Simile", "Metaphor", "Personification", "Hyperbole"],
                    correct: 1,
                    explanation: "This is a metaphor because it directly compares the classroom to a zoo without using 'like' or 'as.' A simile would say 'The classroom was like a zoo.'"
                },
                {
                    question: "Which sentence is in the active voice?",
                    options: [
                        "The cake was eaten by the children.",
                        "The book was written by the author.",
                        "The teacher graded the tests.",
                        "The ball was thrown by John."
                    ],
                    correct: 2,
                    explanation: "In active voice, the subject performs the action. 'The teacher graded the tests' has the subject (teacher) performing the action (grading)."
                },
                {
                    question: "What is the correct way to write this sentence? 'I need to buy eggs milk and bread'",
                    options: [
                        "I need to buy eggs milk and bread.",
                        "I need to buy eggs, milk and bread.",
                        "I need to buy eggs, milk, and bread.",
                        "I need to buy, eggs milk and bread."
                    ],
                    correct: 2,
                    explanation: "When listing three or more items, use commas to separate them. The comma before 'and' (Oxford comma) is preferred in formal writing."
                }
            ]
        };

        // Role selection
        function selectRole(role) {
            // Remove active class from all role buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected role
            event.target.classList.add('active');
            
            // Hide all forms
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Show selected form
            document.getElementById(role + 'Form').classList.add('active');
        }
        
        // Show registration form
        function showRegistration() {
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById('studentRegistration').classList.add('active');
        }
        
        // Show login form
        function showLogin() {
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById('studentForm').classList.add('active');
        }
        
        // Student registration
        async function register(role, event) {
            event.preventDefault();
            
            if (role === 'student') {
                const name = document.getElementById('regStudentName').value;
                const id = document.getElementById('regStudentId').value;
                const grade = document.getElementById('regStudentGrade').value;
                const password = document.getElementById('regStudentPassword').value;
                const confirmPassword = document.getElementById('regStudentConfirmPassword').value;
                
                if (!name || !id || !grade || !password || !confirmPassword) {
                    alert('Please fill in all fields');
            return;
          }

                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                try {
                    // Create user object
                    const [firstName, ...lastNameParts] = name.split(' ');
                    const lastName = lastNameParts.join(' ') || '';
                    
                    const newUser = {
                        firstName: firstName,
                        lastName: lastName,
                        email: `${id}@student.qualityeducation.com`,
                        password: password,
                        role: 'student',
                        grade: `Grade ${grade}`,
                        stars: 50,
                        completedModules: '[]',
                        completedQuizzes: '[]',
                        gamesPlayed: 0,
                        recentActivity: '[]',
                        isActive: true
                    };
                    
                    console.log('Attempting to register user:', newUser);
                    
                    // Register user via API
                    const result = await apiCall('users', 'POST', newUser);
                    
                    console.log('Registration result:', result);
                    
                    alert('Registration successful! You can now login.');
                    showLogin();
                } catch (error) {
                    console.error('Registration error:', error);
                    alert(`Registration failed: ${error.message}. Please check the console for more details.`);
                }
            }
        }

        // Theme toggle function
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
                document.getElementById('themeText').textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-moon';
                document.getElementById('themeText').textContent = 'Dark Mode';
            }
        }
        
        // Initialize theme on page load
        function initializeTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
                document.getElementById('themeText').textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-moon';
                document.getElementById('themeText').textContent = 'Dark Mode';
            }
        }
        
        // Grade-based module access
        function getModuleAccess(grade) {
            const gradeNum = parseInt(grade);
            const access = {
                module1: gradeNum >= 3, // Grade 3 Math
                module2: gradeNum >= 4, // Grade 4 Math
                module3: gradeNum >= 7, // Grade 7 Writing
                module4: gradeNum >= 8, // Grade 8 Algebra
                module5: gradeNum >= 3  // Test strategies (all grades)
            };
            return access;
        }
        
        // Update module visibility based on grade
        function updateModuleAccess() {
            if (!userGrade) return;
            
            const access = getModuleAccess(userGrade);
            
            Object.keys(access).forEach(moduleId => {
                const module = document.getElementById(moduleId);
                if (module) {
                    if (access[moduleId]) {
                        module.style.display = 'block';
                        module.classList.remove('locked');
        } else {
                        module.style.display = 'none';
                        module.classList.add('locked');
                    }
                }
            });
        }
        
        // New universal login (infers role from API response)
        async function loginAuto(event) {
            event.preventDefault();
            
            const userId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!userId || !password) {
                alert('Please enter both ID and password');
            return;
          }
          
            try {
                let email = userId;
                
                // Check if it's a known demo user and convert to proper email format
                const demoUsers = {
                    'harry.potter': 'harry.potter@hogwarts.edu',
                    'hermione.granger': 'hermione.granger@hogwarts.edu',
                    'ron.weasley': 'ron.weasley@hogwarts.edu',
                    'luna.lovegood': 'luna.lovegood@hogwarts.edu',
                    'draco.malfoy': 'draco.malfoy@hogwarts.edu',
                    'albus.dumbledore': 'albus.dumbledore@hogwarts.edu',
                    'minerva.mcgonagall': 'minerva.mcgonagall@hogwarts.edu',
                    'severus.snape': 'severus.snape@hogwarts.edu',
                    'admin': 'admin@qualityeducation.com'
                };
                
                // Check if userId is already a full email address
                if (userId.includes('@')) {
                    email = userId; // Use as-is if it's already an email
                } else if (demoUsers[userId]) {
                    email = demoUsers[userId]; // Use demo user mapping
                } else {
                    // Fallback: try common domains in order
                    const candidates = [
                        `${userId}@student.qualityeducation.com`,
                        `${userId}@teacher.qualityeducation.com`,
                        `${userId}@qualityeducation.com`
                    ];
                    email = candidates[0];
                }
                
                // Login via API
                console.log('Login attempt:', { email, password, userId });
                const user = await apiCall('users/login', 'POST', {
                    email: email,
                    password: password
                });
                console.log('Login response:', user);
                
                if (user && user.id) {
                    console.log('Login successful for user:', {
                        id: user.id,
                        name: `${user.firstName} ${user.lastName}`,
                        stars: user.stars,
                        role: user.role
                    });
                    
                    currentUser = {
                        id: user.id,
                        role: user.role,
                        name: `${user.firstName} ${user.lastName}`,
                        grade: user.grade,
                        stars: user.stars,
                        email: user.email,
                        firstName: user.firstName,
                        lastName: user.lastName,
                        password: user.password
                    };
                    
                    userGrade = user.grade;
                    userStars = user.stars; // Use actual star count from database
                    
                    console.log('Set userStars to:', userStars);
                    console.log('Current userStars value after login:', userStars);
                    console.log('Current user object after login:', currentUser);
                    
                    // Update lastLogin in database
                    try {
                        await apiCall(`users/${user.id}`, 'PUT', {
                            ...user,
                            lastLogin: new Date().toISOString()
                        });
                    } catch (updateError) {
                        console.warn('Failed to update lastLogin:', updateError);
                    }
                    
                    // Save user data to localStorage
                    saveUserData();
                    
                    // Start periodic sync with database
                    startPeriodicSync();
                    
                    if (user.role === 'student') {
                        showStudentDashboard();
                    } else if (user.role === 'teacher') {
                        showTeacherDashboard();
                    } else if (user.role === 'admin') {
                        showAdminDashboard();
                    }
                } else {
                    console.log('Login failed - no user data received');
                    alert('Invalid credentials. Please try again.');
                }
            } catch (error) {
                alert('Invalid credentials. Please try again.');
                console.error('Login error:', error);
            }
        }

        // Show admin dashboard
        function showAdminDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminDashboard').classList.add('active');
            
            // Show universal menu
            document.getElementById('universalMenu').style.display = 'block';
            
            // Update admin name
            const adminName = (currentUser.firstName || 'Admin') + ' ' + (currentUser.lastName || 'User');
            document.getElementById('adminName').textContent = adminName;
            
            // Load initial data
            loadAllUsers();
            loadAnalytics();
        }
        
        // Track sort state
        let roleSortDirection = 'none'; // 'none', 'asc', 'desc'
        let allUsersCache = []; // Cache all users to avoid re-fetching
        
        // Load all users for admin dashboard
        async function loadAllUsers() {
            try {
                const users = await apiCall('users', 'GET');
                const tbody = document.getElementById('usersTableBody');
                const roleFilter = document.getElementById('roleFilter');
                
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
                    return;
                }
                
                // Cache users for sorting
                allUsersCache = users;
                
                // Filter users by selected role
                let filteredUsers = users;
                if (roleFilter && roleFilter.value !== 'all') {
                    filteredUsers = users.filter(user => user.role === roleFilter.value);
                }
                
                // Sort users by role for better organization
                filteredUsers.sort((a, b) => {
                    const roleOrder = { 'admin': 1, 'teacher': 2, 'student': 3 };
                    return (roleOrder[a.role] || 99) - (roleOrder[b.role] || 99);
                });
                
                displayUsers(filteredUsers);
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load users</td></tr>';
            }
        }
        
        // Display users in the table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td><span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'teacher' ? 'info' : 'success'}">${user.role}</span></td>
                    <td>${user.grade || 'N/A'}</td>
                    <td><i class="fas fa-star text-warning"></i> ${user.stars || 0}</td>
                    <td><span class="badge bg-${user.isActive ? 'success' : 'secondary'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
                </tr>
            `).join('');
        }
        
        // Sort users by role
        window.sortByRole = function() {
            if (!allUsersCache || allUsersCache.length === 0) return;
            
            // Toggle sort direction
            if (roleSortDirection === 'none' || roleSortDirection === 'desc') {
                roleSortDirection = 'asc';
            } else {
                roleSortDirection = 'desc';
            }
            
            // Update sort icon
            const sortIcon = document.getElementById('roleSortIcon');
            if (sortIcon) {
                sortIcon.className = roleSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            // Get current filter
            const roleFilter = document.getElementById('roleFilter');
            let filteredUsers = allUsersCache;
            
            if (roleFilter && roleFilter.value !== 'all') {
                filteredUsers = allUsersCache.filter(user => user.role === roleFilter.value);
            }
            
            // Sort users
            filteredUsers.sort((a, b) => {
                const roleOrder = { 'admin': 1, 'teacher': 2, 'student': 3 };
                const orderA = roleOrder[a.role] || 99;
                const orderB = roleOrder[b.role] || 99;
                
                if (roleSortDirection === 'asc') {
                    return orderA - orderB;
                } else {
                    return orderB - orderA;
                }
            });
            
            displayUsers(filteredUsers);
        }
        
        // Load analytics data
        async function loadAnalytics() {
            try {
                // Get all users first to calculate analytics
                const users = await apiCall('users', 'GET');
                
                if (!users || users.length === 0) {
                    // No users found
                    document.getElementById('totalUsers').textContent = '0';
                    document.getElementById('totalStudents').textContent = '0';
                    document.getElementById('totalTeachers').textContent = '0';
                    document.getElementById('totalStars').textContent = '0';
                    createRoleChart({});
                    createGradeChart({});
                    return;
                }
                
                // Calculate analytics from user data
                const analytics = {
                    totalUsers: users.length,
                    students: users.filter(u => u.role === 'student').length,
                    teachers: users.filter(u => u.role === 'teacher').length,
                    admins: users.filter(u => u.role === 'admin').length,
                    totalStars: users.reduce((sum, u) => sum + (u.stars || 0), 0),
                    roleDistribution: {
                        'Students': users.filter(u => u.role === 'student').length,
                        'Teachers': users.filter(u => u.role === 'teacher').length,
                        'Admins': users.filter(u => u.role === 'admin').length
                    },
                    gradeDistribution: {}
                };
                
                // Calculate grade distribution for students
                const students = users.filter(u => u.role === 'student');
                students.forEach(student => {
                    const grade = student.grade || 'Unknown';
                    analytics.gradeDistribution[grade] = (analytics.gradeDistribution[grade] || 0) + 1;
                });
                
                // Update stats cards
                document.getElementById('totalUsers').textContent = analytics.totalUsers;
                document.getElementById('totalStudents').textContent = analytics.students;
                document.getElementById('totalTeachers').textContent = analytics.teachers;
                document.getElementById('totalStars').textContent = analytics.totalStars;
                
                // Create charts
                createRoleChart(analytics.roleDistribution);
                createGradeChart(analytics.gradeDistribution);
            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Show error in stats cards
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('totalStudents').textContent = 'Error';
                document.getElementById('totalTeachers').textContent = 'Error';
                document.getElementById('totalStars').textContent = 'Error';
            }
        }
        
        // Create role distribution chart
        function createRoleChart(roleData) {
            const ctx = document.getElementById('roleChart');
            if (!ctx) return;
            
            // Clear any existing chart
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            const labels = Object.keys(roleData);
            const data = Object.values(roleData);
            
            if (labels.length === 0 || data.every(val => val === 0)) {
                // Show "No data" message
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const ctx2d = ctx.getContext('2d');
                ctx2d.font = '16px Arial';
                ctx2d.fillStyle = '#666';
                ctx2d.textAlign = 'center';
                ctx2d.fillText('No data available', ctx.width / 2, ctx.height / 2);
                return;
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#dc3545', '#0dcaf0', '#198754'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Create grade distribution chart
        function createGradeChart(gradeData) {
            const ctx = document.getElementById('gradeChart');
            if (!ctx) return;
            
            // Clear any existing chart
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            const labels = Object.keys(gradeData);
            const data = Object.values(gradeData);
            
            if (labels.length === 0 || data.every(val => val === 0)) {
                // Show "No data" message
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const ctx2d = ctx.getContext('2d');
                ctx2d.font = '16px Arial';
                ctx2d.fillStyle = '#666';
                ctx2d.textAlign = 'center';
                ctx2d.fillText('No student data available', ctx.width / 2, ctx.height / 2);
                return;
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Students',
                        data: data,
                        backgroundColor: '#198754',
                        borderColor: '#0f5132',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        
        // Show teacher dashboard
        function showTeacherDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('teacherDashboard').classList.add('active');
            
            // Show universal menu
            document.getElementById('universalMenu').style.display = 'block';
            
            // Update teacher name
            document.getElementById('teacherName').textContent = currentUser.name;
            
            // Load teacher's classrooms
            loadTeacherClassrooms();
            
            // Load analytics data when teacher dashboard is shown
            loadTeacherAnalyticsData();
        }
        
        // Teacher Analytics Functions
        
        async function loadTeacherAnalyticsData() {
            await loadTeacherStudents();
            await loadTeacherClasses();
            setupTeacherGradeForm();
        }
        
        async function loadTeacherStudents() {
            try {
                // Use static student data
                const students = [
                    { id: 10, firstName: "Harry", lastName: "Potter", grade: "Grade 7" },
                    { id: 11, firstName: "Hermione", lastName: "Granger", grade: "Grade 7" },
                    { id: 12, firstName: "Ron", lastName: "Weasley", grade: "Grade 7" },
                    { id: 13, firstName: "Neville", lastName: "Longbottom", grade: "Grade 7" },
                    { id: 14, firstName: "Luna", lastName: "Lovegood", grade: "Grade 6" },
                    { id: 15, firstName: "Ginny", lastName: "Weasley", grade: "Grade 6" },
                    { id: 16, firstName: "Draco", lastName: "Malfoy", grade: "Grade 7" },
                    { id: 17, firstName: "Cedric", lastName: "Diggory", grade: "Grade 7" }
                ];
                
                const teacherStudentSelect = document.getElementById('teacherStudentSelect');
                const teacherGradeStudentSelect = document.getElementById('teacherGradeStudent');
                
                // Clear existing options
                if (teacherStudentSelect) {
                    teacherStudentSelect.innerHTML = '<option value="">Choose a student...</option>';
                }
                if (teacherGradeStudentSelect) {
                    teacherGradeStudentSelect.innerHTML = '<option value="">Select student...</option>';
                }
                
                students.forEach(student => {
                    const option1 = new Option(`${student.firstName} ${student.lastName} (${student.grade})`, student.id);
                    const option2 = new Option(`${student.firstName} ${student.lastName} (${student.grade})`, student.id);
                    if (teacherStudentSelect) teacherStudentSelect.add(option1);
                    if (teacherGradeStudentSelect) teacherGradeStudentSelect.add(option2);
                });
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        
        async function loadTeacherClasses() {
            try {
                // Use static class data
                const classes = [
                    { name: "Grade 7 Mathematics", subject: "Mathematics" },
                    { name: "Grade 7 Science", subject: "Science" },
                    { name: "Grade 7 English", subject: "English" },
                    { name: "Grade 6 Mathematics", subject: "Mathematics" },
                    { name: "Grade 6 Science", subject: "Science" }
                ];
                
                const teacherClassSelect = document.getElementById('teacherClassSelect');
                
                // Clear existing options
                if (teacherClassSelect) {
                    teacherClassSelect.innerHTML = '<option value="">Choose a class...</option>';
                }
                
                classes.forEach(cls => {
                    const option = new Option(`${cls.name} - ${cls.subject}`, cls.name);
                    if (teacherClassSelect) teacherClassSelect.add(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }
        
        async function loadStudentAnalyticsFromTeacher() {
            const studentId = document.getElementById('teacherStudentSelect').value;
            if (!studentId) {
                alert('Please select a student');
                return;
            }
            
            const loadingDiv = document.getElementById('teacherStudentLoading');
            const contentDiv = document.getElementById('teacherStudentAnalyticsContent');
            
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            
            // Use static analytics data for all students
            setTimeout(() => {
                const studentAnalytics = {
                    10: { // Harry Potter
                        studentName: "Harry Potter",
                        overallAverage: 88.5,
                        overallLetterGrade: "B+",
                        completedAssignments: 5,
                        totalAssignments: 5,
                        lateSubmissions: 0,
                        subjectPerformance: [
                            { subject: "Mathematics", average: 85.0, assignments: 1 },
                            { subject: "Science", average: 92.0, assignments: 1 },
                            { subject: "English", average: 88.0, assignments: 1 },
                            { subject: "History", average: 89.0, assignments: 1 },
                            { subject: "General", average: 90.0, assignments: 1 }
                        ],
                        assignmentTypes: [
                            { type: "Quiz", average: 85.0, count: 1 },
                            { type: "Test", average: 92.0, count: 1 },
                            { type: "Project", average: 88.0, count: 1 },
                            { type: "Homework", average: 89.0, count: 1 },
                            { type: "Participation", average: 90.0, count: 1 }
                        ],
                        recentAssignments: [
                            { name: "Class Participation", subject: "General", score: 90, maxScore: 100, date: "2025-02-05", type: "Participation" },
                            { name: "History Assignment", subject: "History", score: 89, maxScore: 100, date: "2025-01-30", type: "Homework" },
                            { name: "English Essay", subject: "English", score: 88, maxScore: 100, date: "2025-01-25", type: "Project" },
                            { name: "Science Test Unit 1", subject: "Science", score: 92, maxScore: 100, date: "2025-01-20", type: "Test" },
                            { name: "Math Quiz Chapter 1", subject: "Mathematics", score: 85, maxScore: 100, date: "2025-01-15", type: "Quiz" }
                        ]
                    },
                    11: { // Hermione Granger
                        studentName: "Hermione Granger",
                        overallAverage: 97.8,
                        overallLetterGrade: "A+",
                        completedAssignments: 5,
                        totalAssignments: 5,
                        lateSubmissions: 0,
                        subjectPerformance: [
                            { subject: "Mathematics", average: 98.0, assignments: 1 },
                            { subject: "Science", average: 100.0, assignments: 1 },
                            { subject: "English", average: 95.0, assignments: 1 },
                            { subject: "History", average: 98.0, assignments: 1 },
                            { subject: "General", average: 100.0, assignments: 1 }
                        ],
                        assignmentTypes: [
                            { type: "Quiz", average: 98.0, count: 1 },
                            { type: "Test", average: 100.0, count: 1 },
                            { type: "Project", average: 95.0, count: 1 },
                            { type: "Homework", average: 98.0, count: 1 },
                            { type: "Participation", average: 100.0, count: 1 }
                        ],
                        recentAssignments: [
                            { name: "Class Participation", subject: "General", score: 100, maxScore: 100, date: "2025-02-05", type: "Participation" },
                            { name: "History Assignment", subject: "History", score: 98, maxScore: 100, date: "2025-01-30", type: "Homework" },
                            { name: "English Essay", subject: "English", score: 95, maxScore: 100, date: "2025-01-25", type: "Project" },
                            { name: "Science Test Unit 1", subject: "Science", score: 100, maxScore: 100, date: "2025-01-20", type: "Test" },
                            { name: "Math Quiz Chapter 1", subject: "Mathematics", score: 98, maxScore: 100, date: "2025-01-15", type: "Quiz" }
                        ]
                    },
                    12: { // Ron Weasley
                        studentName: "Ron Weasley",
                        overallAverage: 77.4,
                        overallLetterGrade: "C+",
                        completedAssignments: 5,
                        totalAssignments: 5,
                        lateSubmissions: 1,
                        subjectPerformance: [
                            { subject: "Mathematics", average: 72.0, assignments: 1 },
                            { subject: "Science", average: 78.0, assignments: 1 },
                            { subject: "English", average: 82.0, assignments: 1 },
                            { subject: "History", average: 77.0, assignments: 1 },
                            { subject: "General", average: 78.0, assignments: 1 }
                        ],
                        assignmentTypes: [
                            { type: "Quiz", average: 72.0, count: 1 },
                            { type: "Test", average: 78.0, count: 1 },
                            { type: "Project", average: 82.0, count: 1 },
                            { type: "Homework", average: 77.0, count: 1 },
                            { type: "Participation", average: 78.0, count: 1 }
                        ],
                        recentAssignments: [
                            { name: "Class Participation", subject: "General", score: 78, maxScore: 100, date: "2025-02-05", type: "Participation" },
                            { name: "History Assignment", subject: "History", score: 77, maxScore: 100, date: "2025-01-30", type: "Homework" },
                            { name: "English Essay", subject: "English", score: 82, maxScore: 100, date: "2025-01-25", type: "Project" },
                            { name: "Science Test Unit 1", subject: "Science", score: 78, maxScore: 100, date: "2025-01-20", type: "Test" },
                            { name: "Math Quiz Chapter 1", subject: "Mathematics", score: 72, maxScore: 100, date: "2025-01-15", type: "Quiz" }
                        ]
                    }
                };
                
                const analytics = studentAnalytics[studentId] || studentAnalytics[10]; // Default to Harry Potter if not found
                displayStudentAnalyticsInTeacher(analytics);
                
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
            }, 500);
        }
        
        function displayStudentAnalyticsInTeacher(analytics) {
            const contentDiv = document.getElementById('teacherStudentAnalyticsContent');
            
            const overallGrade = getGradeClass(analytics.overallLetterGrade);
            
            contentDiv.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-user-graduate"></i> ${analytics.studentName}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-primary text-white rounded">
                                    <h3>${analytics.overallAverage.toFixed(1)}%</h3>
                                    <small>Overall Average</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-success text-white rounded">
                                    <h3><span class="grade-badge ${overallGrade}">${analytics.overallLetterGrade}</span></h3>
                                    <small>Letter Grade</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-info text-white rounded">
                                    <h3>${analytics.completedAssignments}/${analytics.totalAssignments}</h3>
                                    <small>Assignments</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-warning text-white rounded">
                                    <h3>${analytics.lateSubmissions}</h3>
                                    <small>Late Submissions</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-line"></i> Grade Trends</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="teacherGradeTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-book"></i> Subject Performance</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="teacherSubjectChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h6><i class="fas fa-table"></i> Assignment Type Performance</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Assignment Type</th>
                                        <th>Average Score</th>
                                        <th>Letter Grade</th>
                                        <th>Completed</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analytics.assignmentTypePerformances.map(perf => `
                                        <tr>
                                            <td>${perf.assignmentType}</td>
                                            <td>${perf.averageScore.toFixed(1)}%</td>
                                            <td><span class="badge ${getGradeClass(perf.letterGrade)}">${perf.letterGrade}</span></td>
                                            <td>${perf.completedAssignments}</td>
                                            <td>${perf.totalAssignments}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Create charts
            createTeacherGradeTrendChart(analytics.gradeTrends);
            createTeacherSubjectChart(analytics.subjectPerformances);
        }
        
        async function loadClassAnalyticsFromTeacher() {
            const className = document.getElementById('teacherClassSelect').value;
            if (!className) {
                alert('Please select a class');
                return;
            }
            
            const loadingDiv = document.getElementById('teacherClassLoading');
            const contentDiv = document.getElementById('teacherClassAnalyticsContent');
            
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            
            // Use static class analytics data
            setTimeout(() => {
                const staticClassAnalytics = {
                    className: "Grade 7 - Mathematics",
                    classAverage: 87.2,
                    activeStudents: 12,
                    totalStudents: 12,
                    assignmentCompletion: 95.8,
                    gradeDistribution: [
                        { grade: "A+", count: 2, percentage: 16.7 },
                        { grade: "A", count: 4, percentage: 33.3 },
                        { grade: "B+", count: 3, percentage: 25.0 },
                        { grade: "B", count: 2, percentage: 16.7 },
                        { grade: "C+", count: 1, percentage: 8.3 }
                    ],
                    subjectPerformance: [
                        { subject: "Mathematics", average: 87.2, students: 12 },
                        { subject: "Science", average: 89.5, students: 12 },
                        { subject: "English", average: 84.3, students: 12 },
                        { subject: "History", average: 85.8, students: 12 }
                    ],
                    topPerformers: [
                        { name: "Hermione Granger", average: 97.8, grade: "A+" },
                        { name: "Luna Lovegood", average: 94.2, grade: "A" },
                        { name: "Neville Longbottom", average: 91.5, grade: "A" },
                        { name: "Harry Potter", average: 86.6, grade: "B+" },
                        { name: "Ron Weasley", average: 82.1, grade: "B" }
                    ]
                };
                
                displayClassAnalyticsInTeacher(staticClassAnalytics);
                
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
            }, 1000);
        }
        
        function displayClassAnalyticsInTeacher(analytics) {
            const contentDiv = document.getElementById('teacherClassAnalyticsContent');
            
            contentDiv.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chalkboard-teacher"></i> ${analytics.className}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-primary text-white rounded">
                                    <h3>${analytics.classAverage.toFixed(1)}%</h3>
                                    <small>Class Average</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-success text-white rounded">
                                    <h3>${analytics.activeStudents}/${analytics.totalStudents}</h3>
                                    <small>Active Students</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-info text-white rounded">
                                    <h3>${analytics.subject}</h3>
                                    <small>Subject</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-warning text-white rounded">
                                    <h3>${analytics.gradeLevel}</h3>
                                    <small>Grade Level</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-pie"></i> Grade Distribution</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="teacherGradeDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-bar"></i> Assignment Performance</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="teacherAssignmentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h6><i class="fas fa-users"></i> Student Performance</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Grade Level</th>
                                        <th>Average</th>
                                        <th>Letter Grade</th>
                                        <th>Assignments</th>
                                        <th>Late</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analytics.studentSummaries.map(student => `
                                        <tr>
                                            <td>${student.studentName}</td>
                                            <td>${student.gradeLevel}</td>
                                            <td>${student.overallAverage.toFixed(1)}%</td>
                                            <td><span class="badge ${getGradeClass(student.overallLetterGrade)}">${student.overallLetterGrade}</span></td>
                                            <td>${student.completedAssignments}/${student.totalAssignments}</td>
                                            <td>${student.lateSubmissions}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Create charts
            createTeacherGradeDistributionChart(analytics.gradeDistribution);
            createTeacherAssignmentChart(analytics.assignmentAnalytics);
        }
        
        function setupTeacherGradeForm() {
            const form = document.getElementById('teacherGradeForm');
            if (form) {
                form.addEventListener('submit', handleTeacherGradeSubmission);
            }
        }
        
        async function handleTeacherGradeSubmission(e) {
            e.preventDefault();
            
            const gradeData = {
                studentId: parseInt(document.getElementById('teacherGradeStudent').value),
                assignmentName: document.getElementById('teacherAssignmentName').value,
                assignmentType: document.getElementById('teacherAssignmentType').value,
                score: parseFloat(document.getElementById('teacherScore').value),
                maxScore: parseFloat(document.getElementById('teacherMaxScore').value),
                comments: document.getElementById('teacherComments').value,
                dueDate: document.getElementById('teacherDueDate').value,
                submittedDate: document.getElementById('teacherSubmittedDate').value,
                subject: document.getElementById('teacherSubject').value,
                gradeLevel: document.getElementById('teacherGradeLevel').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}analytics/grade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gradeData)
                });

                if (response.ok) {
                    showTeacherMessage('teacherGradeSuccess', 'Grade added successfully!');
                    document.getElementById('teacherGradeForm').reset();
                } else {
                    showTeacherMessage('teacherGradeError', 'Error adding grade. Please try again.');
                }
            } catch (error) {
                console.error('Error adding grade:', error);
                showTeacherMessage('teacherGradeError', 'Error adding grade. Please try again.');
            }
        }
        
        function showTeacherMessage(elementId, message) {
            const errorDiv = document.getElementById('teacherGradeError');
            const successDiv = document.getElementById('teacherGradeSuccess');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (elementId === 'teacherGradeSuccess') {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            } else {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function createTeacherGradeTrendChart(gradeTrends) {
            const ctx = document.getElementById('teacherGradeTrendChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: gradeTrends.map(trend => new Date(trend.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Grade Percentage',
                        data: gradeTrends.map(trend => trend.score),
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function createTeacherSubjectChart(subjectPerformances) {
            const ctx = document.getElementById('teacherSubjectChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: subjectPerformances.map(subj => subj.subject),
                    datasets: [{
                        data: subjectPerformances.map(subj => subj.averageScore),
                        backgroundColor: [
                            '#0d6efd',
                            '#198754',
                            '#fd7e14',
                            '#dc3545',
                            '#6f42c1',
                            '#20c997'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createTeacherGradeDistributionChart(gradeDistribution) {
            const ctx = document.getElementById('teacherGradeDistributionChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: gradeDistribution.map(gd => gd.gradeRange),
                    datasets: [{
                        data: gradeDistribution.map(gd => gd.studentCount),
                        backgroundColor: [
                            '#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545',
                            '#6f42c1', '#20c997', '#e83e8c', '#fd7e14', '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createTeacherAssignmentChart(assignmentAnalytics) {
            const ctx = document.getElementById('teacherAssignmentChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: assignmentAnalytics.map(a => a.assignmentName),
                    datasets: [{
                        label: 'Class Average',
                        data: assignmentAnalytics.map(a => a.classAverage),
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function getGradeClass(letterGrade) {
            if (letterGrade.startsWith('A')) return 'bg-success';
            if (letterGrade.startsWith('B')) return 'bg-info';
            if (letterGrade.startsWith('C')) return 'bg-warning';
            if (letterGrade.startsWith('D')) return 'bg-danger';
            return 'bg-secondary';
        }
        
        async function loadAllAnalytics() {
            await loadTeacherAnalyticsData();
            alert('Analytics data refreshed!');
        }
        
        // Show student dashboard
        function showStudentDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('studentDashboard').classList.add('active');
            
            // Show universal menu
            document.getElementById('universalMenu').style.display = 'block';
            
            // Update student name and grade display
            const studentName = (currentUser.firstName || 'Student') + ' ' + (currentUser.lastName || 'User');
            document.getElementById('studentName').textContent = studentName;
            
            // Update module access based on grade
            updateModuleAccess();
            
            updateStarsDisplay();
            updateGameAvailability();
            
            // Load student's classrooms
            loadStudentClassrooms();
        }
        
        // Show join classroom modal
        window.showJoinClassroom = async function() {
            // Create modal backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'joinClassroomBackdrop';
            document.body.appendChild(backdrop);
            
            // Create modal with loading message first
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.zIndex = '1060';
            modal.id = 'joinClassroomModal';
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Join Classroom</h5>
                            <button type="button" class="btn-close" onclick="closeJoinModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group mb-3">
                                <label class="form-label">Classroom Code</label>
                                <input type="text" class="form-control" id="classroomCode" placeholder="Enter classroom code or click a classroom below">
                            </div>
                            <div class="mb-3" id="classroomsListContainer">
                                <strong class="mb-2 d-block">Available Classrooms:</strong>
                                <p class="text-muted">Loading classrooms...</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="joinClassroomWithCode()">Join Classroom</button>
                            <button class="btn btn-secondary" onclick="closeJoinModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking backdrop (but not when clicking inside modal)
            backdrop.onclick = function(event) {
                if (event.target === backdrop) {
                    closeJoinModal();
                }
            };
            
            // Prevent backdrop clicks from closing when clicking inside modal
            modal.onclick = function(event) {
                event.stopPropagation();
            };
            
            // Now fetch and update the classrooms list
            loadClassroomsList();
            
            async function loadClassroomsList() {
                const container = document.getElementById('classroomsListContainer');
                try {
                    const allClassrooms = await apiCall('classrooms');
                    console.log('Fetched classrooms:', allClassrooms);
                    
                    if (allClassrooms && allClassrooms.length > 0) {
                        const activeClassrooms = allClassrooms.filter(c => c.isActive || c.IsActive);
                        console.log('Active classrooms:', activeClassrooms);
                        
                        if (activeClassrooms.length === 0) {
                            container.innerHTML = '<strong class="mb-2 d-block">Available Classrooms:</strong><p class="text-muted">No active classrooms available at the moment.</p>';
                        } else {
                            let html = '<strong class="mb-2 d-block">Available Classrooms:</strong><div class="list-group" style="max-height: 300px; overflow-y: auto;">';
                            for (const classroom of activeClassrooms) {
                                // Escape special characters to prevent XSS
                                const safeCode = classroom.code.replace(/'/g, "\\'").replace(/"/g, '\\"');
                                html += `
                                    <div class="list-group-item list-group-item-action" onclick="selectClassroomCode('${safeCode}')" style="cursor: pointer;">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">${classroom.name}</h6>
                                            <code class="text-primary">${classroom.code}</code>
                                        </div>
                                        <p class="mb-1"><small>${classroom.subject} - Grade ${classroom.grade}</small></p>
                                    </div>
                                `;
                            }
                            html += '</div>';
                            container.innerHTML = html;
                        }
                    } else {
                        container.innerHTML = '<strong class="mb-2 d-block">Available Classrooms:</strong><p class="text-muted">No classrooms available at the moment.</p>';
                    }
                } catch (error) {
                    console.error('Error loading classrooms:', error);
                    container.innerHTML = `<strong class="mb-2 d-block">Available Classrooms:</strong><p class="text-danger">Error loading classrooms: ${error.message}. Please try again.</p>`;
                }
            }
        }
        
        // Select a classroom code from the list
        window.selectClassroomCode = function(code) {
            const input = document.getElementById('classroomCode');
            if (input) {
                input.value = code;
                input.focus();
            }
        }
        
        // Join classroom with code
        window.joinClassroomWithCode = async function() {
            const codeInput = document.getElementById('classroomCode');
            if (!codeInput) {
                console.error('Classroom code input not found');
                return;
            }
            
            const code = codeInput.value?.trim().toUpperCase();
            
            if (!code) {
                alert('Please enter a classroom code.');
                return;
            }
            
            if (!currentUser) {
                alert('You must be logged in to join a classroom.');
                return;
            }
            
            try {
                console.log('Joining classroom with code:', code, 'Student ID:', currentUser.id);
                const response = await apiCall('classrooms/join-by-code', 'POST', {
                    code: code,
                    studentId: currentUser.id
                });
                
                console.log('Join response:', response);
                
                alert(`Successfully joined classroom!`);
                closeJoinModal();
                
                // Refresh the student's classroom list
                if (currentUser.role === 'student') {
                    await loadStudentClassrooms();
                }
                
                // Award stars
                userStars += 5;
                updateStarsDisplay();
                await syncWithDatabase();
                
            } catch (error) {
                console.error('Error joining classroom:', error);
                const errorMessage = error.message || 'Unknown error';
                alert(`Failed to join classroom: ${errorMessage}. Please check the code and try again.`);
            }
        }
        
        // Close the join classroom modal
        window.closeJoinModal = function() {
            const modal = document.getElementById('joinClassroomModal');
            const backdrop = document.getElementById('joinClassroomBackdrop');
            
            if (modal) {
                document.body.removeChild(modal);
            }
            
            if (backdrop) {
                document.body.removeChild(backdrop);
            }
        }
        
        // Load student's classrooms
        async function loadStudentClassrooms() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            const container = document.getElementById('studentClassroomsList');
            
            try {
                const classrooms = await apiCall(`classrooms/student/${currentUser.id}`);
                
                if (classrooms.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> You haven't joined any classrooms yet. 
                            Use the "Join Classroom" button above to enter a classroom code from your teacher.
                        </div>
                    `;
                    return;
                }
                
                // Display classrooms
                let html = '<div class="row">';
                for (const classroom of classrooms) {
                    // Get teacher info
                    let teacherName = 'Teacher';
                    try {
                        const teacher = await apiCall(`users/${classroom.teacherId}`);
                        teacherName = `${teacher.firstName} ${teacher.lastName}`;
                    } catch (e) {
                        console.warn('Could not load teacher info:', e);
                    }
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title">${classroom.name}</div>
                                    <span class="badge bg-primary">${classroom.subject}</span>
                                </div>
                                <div class="module-description">
                                    <strong>Teacher:</strong> ${teacherName}<br>
                                    <strong>Grade:</strong> ${classroom.grade}<br>
                                    <strong>Description:</strong> ${classroom.description || 'No description available'}
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="viewClassroomContent(${classroom.id})">
                                        <i class="fas fa-eye"></i> View Content
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading classrooms:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error loading classrooms. Please try again later.
                    </div>
                `;
            }
        }
        
        // View classroom content
        async function viewClassroomContent(classroomId) {
            try {
                const classroom = await apiCall(`classrooms/${classroomId}`);
                
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${classroom.name}</h5>
                                <button type="button" class="btn-close" onclick="closeContentModal()"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Classroom Information</h6>
                                <p><strong>Subject:</strong> ${classroom.subject}</p>
                                <p><strong>Grade:</strong> ${classroom.grade}</p>
                                <p><strong>Description:</strong> ${classroom.description || 'No description available'}</p>
                                
                                <hr>
                                
                                <h6>Assigned Content</h6>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Your teacher will assign quizzes and lessons here. Check back regularly for updates!
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeContentModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.setAttribute('id', 'contentModal');
                
            } catch (error) {
                console.error('Error loading classroom content:', error);
                alert('Error loading classroom content. Please try again.');
            }
        }
        
        // Close content modal
        function closeContentModal() {
            const modal = document.getElementById('contentModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // Load teacher's classrooms
        async function loadTeacherClassrooms() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            
            const container = document.getElementById('teacherClassroomsList');
            
            try {
                const classrooms = await apiCall(`classrooms/teacher/${currentUser.id}`);
                
                if (classrooms.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> You haven't created any classrooms yet. 
                            Use the "Create Classroom" button to get started!
                        </div>
                    `;
                    return;
                }
                
                // Display classrooms
                let html = '<div class="row">';
                for (const classroom of classrooms) {
                    const studentIds = JSON.parse(classroom.studentIds || '[]');
                    const studentCount = studentIds.length;
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title">${classroom.name}</div>
                                    <span class="badge bg-primary">${classroom.subject}</span>
                                </div>
                                <div class="module-description">
                                    <strong>Code:</strong> <code>${classroom.code}</code><br>
                                    <strong>Grade:</strong> ${classroom.grade}<br>
                                    <strong>Students:</strong> ${studentCount}<br>
                                    <strong>Description:</strong> ${classroom.description || 'No description available'}
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-primary" onclick="viewClassroomContent(${classroom.id})">
                                        <i class="fas fa-eye"></i> View Students
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading classrooms:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error loading classrooms. Please try again later.
                    </div>
                `;
            }
        }
        
        // Teacher utility functions
        function createQuiz(classroomId) {
            // Show quiz creation modal
            showQuizCreationModal(classroomId);
        }
        
        function showQuizCreationModal(classroomId) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="quizCreationModal" tabindex="-1" aria-labelledby="quizCreationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="quizCreationModalLabel">Create New Quiz</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="quizForm">
                                    <div class="mb-3">
                                        <label for="quizTitle" class="form-label">Quiz Title</label>
                                        <input type="text" class="form-control" id="quizTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="quizDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizSubject" class="form-label">Subject</label>
                                        <select class="form-select" id="quizSubject" required>
                                            <option value="">Select Subject</option>
                                            <option value="math">Mathematics</option>
                                            <option value="english">English Language Arts</option>
                                            <option value="science">Science</option>
                                            <option value="social-studies">Social Studies</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizGrade" class="form-label">Target Grade Level</label>
                                        <select class="form-select" id="quizGrade" required>
                                            <option value="">Select Grade</option>
                                            <option value="3">Grade 3</option>
                                            <option value="4">Grade 4</option>
                                            <option value="5">Grade 5</option>
                                            <option value="6">Grade 6</option>
                                            <option value="7">Grade 7</option>
                                            <option value="8">Grade 8</option>
                                            <option value="9">Grade 9</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizTimeLimit" class="form-label">Time Limit (minutes)</label>
                                        <input type="number" class="form-control" id="quizTimeLimit" min="5" max="120" value="30">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Question Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="multipleChoice" checked>
                                            <label class="form-check-label" for="multipleChoice">
                                                Multiple Choice
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="trueFalse">
                                            <label class="form-check-label" for="trueFalse">
                                                True/False
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="shortAnswer">
                                            <label class="form-check-label" for="shortAnswer">
                                                Short Answer
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="essay">
                                            <label class="form-check-label" for="essay">
                                                Essay Questions
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="questionCount" class="form-label">Number of Questions</label>
                                        <input type="number" class="form-control" id="questionCount" min="5" max="50" value="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Difficulty Level</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="difficulty" id="easy" value="easy">
                                            <label class="form-check-label" for="easy">
                                                Easy
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="difficulty" id="medium" value="medium" checked>
                                            <label class="form-check-label" for="medium">
                                                Medium
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="difficulty" id="hard" value="hard">
                                            <label class="form-check-label" for="hard">
                                                Hard
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveQuiz()">Create Quiz</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('quizCreationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('quizCreationModal'));
            modal.show();
        }
        
        function saveQuiz() {
            const quizData = {
                title: document.getElementById('quizTitle').value,
                description: document.getElementById('quizDescription').value,
                subject: document.getElementById('quizSubject').value,
                grade: document.getElementById('quizGrade').value,
                timeLimit: document.getElementById('quizTimeLimit').value,
                questionTypes: {
                    multipleChoice: document.getElementById('multipleChoice').checked,
                    trueFalse: document.getElementById('trueFalse').checked,
                    shortAnswer: document.getElementById('shortAnswer').checked,
                    essay: document.getElementById('essay').checked
                },
                questionCount: document.getElementById('questionCount').value,
                difficulty: document.querySelector('input[name="difficulty"]:checked').value,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString()
            };
            
            // Validate form
            if (!quizData.title || !quizData.subject || !quizData.grade) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Save quiz (in a real app, this would save to database)
            console.log('Quiz created:', quizData);
            
            // Show success message
            alert(`Quiz "${quizData.title}" created successfully!`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quizCreationModal'));
            modal.hide();
            
            // Update teacher's quiz count (if we track this)
            if (currentUser.quizzesCreated) {
                currentUser.quizzesCreated++;
            } else {
                currentUser.quizzesCreated = 1;
            }
            
            // Save updated user data
            saveUserData();
            saveToDatabase();
        }
        
        function createCompetition() {
            alert('Competition creation tool coming soon! This will allow teachers to create engaging competitions for their students.');
        }
        
        function viewAnalytics() {
            alert('Analytics dashboard coming soon! This will show detailed student progress and performance metrics.');
        }
        
        // Classroom code management functions
        function copyClassroomCode(code) {
            navigator.clipboard.writeText(code).then(function() {
                // Show success feedback
                const button = event.target.closest('button');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check text-success"></i>';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy code. Please try again.');
            });
        }
        
        function regenerateClassroomCode(classroomId) {
            // Generate a new classroom code
            const prefix = classroomId.toUpperCase().replace(/\d/g, '');
            const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            const newCode = `${prefix}-${randomCode}`;
            
            // Update the display
            const codeElement = document.getElementById(`${classroomId}Code`);
            if (codeElement) {
                codeElement.textContent = newCode;
            }
            
            // Update the copy button onclick
            const copyButton = codeElement.parentElement.querySelector('button[onclick*="copyClassroomCode"]');
            if (copyButton) {
                copyButton.setAttribute('onclick', `copyClassroomCode('${newCode}')`);
            }
            
            // Show success message
            alert(`New classroom code generated: ${newCode}\n\nShare this code with your students so they can join your classroom.`);
            
            // In a real app, this would save to the database
            console.log(`Generated new code for ${classroomId}: ${newCode}`);
        }
        
        function generateClassroomCode(className, roomNumber) {
            // Generate a classroom code based on class name and room number
            const prefix = className.replace(/\s+/g, '').substring(0, 4).toUpperCase();
            const roomCode = roomNumber.toString().padStart(3, '0');
            const randomCode = Math.random().toString(36).substring(2, 5).toUpperCase();
            return `${prefix}-${roomCode}${randomCode}`;
        }
        
        function showCreateClassroomModal() {
            const modalHtml = `
                <div class="modal fade" id="createClassroomModal" tabindex="-1" aria-labelledby="createClassroomModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createClassroomModalLabel">Create New Classroom</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createClassroomForm">
                                    <div class="mb-3">
                                        <label for="className" class="form-label">Class Name</label>
                                        <input type="text" class="form-control" id="className" placeholder="e.g., Grade 7 Math" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="roomNumber" class="form-label">Room Number</label>
                                        <input type="text" class="form-control" id="roomNumber" placeholder="e.g., 101" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="subject" class="form-label">Subject</label>
                                        <select class="form-select" id="subject" required>
                                            <option value="">Select Subject</option>
                                            <option value="math">Mathematics</option>
                                            <option value="english">English Language Arts</option>
                                            <option value="science">Science</option>
                                            <option value="social-studies">Social Studies</option>
                                            <option value="history">History</option>
                                            <option value="art">Art</option>
                                            <option value="music">Music</option>
                                            <option value="physical-education">Physical Education</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="gradeLevel" class="form-label">Grade Level</label>
                                        <select class="form-select" id="gradeLevel" required>
                                            <option value="">Select Grade</option>
                                            <option value="K">Kindergarten</option>
                                            <option value="1">Grade 1</option>
                                            <option value="2">Grade 2</option>
                                            <option value="3">Grade 3</option>
                                            <option value="4">Grade 4</option>
                                            <option value="5">Grade 5</option>
                                            <option value="6">Grade 6</option>
                                            <option value="7">Grade 7</option>
                                            <option value="8">Grade 8</option>
                                            <option value="9">Grade 9</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description (Optional)</label>
                                        <textarea class="form-control" id="description" rows="3" placeholder="Brief description of the class..."></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createNewClassroom()">Create Classroom</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('createClassroomModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createClassroomModal'));
            modal.show();
        }
        
        function createNewClassroom() {
            const className = document.getElementById('className').value;
            const roomNumber = document.getElementById('roomNumber').value;
            const subject = document.getElementById('subject').value;
            const gradeLevel = document.getElementById('gradeLevel').value;
            const description = document.getElementById('description').value;
            
            // Validate form
            if (!className || !roomNumber || !subject || !gradeLevel) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Generate classroom code
            const classroomCode = generateClassroomCode(className, roomNumber);
            
            // Create classroom data
            const classroomData = {
                name: className,
                roomNumber: roomNumber,
                subject: subject,
                gradeLevel: gradeLevel,
                description: description,
                code: classroomCode,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString(),
                students: []
            };
            
            // In a real app, this would save to the database
            console.log('New classroom created:', classroomData);
            
            // Show success message with classroom code
            alert(`Classroom "${className}" created successfully!\n\nClassroom Code: ${classroomCode}\n\nShare this code with your students so they can join your classroom.`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createClassroomModal'));
            modal.hide();
            
            // In a real app, you would refresh the classroom list here
            // For now, we'll just show a message
            alert('Note: In a full implementation, the new classroom would appear in your classroom list.');
        }

        // Start learning module
        function startModule(moduleId) {
            const module = document.getElementById(moduleId);
            const progressElement = document.getElementById(moduleId + 'Progress');
            const progressBar = module.querySelector('.progress-fill');
            
            // Show test content based on module type
            if (moduleId === 'module5') {
                showTestStrategies(moduleId);
            } else if (moduleId === 'module3') {
                showWritingPrompt(moduleId);
            } else {
                showTestQuestions(moduleId);
            }
        }
        
        // Show test questions for math modules
        function showTestQuestions(moduleId) {
            const content = testContent[moduleId];
            const questions = content.questions;
            let currentQuestion = 0;
            let correctAnswers = 0;
            
            // Create modal for test questions
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${content.title}</h5>
                            <button type="button" class="btn-close" onclick="closeTestModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div id="questionContainer">
                                <h6>Question ${currentQuestion + 1} of ${questions.length}</h6>
                                <p class="question-text">${questions[currentQuestion].question}</p>
                                <div class="options-container">
                                    ${questions[currentQuestion].options.map((option, index) => 
                                        `<button class="btn btn-outline-primary option-btn" onclick="selectAnswer(${index}, ${questions[currentQuestion].correct})">${option}</button>`
                                    ).join('')}
                                </div>
                                <div id="explanation" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Explanation:</strong> <span id="explanationText"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">Next Question</button>
                            <button class="btn btn-success" id="finishBtn" onclick="finishTest()" style="display: none;">Finish Test</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Global functions for the test
            window.selectAnswer = function(selectedIndex, correctIndex) {
                const isCorrect = selectedIndex === correctIndex;
                if (isCorrect) correctAnswers++;
                
                // Show explanation
                document.getElementById('explanationText').textContent = questions[currentQuestion].explanation;
                document.getElementById('explanation').style.display = 'block';
                
                // Disable all options
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === questions[currentQuestion].options[correctIndex]) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-success');
                    } else if (btn.textContent === questions[currentQuestion].options[selectedIndex] && !isCorrect) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-danger');
                    }
                });
                
                // Show next button
                if (currentQuestion < questions.length - 1) {
                    document.getElementById('nextBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('finishBtn').style.display = 'inline-block';
                }
            };
            
            window.nextQuestion = function() {
                currentQuestion++;
                if (currentQuestion < questions.length) {
                    document.getElementById('questionContainer').innerHTML = `
                        <h6>Question ${currentQuestion + 1} of ${questions.length}</h6>
                        <p class="question-text">${questions[currentQuestion].question}</p>
                        <div class="options-container">
                            ${questions[currentQuestion].options.map((option, index) => 
                                `<button class="btn btn-outline-primary option-btn" onclick="selectAnswer(${index}, ${questions[currentQuestion].correct})">${option}</button>`
                            ).join('')}
                        </div>
                        <div id="explanation" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Explanation:</strong> <span id="explanationText"></span>
                            </div>
                        </div>
                    `;
                    document.getElementById('nextBtn').style.display = 'none';
                    document.getElementById('finishBtn').style.display = 'none';
                }
            };
            
            window.finishTest = function() {
                const score = Math.round((correctAnswers / questions.length) * 100);
                alert(`Test completed! You scored ${score}% (${correctAnswers}/${questions.length} correct)`);
                closeTestModal();
                completeModule(moduleId);
            };
            
            window.closeTestModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        // Show writing prompt for module 3
        function showWritingPrompt(moduleId) {
            const content = testContent[moduleId];
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${content.title}</h5>
                            <button type="button" class="btn-close" onclick="closeTestModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <h6>Writing Prompt:</h6>
                                <p class="alert alert-light">${content.prompt}</p>
                            </div>
                            <div class="mb-3">
                                <h6>Rubric:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item"><strong>Thesis:</strong> ${content.rubric.thesis}</li>
                                    <li class="list-group-item"><strong>Evidence:</strong> ${content.rubric.evidence}</li>
                                    <li class="list-group-item"><strong>Organization:</strong> ${content.rubric.organization}</li>
                                    <li class="list-group-item"><strong>Language:</strong> ${content.rubric.language}</li>
                                    <li class="list-group-item"><strong>Conventions:</strong> ${content.rubric.conventions}</li>
                                </ul>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Your Essay:</label>
                                <textarea class="form-control" rows="15" id="essayText" placeholder="Write your essay here..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="submitEssay()">Submit Essay</button>
                            <button class="btn btn-secondary" onclick="closeTestModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.submitEssay = function() {
                const essay = document.getElementById('essayText').value;
                if (essay.trim().length < 100) {
                    alert('Please write at least 100 words for your essay.');
                    return;
                }
                alert('Essay submitted! Great job on your writing practice.');
                closeTestModal();
                completeModule(moduleId);
            };
            
            window.closeTestModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        // Show test strategies for module 5
        function showTestStrategies(moduleId) {
            const content = testContent[moduleId];
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${content.title}</h5>
                            <button type="button" class="btn-close" onclick="closeTestModal()"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Essential Test-Taking Strategies:</h6>
                            <ol class="list-group list-group-numbered">
                                ${content.strategies.map(strategy => 
                                    `<li class="list-group-item">${strategy}</li>`
                                ).join('')}
                            </ol>
                            <div class="alert alert-warning mt-3">
                                <strong>Remember:</strong> Practice these strategies regularly to build confidence and improve your test performance!
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="completeStrategies()">I Understand</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.completeStrategies = function() {
                closeTestModal();
                completeModule(moduleId);
            };
            
            window.closeTestModal = function() {
                document.body.removeChild(modal);
            };
        }

        // Complete module
        async function completeModule(moduleId) {
            const module = document.getElementById(moduleId);
            const starsEarned = parseInt(module.querySelector('.module-stars').textContent.match(/\d+/)[0]);
            
            // Add stars
            userStars += starsEarned;
            completedModules++;
            
            // Update progress
            moduleProgress[moduleId] = 100;
            const progressElement = document.getElementById(moduleId + 'Progress');
            const progressBar = module.querySelector('.progress-fill');
            if (progressElement) progressElement.textContent = '100';
            if (progressBar) progressBar.style.width = '100%';
            
            // Update UI
            module.classList.add('completed');
            module.querySelector('.module-actions').innerHTML = '<button class="btn btn-success">Completed!</button>';
            updateStarsDisplay();
            updateGameAvailability();
            
            // Save progress to database
            try {
                const completedModulesList = JSON.parse(currentUser.completedModules || '[]');
                if (!completedModulesList.includes(moduleId)) {
                    completedModulesList.push(moduleId);
                }
                
                // Update currentUser
                currentUser.stars = userStars;
                currentUser.completedModules = JSON.stringify(completedModulesList);
                
                // Save to database and localStorage
                await saveToDatabase();
                saveUserData();
            } catch (error) {
                console.error('Failed to save progress:', error);
            }
            
            alert(`Congratulations! You completed ${testContent[moduleId].title} and earned ${starsEarned} stars!`);
        }

        // Play game
        async function playGame(gameType) {
            const gameCosts = {
                flappy: 10,
                snakes: 15,
                memory: 12
            };
            
            const cost = gameCosts[gameType];
            
            if (userStars >= cost) {
                userStars -= cost;
                updateStarsDisplay();
                updateGameAvailability();
                
                // Save star spending to database
                try {
                    // Update currentUser
                    currentUser.stars = userStars;
                    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
                    
                    // Save to database and localStorage
                    await saveToDatabase();
                    saveUserData();
                } catch (error) {
                    console.error('Failed to save game play:', error);
                }
                
                // Open game in new window
                const gamePages = {
                    flappy: 'flappy-bird.html',
                    snakes: 'snakes.html',
                    memory: 'memory.html'
                };
                
                const gameWindow = window.open(gamePages[gameType], '_blank', 'width=800,height=700,scrollbars=yes,resizable=yes');
                
                // Focus on the new window
                if (gameWindow) {
                    gameWindow.focus();
          }
        } else {
                alert(`You need ${cost} stars to play this game. You have ${userStars} stars.`);
            }
        }

        // Update stars display
        function updateStarsDisplay() {
            console.log('Updating stars display with value:', userStars);
            
            const studentStarsElement = document.getElementById('studentStars');
            const totalStarsElement = document.getElementById('totalStars');
            
            if (studentStarsElement) {
                studentStarsElement.textContent = userStars;
                console.log('Updated studentStars element to:', userStars);
            } else {
                console.warn('studentStars element not found');
            }
            
            if (totalStarsElement) {
                totalStarsElement.textContent = userStars;
                console.log('Updated totalStars element to:', userStars);
            } else {
                console.warn('totalStars element not found');
            }
        }

        // Update game availability
        function updateGameAvailability() {
            const gameCosts = {
                flappy: 10,
                snakes: 15,
                memory: 12
            };
            
            Object.keys(gameCosts).forEach(game => {
                const btn = document.getElementById(game + 'Btn');
                const card = document.getElementById(game + 'GameCard');
                
                if (userStars >= gameCosts[game]) {
                    btn.disabled = false;
                    card.classList.remove('locked');
                } else {
                    btn.disabled = true;
                    card.classList.add('locked');
                }
            });
        }

        // Logout
        // Universal Menu Functions
        function toggleUniversalMenu() {
            const menu = document.getElementById('universalMenu');
            menu.classList.toggle('show');
        }
        
        function viewProfile() {
            if (!currentUser) {
                alert('Please log in to view your profile.');
                return;
            }
            
            const fullName = (currentUser.firstName || 'User') + ' ' + (currentUser.lastName || 'Name');
            const profileInfo = `
                <div class="profile-modal">
                    <h4><i class="fas fa-user-circle"></i> Profile Information</h4>
                    <div class="profile-details">
                        <p><strong>Name:</strong> ${fullName}</p>
                        <p><strong>Email:</strong> ${currentUser.email || 'Not provided'}</p>
                        <p><strong>Role:</strong> ${currentUser.role ? currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1) : 'Unknown'}</p>
                        ${currentUser.grade && currentUser.grade !== 'N/A' ? `<p><strong>Grade:</strong> ${currentUser.grade}</p>` : ''}
                        <p><strong>Stars:</strong> <i class="fas fa-star text-warning"></i> ${userStars || 0}</p>
                        <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                    </div>
                </div>
            `;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">My Profile</h5>
                            <button type="button" class="btn-close" onclick="closeProfileModal()"></button>
                        </div>
                        <div class="modal-body">
                            ${profileInfo}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            toggleUniversalMenu(); // Close the menu
        }
        
        function closeProfileModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }
        
        
        function logout() {
            console.log('Logging out user:', currentUser);
            
            currentUser = null;
            userGrade = null;
            userStars = 0;
            
            // Clear saved user data
            clearSavedUserData();
            
            // Hide all dashboards
            document.getElementById('studentDashboard').classList.remove('active');
            document.getElementById('teacherDashboard').classList.remove('active');
            document.getElementById('adminDashboard').classList.remove('active');
            
            // Hide universal menu
            document.getElementById('universalMenu').style.display = 'none';
            
            // Show login page
            document.getElementById('loginPage').style.display = 'flex';
            
            // Reset all login forms
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Reset role buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            console.log('Logout completed');
            
            // Refresh the page immediately after logout
            window.location.reload();
        }

        // Watch video function
        async function watchVideo(videoId, videoTitle, videoUrl) {
            // Check if already watched
            if (watchedVideos.includes(videoId)) {
                alert('You have already watched this video and earned stars for it!');
                return;
            }
            
            // Create modal for video
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${videoTitle}</h5>
                            <button type="button" class="btn-close" onclick="closeVideoModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="ratio ratio-16x9 mb-3">
                                <iframe src="${videoUrl}" allowfullscreen></iframe>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-star"></i> Watch the video and click "Mark as Completed" to earn 5 stars!
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="completeVideo('${videoId}', '${videoTitle}')">
                                <i class="fas fa-check"></i> Mark as Completed
                            </button>
                            <button class="btn btn-secondary" onclick="closeVideoModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.closeVideoModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        // Complete video and award stars
        async function completeVideo(videoId, videoTitle) {
            if (!watchedVideos.includes(videoId)) {
                watchedVideos.push(videoId);
                userStars += 5;
                
                // Mark video as completed in UI
                const videoCard = document.getElementById(videoId);
                if (videoCard) {
                    videoCard.classList.add('completed');
                    videoCard.querySelector('.module-actions').innerHTML = '<button class="btn btn-success"><i class="fas fa-check"></i> Completed!</button>';
                }
                
                // Update stars display
                updateStarsDisplay();
                updateGameAvailability();
                
                // Save progress to database
                try {
                    currentUser.stars = userStars;
                    await saveToDatabase();
                    saveUserData();
                } catch (error) {
                    console.error('Failed to save video progress:', error);
                }
                
                alert(`Great job! You earned 5 stars for watching "${videoTitle}"!`);
                closeVideoModal();
            }
        }
        
        // Start practice test
        function startPracticeTest(subject) {
            const questions = practiceQuestions[subject];
            let currentQuestion = 0;
            let correctAnswers = 0;
            let totalStarsEarned = 0;
            
            // Create modal for practice test
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            
            function showQuestion() {
                const q = questions[currentQuestion];
                const hasPassage = q.passage !== undefined;
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${subject.charAt(0).toUpperCase() + subject.slice(1)} Practice - Question ${currentQuestion + 1} of ${questions.length}</h5>
                                <button type="button" class="btn-close" onclick="closePracticeModal()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="alert alert-light">
                                        <strong>Progress:</strong> ${correctAnswers} correct out of ${currentQuestion} answered
                                        <span class="float-end"><i class="fas fa-star text-warning"></i> ${totalStarsEarned} stars earned</span>
                                    </div>
                                </div>
                                ${hasPassage ? `
                                    <div class="mb-4">
                                        <h6>Passage:</h6>
                                        <div class="alert alert-light">
                                            <p style="text-align: justify;">${q.passage}</p>
                                        </div>
                                    </div>
                                ` : ''}
                                <div id="questionContainer">
                                    <p class="question-text">${q.question}</p>
                                    <div class="options-container">
                                        ${q.options.map((option, index) => 
                                            `<button class="btn btn-outline-primary option-btn w-100 text-start mb-2" onclick="selectPracticeAnswer(${index}, ${q.correct})">${option}</button>`
                                        ).join('')}
                                    </div>
                                    <div id="explanation" class="mt-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Explanation:</strong> <span id="explanationText"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" id="nextPracticeBtn" onclick="nextPracticeQuestion()" style="display: none;">Next Question</button>
                                <button class="btn btn-success" id="finishPracticeBtn" onclick="finishPracticeTest()" style="display: none;">Finish Test</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.body.appendChild(modal);
            showQuestion();
            
            // Global functions for practice test
            window.selectPracticeAnswer = function(selectedIndex, correctIndex) {
                const q = questions[currentQuestion];
                const isCorrect = selectedIndex === correctIndex;
                
                if (isCorrect) {
                    correctAnswers++;
                    totalStarsEarned += 3;
                    userStars += 3;
                    updateStarsDisplay();
                    updateGameAvailability();
                }
                
                // Show explanation
                document.getElementById('explanationText').textContent = q.explanation;
                document.getElementById('explanation').style.display = 'block';
                
                // Disable all options and highlight correct/incorrect
                document.querySelectorAll('.option-btn').forEach((btn, idx) => {
                    btn.disabled = true;
                    if (idx === correctIndex) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-success');
                    } else if (idx === selectedIndex && !isCorrect) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-danger');
                    }
                });
                
                // Show next/finish button
                if (currentQuestion < questions.length - 1) {
                    document.getElementById('nextPracticeBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('finishPracticeBtn').style.display = 'inline-block';
                }
                
                // Update progress display
                const progressAlert = modal.querySelector('.alert-light');
                if (progressAlert) {
                    progressAlert.innerHTML = `
                        <strong>Progress:</strong> ${correctAnswers} correct out of ${currentQuestion + 1} answered
                        <span class="float-end"><i class="fas fa-star text-warning"></i> ${totalStarsEarned} stars earned</span>
                    `;
                }
            };
            
            window.nextPracticeQuestion = async function() {
                // Save stars before moving to next question
                try {
                    currentUser.stars = userStars;
                    await saveToDatabase();
                    saveUserData();
                } catch (error) {
                    console.error('Failed to save practice progress:', error);
                }
                
                currentQuestion++;
                if (currentQuestion < questions.length) {
                    showQuestion();
                }
            };
            
            window.finishPracticeTest = async function() {
                // Save final stars
                try {
                    currentUser.stars = userStars;
                    await saveToDatabase();
                    saveUserData();
                } catch (error) {
                    console.error('Failed to save practice progress:', error);
                }
                
                const score = Math.round((correctAnswers / questions.length) * 100);
                alert(`Practice test completed!\n\nScore: ${score}% (${correctAnswers}/${questions.length} correct)\nStars earned: ${totalStarsEarned} ⭐`);
                closePracticeModal();
            };
            
            window.closePracticeModal = function() {
                document.body.removeChild(modal);
            };
        }

        // Listen for messages from game windows
        window.addEventListener('message', function(event) {
            if (event.data.type === 'playGame') {
                const { gameType, cost } = event.data;
                
                if (userStars >= cost) {
                    userStars -= cost;
                    updateStarsDisplay();
                    updateGameAvailability();
                    
                    // Save star spending to database
                    if (currentUser) {
                        // Update currentUser
                        currentUser.stars = userStars;
                        currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
                        
                        // Save to database and localStorage
                        saveToDatabase().then(() => {
                            saveUserData();
                        }).catch(error => {
                            console.error('Failed to save game play:', error);
                        });
                    }
                } else {
                    alert(`You need ${cost} stars to play this game. You have ${userStars} stars.`);
                    // Send message back to game window to prevent play again
                    event.source.postMessage({ type: 'insufficientStars' }, '*');
                }
            }
        });

        // View classroom function for teachers
        function viewClassroom(classroomId) {
            // For now, we'll show a mock classroom with sample students
            // In a real implementation, this would fetch from the API
            const sampleStudents = [
                { id: 10, name: "Harry Potter", grade: "Grade 7", stars: 100, lastActive: "2 hours ago" },
                { id: 11, name: "Hermione Granger", grade: "Grade 7", stars: 95, lastActive: "1 hour ago" },
                { id: 12, name: "Ron Weasley", grade: "Grade 7", stars: 85, lastActive: "3 hours ago" },
                { id: 13, name: "Neville Longbottom", grade: "Grade 7", stars: 75, lastActive: "5 hours ago" },
                { id: 14, name: "Luna Lovegood", grade: "Grade 6", stars: 90, lastActive: "1 hour ago" },
                { id: 15, name: "Ginny Weasley", grade: "Grade 6", stars: 88, lastActive: "2 hours ago" },
                { id: 16, name: "Draco Malfoy", grade: "Grade 7", stars: 80, lastActive: "4 hours ago" },
                { id: 17, name: "Cedric Diggory", grade: "Grade 7", stars: 92, lastActive: "30 minutes ago" }
            ];

            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Classroom Students - ${classroomId === 'math7' ? 'Grade 7 Math' : 'Grade 8 Science'}</h5>
                            <button type="button" class="btn-close" onclick="closeClassroomModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <strong>Total Students:</strong> ${sampleStudents.length}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-success">
                                        <strong>Active Today:</strong> ${sampleStudents.filter(s => s.lastActive.includes('hour') || s.lastActive.includes('minutes')).length}
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Grade</th>
                                            <th>Stars Earned</th>
                                            <th>Last Active</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sampleStudents.map(student => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-circle me-2">
                                                            ${student.name.split(' ').map(n => n[0]).join('')}
                                                        </div>
                                                        <strong>${student.name}</strong>
                                                    </div>
                                                </td>
                                                <td>${student.grade}</td>
                                                <td>
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-star"></i> ${student.stars}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">${student.lastActive}</small>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewStudentProgress(${student.id})">
                                                        <i class="fas fa-chart-line"></i> Progress
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeClassroomModal()">Close</button>
                            <button class="btn btn-primary" onclick="exportStudentData()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close classroom modal
        function closeClassroomModal() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // View individual student progress
        function viewStudentProgress(studentId) {
            alert(`Viewing progress for student ID: ${studentId}\n\nThis would show detailed progress, completed modules, quiz scores, and activity history.`);
        }

        // Export student data
        function exportStudentData() {
            alert('Exporting student data...\n\nThis would generate a CSV or Excel file with all student progress data.');
        }

        // Create quiz function for teachers
        function createQuiz(classroomId) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Create Quiz - ${classroomId === 'math7' ? 'Grade 7 Math' : 'Grade 8 Science'}</h5>
                            <button type="button" class="btn-close" onclick="closeQuizModal()"></button>
                        </div>
                        <div class="modal-body">
                            <form id="quizCreationForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Quiz Title</label>
                                        <input type="text" class="form-control" id="quizTitle" placeholder="Enter quiz title" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subject</label>
                                        <select class="form-control" id="quizSubject" required>
                                            <option value="">Select Subject</option>
                                            <option value="math">Mathematics</option>
                                            <option value="science">Science</option>
                                            <option value="english">English</option>
                                            <option value="social">Social Studies</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Time Limit (minutes)</label>
                                        <input type="number" class="form-control" id="timeLimit" min="5" max="120" value="30">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Total Points</label>
                                        <input type="number" class="form-control" id="totalPoints" min="10" max="100" value="50">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Difficulty</label>
                                        <select class="form-control" id="difficulty">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Quiz Description</label>
                                    <textarea class="form-control" id="quizDescription" rows="3" placeholder="Describe what this quiz covers..."></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Quiz Questions</h6>
                                        <button type="button" class="btn btn-success btn-sm" onclick="addQuestion()">
                                            <i class="fas fa-plus"></i> Add Question
                                        </button>
                                    </div>
                                    <div id="questionsContainer">
                                        <!-- Questions will be added here dynamically -->
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <strong>Instructions:</strong>
                                    <ul class="mb-0">
                                        <li>Add at least 3 questions to create a quiz</li>
                                        <li>Each question must have 4 answer options</li>
                                        <li>Mark the correct answer for each question</li>
                                        <li>Questions will be automatically numbered</li>
                                    </ul>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeQuizModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="previewQuiz()">
                                <i class="fas fa-eye"></i> Preview Quiz
                            </button>
                            <button class="btn btn-success" onclick="saveQuiz()">
                                <i class="fas fa-save"></i> Create Quiz
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add initial question
            addQuestion();
        }

        // Add a new question to the quiz
        function addQuestion() {
            const container = document.getElementById('questionsContainer');
            const questionNumber = container.children.length + 1;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item mb-4 p-3 border rounded';
            questionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6>Question ${questionNumber}</h6>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <textarea class="form-control question-text" rows="2" placeholder="Enter your question here..." required></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <div class="input-group">
                                <span class="input-group-text">A</span>
                                <input type="text" class="form-control option-a" placeholder="Option A" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="input-group">
                                <span class="input-group-text">B</span>
                                <input type="text" class="form-control option-b" placeholder="Option B" required>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <div class="input-group">
                                <span class="input-group-text">C</span>
                                <input type="text" class="form-control option-c" placeholder="Option C" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="input-group">
                                <span class="input-group-text">D</span>
                                <input type="text" class="form-control option-d" placeholder="Option D" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Correct Answer</label>
                    <select class="form-control correct-answer" required>
                        <option value="">Select correct answer</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control question-points" min="1" max="20" value="5">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Explanation (optional)</label>
                        <input type="text" class="form-control question-explanation" placeholder="Why is this the correct answer?">
                    </div>
                </div>
            `;
            
            container.appendChild(questionDiv);
        }

        // Remove a question from the quiz
        function removeQuestion(button) {
            if (document.getElementById('questionsContainer').children.length > 1) {
                button.closest('.question-item').remove();
                // Renumber questions
                renumberQuestions();
            } else {
                alert('You must have at least one question in your quiz.');
            }
        }

        // Renumber questions after deletion
        function renumberQuestions() {
            const questions = document.querySelectorAll('.question-item');
            questions.forEach((question, index) => {
                question.querySelector('h6').textContent = `Question ${index + 1}`;
            });
        }

        // Close quiz creation modal
        function closeQuizModal() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Preview quiz before saving
        function previewQuiz() {
            const questions = document.querySelectorAll('.question-item');
            if (questions.length < 3) {
                alert('Please add at least 3 questions to create a quiz.');
                return;
            }

            let preview = `Quiz Preview:\n\n`;
            preview += `Title: ${document.getElementById('quizTitle').value}\n`;
            preview += `Subject: ${document.getElementById('quizSubject').value}\n`;
            preview += `Time Limit: ${document.getElementById('timeLimit').value} minutes\n`;
            preview += `Total Points: ${document.getElementById('totalPoints').value}\n\n`;
            
            questions.forEach((question, index) => {
                preview += `Question ${index + 1}: ${question.querySelector('.question-text').value}\n`;
                preview += `A) ${question.querySelector('.option-a').value}\n`;
                preview += `B) ${question.querySelector('.option-b').value}\n`;
                preview += `C) ${question.querySelector('.option-c').value}\n`;
                preview += `D) ${question.querySelector('.option-d').value}\n`;
                preview += `Correct Answer: ${question.querySelector('.correct-answer').value}\n\n`;
            });
            
            alert(preview);
        }

        // Save quiz
        function saveQuiz() {
            const questions = document.querySelectorAll('.question-item');
            if (questions.length < 3) {
                alert('Please add at least 3 questions to create a quiz.');
                return;
            }

            // Validate all questions
            let isValid = true;
            questions.forEach((question, index) => {
                const text = question.querySelector('.question-text').value;
                const optionA = question.querySelector('.option-a').value;
                const optionB = question.querySelector('.option-b').value;
                const optionC = question.querySelector('.option-c').value;
                const optionD = question.querySelector('.option-d').value;
                const correct = question.querySelector('.correct-answer').value;
                
                if (!text || !optionA || !optionB || !optionC || !optionD || !correct) {
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields for each question.');
                return;
            }

            // Collect quiz data
            const quizData = {
                title: document.getElementById('quizTitle').value,
                subject: document.getElementById('quizSubject').value,
                timeLimit: parseInt(document.getElementById('timeLimit').value),
                totalPoints: parseInt(document.getElementById('totalPoints').value),
                difficulty: document.getElementById('difficulty').value,
                description: document.getElementById('quizDescription').value,
                questions: []
            };

            questions.forEach((question, index) => {
                quizData.questions.push({
                    number: index + 1,
                    text: question.querySelector('.question-text').value,
                    options: {
                        A: question.querySelector('.option-a').value,
                        B: question.querySelector('.option-b').value,
                        C: question.querySelector('.option-c').value,
                        D: question.querySelector('.option-d').value
                    },
                    correct: question.querySelector('.correct-answer').value,
                    points: parseInt(question.querySelector('.question-points').value),
                    explanation: question.querySelector('.question-explanation').value
                });
            });

            // Save quiz (in a real implementation, this would send to API)
            console.log('Quiz created:', quizData);
            alert(`Quiz "${quizData.title}" created successfully!\n\nQuestions: ${quizData.questions.length}\nTotal Points: ${quizData.totalPoints}\nTime Limit: ${quizData.timeLimit} minutes`);
            
            closeQuizModal();
        }

        // Analytics functionality
        let performanceChart = null;
        let currentChartView = 'overview';
        
        // Sample student data for analytics
        const sampleStudentData = [
            { id: 10, name: "Harry Potter", grade: "Grade 7", averageScore: 92, quizzesTaken: 8, lastActivity: "2 hours ago", trend: "improving", scores: [85, 88, 90, 92, 89, 94, 91, 95] },
            { id: 11, name: "Hermione Granger", grade: "Grade 7", averageScore: 98, quizzesTaken: 10, lastActivity: "1 hour ago", trend: "excellent", scores: [95, 97, 98, 99, 96, 100, 98, 99, 97, 100] },
            { id: 12, name: "Ron Weasley", grade: "Grade 7", averageScore: 78, quizzesTaken: 6, lastActivity: "3 hours ago", trend: "declining", scores: [82, 80, 75, 78, 76, 77] },
            { id: 13, name: "Neville Longbottom", grade: "Grade 7", averageScore: 85, quizzesTaken: 7, lastActivity: "5 hours ago", trend: "stable", scores: [83, 84, 85, 86, 84, 87, 86] },
            { id: 14, name: "Luna Lovegood", grade: "Grade 6", averageScore: 90, quizzesTaken: 9, lastActivity: "1 hour ago", trend: "improving", scores: [87, 88, 89, 91, 88, 92, 90, 91, 93] },
            { id: 15, name: "Ginny Weasley", grade: "Grade 6", averageScore: 88, quizzesTaken: 8, lastActivity: "2 hours ago", trend: "improving", scores: [85, 86, 87, 89, 87, 90, 88, 91] },
            { id: 16, name: "Draco Malfoy", grade: "Grade 7", averageScore: 82, quizzesTaken: 5, lastActivity: "4 hours ago", trend: "declining", scores: [85, 83, 81, 80, 82] },
            { id: 17, name: "Cedric Diggory", grade: "Grade 7", averageScore: 94, quizzesTaken: 9, lastActivity: "30 minutes ago", trend: "excellent", scores: [92, 93, 94, 95, 93, 96, 94, 95, 97] }
        ];

        // Simple analytics initialization
        function initializeAnalytics() {
            console.log('Analytics tab loaded successfully!');
        }

        // Simple analytics functions
        function populateAnalyticsTable() {
            console.log('Analytics table ready');
        }

        function initializePerformanceChart() {
            console.log('Charts ready');
        }

        function updateAnalyticsSummary() {
            console.log('Summary updated');
        }

        // Switch chart view
        function switchChartView(view) {
            currentChartView = view;
            
            // Update button states
            document.querySelectorAll('#analytics .btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            initializePerformanceChart();
        }

        // View individual student analytics
        function viewStudentAnalytics(studentId) {
            const student = sampleStudentData.find(s => s.id === studentId);
            if (!student) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Student Analytics - ${student.name}</h5>
                            <button type="button" class="btn-close" onclick="closeStudentAnalytics()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-primary">${student.averageScore}%</h5>
                                            <p class="card-text">Average Score</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-success">${student.quizzesTaken}</h5>
                                            <p class="card-text">Quizzes Taken</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="text-warning">${Math.max(...student.scores)}%</h5>
                                        <p class="card-text">Best Score</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-info">${Math.min(...student.scores)}%</h5>
                                            <p class="card-text">Lowest Score</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Performance Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="studentTrendChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Recent Quiz Scores</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Quiz #</th>
                                                            <th>Score</th>
                                                            <th>Date</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${student.scores.map((score, index) => `
                                                            <tr>
                                                                <td>Quiz ${index + 1}</td>
                                                                <td>
                                                                    <span class="badge ${getScoreBadgeClass(score)}">
                                                                        ${score}%
                                                                    </span>
                                                                </td>
                                                                <td>${getRandomDate()}</td>
                                                                <td>
                                                                    <span class="badge ${score >= 80 ? 'bg-success' : 'bg-warning'}">
                                                                        ${score >= 80 ? 'Passed' : 'Needs Improvement'}
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStudentAnalytics()">Close</button>
                            <button class="btn btn-primary" onclick="exportStudentReport(${student.id})">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize student trend chart
            setTimeout(() => {
                const ctx = document.getElementById('studentTrendChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: student.scores.map((_, index) => `Quiz ${index + 1}`),
                            datasets: [{
                                label: 'Score (%)',
                                data: student.scores,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${student.name}'s Performance Trend`
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Close student analytics modal
        function closeStudentAnalytics() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Export analytics data
        function exportAnalytics() {
            alert('Exporting analytics data...\n\nThis would generate a comprehensive report with all student performance data, charts, and insights.');
        }

        // Refresh analytics data
        function refreshAnalytics() {
            alert('Refreshing analytics data...\n\nThis would fetch the latest data from the database and update all charts and tables.');
        }

        // Export individual student report
        function exportStudentReport(studentId) {
            const student = sampleStudentData.find(s => s.id === studentId);
            alert(`Exporting detailed report for ${student.name}...\n\nThis would generate a PDF report with performance trends, quiz history, and recommendations.`);
        }

        // Update analytics summary cards
        function updateAnalyticsSummary() {
            console.log('Updating analytics summary...');
            // This will be implemented later
        }

        // Generate random date for quiz history
        function getRandomDate() {
            const dates = ['2024-10-15', '2024-10-12', '2024-10-08', '2024-10-05', '2024-10-01', '2024-09-28', '2024-09-25', '2024-09-22'];
            return dates[Math.floor(Math.random() * dates.length)];
        }

        // Initialize analytics when tab is clicked
        document.addEventListener('click', function(e) {
            if (e.target && (e.target.id === 'analytics-tab' || e.target.closest('#analytics-tab'))) {
                console.log('Analytics tab clicked');
                setTimeout(() => {
                    initializeAnalytics();
                }, 300);
            }
        });
        
        // Also listen for tab show events
        document.addEventListener('shown.bs.tab', function(e) {
            if (e.target && e.target.id === 'analytics-tab') {
                console.log('Analytics tab shown via Bootstrap event');
                setTimeout(() => {
                    initializeAnalytics();
                }, 100);
            }
        });
        
        // Add a manual trigger for analytics
        function triggerAnalytics() {
            console.log('Manually triggering analytics...');
            initializeAnalytics();
        }
        
        // Check if analytics tab is active and initialize
        function checkAndInitializeAnalytics() {
            const analyticsTab = document.getElementById('analytics-tab');
            const analyticsContent = document.getElementById('analytics');
            
            if (analyticsTab && analyticsContent) {
                if (analyticsTab.classList.contains('active') || analyticsContent.classList.contains('active')) {
                    console.log('Analytics tab is active, initializing...');
                    initializeAnalytics();
                }
            }
        }
        
        // Add a manual initialization function that can be called
        function showAnalytics() {
            console.log('Manual analytics initialization');
            
            // Switch to analytics tab
            const analyticsTab = document.getElementById('analytics-tab');
            if (analyticsTab) {
                analyticsTab.click();
            }
            
            // Initialize analytics after a short delay
            setTimeout(() => {
                initializeAnalytics();
            }, 200);
        }
        
        // Test function to debug analytics
        function testAnalytics() {
            console.log('Testing analytics...');
            console.log('Analytics tab exists:', !!document.getElementById('analytics-tab'));
            console.log('Analytics content exists:', !!document.getElementById('analytics'));
            console.log('Analytics table body exists:', !!document.getElementById('analyticsTableBody'));
            console.log('Performance chart exists:', !!document.getElementById('performanceChart'));
            
            // Check if analytics content is visible
            const analyticsContent = document.getElementById('analytics');
            if (analyticsContent) {
                console.log('Analytics content classes:', analyticsContent.className);
                console.log('Analytics content style display:', analyticsContent.style.display);
                console.log('Analytics content computed display:', window.getComputedStyle(analyticsContent).display);
                console.log('Analytics content offsetHeight:', analyticsContent.offsetHeight);
                console.log('Analytics content offsetWidth:', analyticsContent.offsetWidth);
            }
            
            // Test if we can populate the table
            const tbody = document.getElementById('analyticsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Test: Analytics is working!</td></tr>';
                console.log('Analytics table populated successfully');
            } else {
                console.error('Analytics table body not found');
            }
        }
        
        // Force initialize analytics
        function forceInitializeAnalytics() {
            console.log('Force initializing analytics...');
            try {
                populateAnalyticsTable();
                updateAnalyticsSummary();
                console.log('Force initialization completed');
            } catch (error) {
                console.error('Force initialization failed:', error);
            }
        }
        

        // Competition Storage and Management
        let competitions = JSON.parse(localStorage.getItem('competitions')) || [];
        
        function saveCompetitions() {
            localStorage.setItem('competitions', JSON.stringify(competitions));
        }
        
        function loadCompetitions() {
            competitions = JSON.parse(localStorage.getItem('competitions')) || [];
            return competitions;
        }
        
        // Competition Creation Functions
        function openCompetitionModal() {
            // Set default dates (start now, end in 7 days)
            const now = new Date();
            const endDate = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 days from now
            
            document.getElementById('startDate').value = now.toISOString().slice(0, 16);
            document.getElementById('endDate').value = endDate.toISOString().slice(0, 16);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('competitionCreationModal'));
            modal.show();
        }
        
        function createCompetition() {
            // Get form data
            const competitionData = {
                title: document.getElementById('competitionTitle').value,
                type: document.getElementById('competitionType').value,
                description: document.getElementById('competitionDescription').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                maxParticipants: parseInt(document.getElementById('maxParticipants').value),
                gradeLevel: document.getElementById('gradeLevel').value,
                scoringType: document.querySelector('input[name="scoringType"]:checked').value,
                allowRetries: document.getElementById('allowRetries').checked,
                showLeaderboard: document.getElementById('showLeaderboard').checked,
                prizeDescription: document.getElementById('prizeDescription').value,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString(),
                status: 'active',
                participants: 0
            };
            
            // Validate required fields
            if (!competitionData.title || !competitionData.type || !competitionData.startDate || !competitionData.endDate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Validate dates
            const startDate = new Date(competitionData.startDate);
            const endDate = new Date(competitionData.endDate);
            
            if (startDate >= endDate) {
                alert('End date must be after start date.');
                return;
            }
            
            if (startDate < new Date()) {
                alert('Start date cannot be in the past.');
                return;
            }
            
            // Add unique ID and save competition
            competitionData.id = Date.now().toString();
            competitions.push(competitionData);
            saveCompetitions();
            
            console.log('Competition created:', competitionData);
            
            // Show success message
            const competitionTypeNames = {
                'game': 'Educational Game',
                'speed': 'Speed Challenge', 
                'quiz': 'Quiz Competition',
                'reading': 'Reading Challenge',
                'math': 'Math Challenge',
                'science': 'Science Challenge'
            };
            
            alert(`🏆 Competition "${competitionData.title}" created successfully!\n\nType: ${competitionTypeNames[competitionData.type]}\nStart: ${new Date(competitionData.startDate).toLocaleDateString()}\nEnd: ${new Date(competitionData.endDate).toLocaleDateString()}\nMax Participants: ${competitionData.maxParticipants}`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('competitionCreationModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('competitionForm').reset();
            
            // Update competitions display
            setTimeout(() => {
                updateCompetitionsDisplay();
            }, 500);
        }
        
        function updateCompetitionsDisplay() {
            loadCompetitions();
            console.log('Updating competitions display, found:', competitions.length, 'competitions');
            
            // Update teacher dashboard competitions
            const teacherCompetitionsContainer = document.getElementById('teacherCompetitionsList');
            console.log('Teacher container found:', !!teacherCompetitionsContainer);
            if (teacherCompetitionsContainer) {
                displayTeacherCompetitions(teacherCompetitionsContainer);
            }
            
            // Update student dashboard competitions
            const studentCompetitionsContainer = document.getElementById('studentCompetitionsList');
            console.log('Student container found:', !!studentCompetitionsContainer);
            if (studentCompetitionsContainer) {
                displayStudentCompetitions(studentCompetitionsContainer);
            }
        }
        
        function displayTeacherCompetitions(container) {
            console.log('Displaying teacher competitions, total competitions:', competitions.length);
            
            const activeCompetitions = competitions.filter(comp => {
                const now = new Date();
                const startDate = new Date(comp.startDate);
                const endDate = new Date(comp.endDate);
                return startDate <= now && endDate >= now;
            });
            
            console.log('Active competitions found:', activeCompetitions.length);
            
            if (activeCompetitions.length === 0) {
                container.innerHTML = '<p class="text-muted">No active competitions. Create one to get started!</p>';
                return;
            }
            
            container.innerHTML = activeCompetitions.map(comp => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${comp.title}</h5>
                                <p class="card-text text-muted">${comp.description}</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> 
                                            ${new Date(comp.startDate).toLocaleDateString()} - ${new Date(comp.endDate).toLocaleDateString()}
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-users"></i> 
                                            ${comp.participants}/${comp.maxParticipants} participants
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-group-vertical">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewCompetitionDetails('${comp.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="viewCompetitionLeaderboard('${comp.id}')">
                                    <i class="fas fa-trophy"></i> Leaderboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayStudentCompetitions(container) {
            const now = new Date();
            const availableCompetitions = competitions.filter(comp => {
                const startDate = new Date(comp.startDate);
                const endDate = new Date(comp.endDate);
                return startDate <= now && endDate >= now && comp.participants < comp.maxParticipants;
            });
            
            if (availableCompetitions.length === 0) {
                container.innerHTML = '<p class="text-muted">No competitions available right now. Check back later!</p>';
                return;
            }
            
            container.innerHTML = availableCompetitions.map(comp => `
                <div class="card mb-3 competition-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${comp.title}</h5>
                                <p class="card-text">${comp.description}</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> 
                                            Ends: ${new Date(comp.endDate).toLocaleDateString()}
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-users"></i> 
                                            ${comp.participants}/${comp.maxParticipants} participants
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-star"></i> 
                                            ${comp.prizeDescription || 'Recognition'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="playCompetition('${comp.id}')">
                                    <i class="fas fa-play"></i> Play Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function viewCompetitionDetails(competitionId) {
            const comp = competitions.find(c => c.id === competitionId);
            if (!comp) return;
            
            alert(`Competition Details:\n\nTitle: ${comp.title}\nType: ${comp.type}\nDescription: ${comp.description}\nParticipants: ${comp.participants}/${comp.maxParticipants}\nScoring: ${comp.scoringType}\nPrize: ${comp.prizeDescription || 'Recognition'}`);
        }
        
        function viewCompetitionLeaderboard(competitionId) {
            const comp = competitions.find(c => c.id === competitionId);
            if (!comp) return;
            
            alert(`Leaderboard for "${comp.title}"\n\nThis would show the current rankings for this competition.`);
        }
        
        function playCompetition(competitionId) {
            const comp = competitions.find(c => c.id === competitionId);
            if (!comp) return;
            
            // Increment participant count
            comp.participants++;
            saveCompetitions();
            
            // Show competition interface based on type
            showCompetitionInterface(comp);
        }
        
        function showCompetitionInterface(competition) {
            // Create competition modal
            const modalHtml = `
                <div class="modal fade" id="competitionPlayModal" tabindex="-1" aria-labelledby="competitionPlayModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="competitionPlayModalLabel">🏆 ${competition.title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center mb-4">
                                    <h4>${competition.description}</h4>
                                    <p class="text-muted">Type: ${competition.type} | Scoring: ${competition.scoringType}</p>
                                </div>
                                
                                <div id="competitionContent">
                                    ${getCompetitionContent(competition)}
                                </div>
                                
                                <div class="mt-4 text-center">
                                    <button class="btn btn-success btn-lg" onclick="submitCompetitionEntry('${competition.id}')">
                                        <i class="fas fa-flag-checkered"></i> Submit Entry
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('competitionPlayModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('competitionPlayModal'));
            modal.show();
        }
        
        function getCompetitionContent(competition) {
            switch(competition.type) {
                case 'math':
                    return `
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Math Problems</h5>
                                <div class="problem">
                                    <p>1. What is 15 × 8?</p>
                                    <input type="number" class="form-control" id="answer1" placeholder="Your answer">
                                </div>
                                <div class="problem">
                                    <p>2. Solve: 3x + 7 = 22</p>
                                    <input type="number" class="form-control" id="answer2" placeholder="Your answer">
                                </div>
                                <div class="problem">
                                    <p>3. What is 144 ÷ 12?</p>
                                    <input type="number" class="form-control" id="answer3" placeholder="Your answer">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Timer</h5>
                                <div class="timer-display">
                                    <h2 id="timer">00:00</h2>
                                </div>
                                <p class="text-muted">Complete all problems as quickly as possible!</p>
                            </div>
                        </div>
                    `;
                case 'quiz':
                    return `
                        <div class="quiz-container">
                            <h5>Knowledge Quiz</h5>
                            <div class="question">
                                <p>1. What is the capital of France?</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1a" value="a">
                                    <label class="form-check-label" for="q1a">Paris</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1b" value="b">
                                    <label class="form-check-label" for="q1b">London</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1c" value="c">
                                    <label class="form-check-label" for="q1c">Berlin</label>
                                </div>
                            </div>
                        </div>
                    `;
                default:
                    return `
                        <div class="text-center">
                            <h5>Competition Content</h5>
                            <p>This is a ${competition.type} competition.</p>
                            <p>Complete the challenge to earn points!</p>
                        </div>
                    `;
            }
        }
        
        function submitCompetitionEntry(competitionId) {
            const comp = competitions.find(c => c.id === competitionId);
            if (!comp) return;
            
            // Calculate score based on competition type
            let score = Math.floor(Math.random() * 100) + 1; // Simulated score
            
            alert(`🏆 Competition Entry Submitted!\n\nYour Score: ${score} points\n\nGood job! Your score has been recorded.`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('competitionPlayModal'));
            modal.hide();
            
            // Update display
            updateCompetitionsDisplay();
        }
        
        function createTestCompetition() {
            const testCompetition = {
                id: Date.now().toString(),
                title: "Test Math Challenge",
                type: "math",
                description: "A test competition to verify the system works",
                startDate: new Date().toISOString(),
                endDate: new Date(Date.now() + (7 * 24 * 60 * 60 * 1000)).toISOString(),
                maxParticipants: 50,
                gradeLevel: "all",
                scoringType: "points",
                allowRetries: true,
                showLeaderboard: true,
                prizeDescription: "Test recognition",
                createdBy: currentUser ? currentUser.name : "Test Teacher",
                createdAt: new Date().toISOString(),
                status: "active",
                participants: 0
            };
            
            competitions.push(testCompetition);
            saveCompetitions();
            
            console.log('Test competition created:', testCompetition);
            alert('Test competition created! Check the competitions list.');
            
            updateCompetitionsDisplay();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initializeTheme();
            await loadSavedUserData(); // Load saved user data first
            // updateStarsDisplay() and updateGameAvailability() are now called within loadSavedUserData()
            // after the user data is fully loaded and synced with the database
            
            // Load competitions
            updateCompetitionsDisplay();
        });
    </script>

    <!-- Competition Creation Modal -->
    <div class="modal fade" id="competitionCreationModal" tabindex="-1" aria-labelledby="competitionCreationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="competitionCreationModalLabel">🏆 Create New Competition</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="competitionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="competitionTitle" class="form-label">Competition Title</label>
                                    <input type="text" class="form-control" id="competitionTitle" placeholder="e.g., Math Speed Challenge" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="competitionType" class="form-label">Competition Type</label>
                                    <select class="form-select" id="competitionType" required>
                                        <option value="">Select Type</option>
                                        <option value="game">🎮 Educational Game</option>
                                        <option value="speed">⚡ Speed Challenge</option>
                                        <option value="quiz">📝 Quiz Competition</option>
                                        <option value="reading">📚 Reading Challenge</option>
                                        <option value="math">🔢 Math Challenge</option>
                                        <option value="science">🧪 Science Challenge</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="competitionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="competitionDescription" rows="3" placeholder="Describe the competition rules and objectives..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="datetime-local" class="form-control" id="startDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="datetime-local" class="form-control" id="endDate" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxParticipants" class="form-label">Max Participants</label>
                                    <input type="number" class="form-control" id="maxParticipants" min="1" max="100" value="50">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gradeLevel" class="form-label">Grade Level</label>
                                    <select class="form-select" id="gradeLevel">
                                        <option value="all">All Grades</option>
                                        <option value="6">Grade 6</option>
                                        <option value="7">Grade 7</option>
                                        <option value="8">Grade 8</option>
                                        <option value="9">Grade 9</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Scoring System</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scoringType" id="pointsScoring" value="points" checked>
                                <label class="form-check-label" for="pointsScoring">
                                    Points-based (highest score wins)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scoringType" id="timeScoring" value="time">
                                <label class="form-check-label" for="timeScoring">
                                    Time-based (fastest time wins)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scoringType" id="accuracyScoring" value="accuracy">
                                <label class="form-check-label" for="accuracyScoring">
                                    Accuracy-based (highest percentage wins)
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowRetries" checked>
                                <label class="form-check-label" for="allowRetries">
                                    Allow students to retry (multiple attempts)
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showLeaderboard" checked>
                                <label class="form-check-label" for="showLeaderboard">
                                    Show live leaderboard to students
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="prizeDescription" class="form-label">Prize/Recognition</label>
                            <input type="text" class="form-control" id="prizeDescription" placeholder="e.g., Extra credit, Certificate, Special recognition">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCompetition()">
                        <i class="fas fa-trophy"></i> Create Competition
                    </button>
                </div>
            </div>
        </div>
    </div>

  </body>
</html>
