<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestReady Fridays</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Universal Menu -->
    <div id="universalMenu" class="universal-menu" style="display: none;">
        <div class="menu-toggle" onclick="toggleUniversalMenu()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="menu-content">
            <div class="menu-header">
                <h5><i class="fas fa-user"></i> Menu</h5>
                <button class="btn-close" onclick="toggleUniversalMenu()"></button>
            </div>
            <div class="menu-body">
                <div class="menu-item" onclick="viewProfile()">
                    <i class="fas fa-user-circle"></i>
                    <span>View Profile</span>
                </div>
                <div class="menu-item" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                    <span id="themeText">Dark Mode</span>
                </div>
                <div class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </div>
            </div>
        </div>
    </div>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .login-container {
            min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .logo {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .login-title {
            color: #333;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .role-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .role-btn {
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #666;
        }
        
        .role-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }
        
        .role-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        
        /* Universal Menu Styles */
        .universal-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        
        .menu-toggle {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-toggle:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        
        .menu-content {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .universal-menu.show .menu-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .menu-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h5 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .menu-header .btn-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
        }
        
        .menu-body {
            padding: 10px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.2s ease;
            color: #333;
        }
        
        .menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            color: #666;
        }
        
        .menu-item span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Dark mode styles for universal menu */
        body.dark-mode .menu-content {
            background: #2d3748;
            color: white;
        }
        
        body.dark-mode .menu-header {
            border-bottom-color: #4a5568;
        }
        
        body.dark-mode .menu-header h5 {
            color: white;
        }
        
        body.dark-mode .menu-item {
            color: white;
        }
        
        body.dark-mode .menu-item:hover {
            background-color: #4a5568;
        }
        
        body.dark-mode .menu-item i {
            color: #a0aec0;
        }
        
        .dashboard {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stars-display {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            color: #333;
            font-size: 1.2rem;
        }
        
        .content-tabs {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            border-bottom: 3px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: bold;
            padding: 15px 25px;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .learning-modules {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .module-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }
        
        .module-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .module-card.locked {
            opacity: 0.5;
            background: #f8f9fa;
            border-color: #dee2e6;
            cursor: not-allowed;
        }
        
        .module-card.locked .module-title::after {
            content: " (Locked)";
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .module-card.locked .module-actions button {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .module-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }
        
        .module-stars {
            background: #ffd700;
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .module-description {
            color: #666;
            margin-bottom: 20px;
        }
        
        .module-progress {
            margin-bottom: 15px;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .module-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            border-radius: 25px;
            font-weight: bold;
            padding: 8px 20px;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .game-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }
        
        .game-card.locked {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .game-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .game-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .game-cost {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .game-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            color: white;
            text-decoration: none;
        }
        
        .play-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Test Interface Styles */
        .modal {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .question-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .options-container {
            display: grid;
            gap: 10px;
        }
        
        .option-btn {
            text-align: left;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .list-group-numbered > li {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .alert {
            border-radius: 8px;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-light {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #e9ecef;
            color: #495057;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
        }
        
        body.dark-mode .login-card {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            border: 1px solid #444444;
        }
        
        body.dark-mode .dashboard-container {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
        }
        
        body.dark-mode .dashboard-header {
            background: rgba(40, 40, 40, 0.95);
            color: #ffffff;
            border-bottom: 2px solid #555555;
        }
        
        body.dark-mode .content-tabs {
            background: rgba(40, 40, 40, 0.95);
            color: #ffffff;
        }
        
        body.dark-mode .module-card {
            background: rgba(45, 45, 45, 0.9);
            color: #ffffff;
            border: 2px solid #666666;
        }
        
        body.dark-mode .module-card:hover {
            border-color: #007bff;
            background: rgba(55, 55, 55, 0.9);
        }
        
        body.dark-mode .module-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #ffffff;
        }
        
        body.dark-mode .game-card {
            background: rgba(45, 45, 45, 0.9);
            color: #ffffff;
            border: 2px solid #666666;
        }
        
        body.dark-mode .game-card:hover {
            border-color: #007bff;
            background: rgba(55, 55, 55, 0.9);
        }
        
        body.dark-mode .game-card.locked {
            background: rgba(35, 35, 35, 0.7);
            opacity: 0.7;
            border-color: #444444;
        }
        
        body.dark-mode .form-control {
            background: rgba(50, 50, 50, 0.9);
            border: 2px solid #666666;
            color: #ffffff;
        }
        
        body.dark-mode .form-control:focus {
            background: rgba(60, 60, 60, 0.9);
            border-color: #007bff;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        body.dark-mode .nav-tabs .nav-link {
            color: #cccccc;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555555;
        }
        
        body.dark-mode .nav-tabs .nav-link:hover {
            background: rgba(60, 60, 60, 0.9);
            color: #ffffff;
            border-color: #777777;
        }
        
        body.dark-mode .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: #ffffff;
            border-color: #007bff;
        }
        
        body.dark-mode .modal-content {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            border: 2px solid #555555;
        }
        
        body.dark-mode .modal-header {
            border-bottom: 2px solid #555555;
            background: rgba(40, 40, 40, 0.9);
        }
        
        body.dark-mode .modal-footer {
            border-top: 2px solid #555555;
            background: rgba(40, 40, 40, 0.9);
        }
        
        body.dark-mode .list-group-item {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid #666666;
            color: #ffffff;
        }
        
        body.dark-mode .alert-info {
            background: linear-gradient(135deg, #0d4f8c 0%, #1e5f99 100%);
            border: 2px solid #007bff;
            color: #ffffff;
        }
        
        body.dark-mode .alert-warning {
            background: linear-gradient(135deg, #8b5a00 0%, #b8860b 100%);
            border: 2px solid #ffc107;
            color: #ffffff;
        }
        
        body.dark-mode .alert-light {
            background: linear-gradient(135deg, #404040 0%, #505050 100%);
            border: 2px solid #666666;
            color: #ffffff;
        }
        
        /* Additional dark mode improvements */
        body.dark-mode .table {
            color: #ffffff;
        }
        
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: rgba(60, 60, 60, 0.5);
        }
        
        body.dark-mode .table-hover > tbody > tr:hover > td {
            background-color: rgba(80, 80, 80, 0.7);
        }
        
        body.dark-mode .card {
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #555555;
            color: #ffffff;
        }
        
        body.dark-mode .card-header {
            background: rgba(50, 50, 50, 0.9);
            border-bottom: 2px solid #666666;
        }
        
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: 2px solid #007bff;
        }
        
        body.dark-mode .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            border: 2px solid #6c757d;
            color: #ffffff;
        }
        
        /* Ensure all text is light in dark mode */
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5,
        body.dark-mode h6 {
            color: #ffffff !important;
        }
        
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode div,
        body.dark-mode label {
            color: #ffffff !important;
        }
        
        body.dark-mode .text-muted {
            color: #cccccc !important;
        }
        
        body.dark-mode .text-secondary {
            color: #cccccc !important;
        }
        
        body.dark-mode .badge {
            color: #ffffff !important;
        }
        
        body.dark-mode .small {
            color: #cccccc !important;
        }
        
        body.dark-mode .form-label {
            color: #ffffff !important;
        }
        
        body.dark-mode .form-text {
            color: #cccccc !important;
        }
        
        body.dark-mode .dropdown-menu {
            background: rgba(40, 40, 40, 0.95);
            border: 2px solid #555555;
        }
        
        body.dark-mode .dropdown-item {
            color: #ffffff !important;
        }
        
        body.dark-mode .dropdown-item:hover {
            background: rgba(60, 60, 60, 0.9);
            color: #ffffff !important;
        }
        
        /* Classroom code styling */
        .classroom-code-section {
            background: rgba(248, 249, 250, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .classroom-code {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: bold;
            color: #495057;
        }
        
        body.dark-mode .classroom-code-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.dark-mode .classroom-code {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
        
        /* Bootstrap utility classes for dark mode */
        body.dark-mode .text-primary {
            color: #80b3ff !important;
        }
        
        body.dark-mode .text-success {
            color: #90ee90 !important;
        }
        
        body.dark-mode .text-warning {
            color: #ffd700 !important;
        }
        
        body.dark-mode .text-danger {
            color: #ff6b6b !important;
        }
        
        body.dark-mode .text-info {
            color: #87ceeb !important;
        }
        
        body.dark-mode .text-light {
            color: #ffffff !important;
        }
        
        body.dark-mode .text-dark {
            color: #ffffff !important;
        }
        
        body.dark-mode a {
            color: #80b3ff !important;
        }
        
        body.dark-mode a:hover {
            color: #a0c4ff !important;
        }
        
        /* Admin table specific styling */
        body.dark-mode .table th {
            background-color: rgba(40, 40, 40, 0.9) !important;
            color: #ffffff !important;
            border-color: #555555 !important;
        }
        
        body.dark-mode .table td {
            color: #ffffff !important;
            border-color: #555555 !important;
        }
        
        body.dark-mode .table thead th {
            background-color: rgba(30, 30, 30, 0.95) !important;
            color: #ffffff !important;
            font-weight: bold;
        }
        
    </style>
</head>
<body>
    
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 class="login-title">TestReady Fridays</h1>
            <p class="text-muted mb-4">Sign in with your ID or email</p>

            <!-- Universal Login Form -->
            <div id="universalLogin" class="login-form active">
                <h3>Sign In</h3>
                <form onsubmit="loginAuto(event)">
                    <div class="form-group">
                        <label class="form-label">ID or Email</label>
                        <input type="text" class="form-control" id="loginId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
            </div>

            <!-- Hide old role selection UI -->
            <div class="role-buttons" style="display:none;">
                <button class="role-btn" onclick="selectRole('student')">
                    <i class="fas fa-user-graduate"></i><br>
                    Student
                </button>
                <button class="role-btn" onclick="selectRole('teacher')">
                    <i class="fas fa-chalkboard-teacher"></i><br>
                    Teacher
                </button>
                <button class="role-btn" onclick="selectRole('admin')">
                    <i class="fas fa-user-shield"></i><br>
                    Admin
                </button>
            </div>
            
            <div class="text-center mt-3">
                <small class="text-muted">Don't have an account? <a href="#" onclick="showRegistration()" class="text-primary">Register here</a></small>
                    </div>
            
            <!-- Student Login Form (hidden) -->
            <div id="studentForm" class="login-form" style="display:none;">
                <h3>Student Login</h3>
                <form onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="studentId" required>
                  </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="studentPassword" required>
                </div>
                    <button type="submit" class="login-btn">Login as Student</button>
                </form>
              </div>
            
            <!-- Student Registration Form -->
            <div id="studentRegistration" class="login-form">
                <h3>Student Registration</h3>
                <form onsubmit="register('student', event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="regStudentName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="regStudentId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grade Level</label>
                        <select class="form-control" id="regStudentGrade" required>
                            <option value="">Select your grade</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="regStudentPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="regStudentConfirmPassword" required>
                    </div>
                    <button type="submit" class="login-btn">Register as Student</button>
                    <button type="button" class="btn btn-secondary mt-2" onclick="showLogin()">Back to Login</button>
                </form>
            </div>
            
            <!-- Teacher Login Form (hidden) -->
            <div id="teacherForm" class="login-form" style="display:none;">
                <h3>Teacher Login</h3>
                <form onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">Teacher ID</label>
                        <input type="text" class="form-control" id="teacherId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="teacherPassword" required>
                    </div>
                    <button type="submit" class="login-btn">Login as Teacher</button>
                </form>
            </div>
            
            <!-- Admin Login Form (hidden) -->
            <div id="adminForm" class="login-form" style="display:none;">
                <h3>Admin Login</h3>
                <form onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">Admin ID</label>
                        <input type="text" class="form-control" id="adminId" required>
          </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="adminPassword" required>
          </div>
                    <button type="submit" class="login-btn">Login as Admin</button>
                </form>
        </div>
      </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        
        <div class="dashboard-header">
            <div class="user-info">
                <div>
                    <h2><i class="fas fa-user-shield"></i> Admin Dashboard</h2>
                    <p>Welcome back, <span id="adminName">Admin</span>!</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="testSync()" title="Test Sync">
                        <i class="fas fa-sync-alt"></i> Test Sync
                    </button>
                </div>
            </div>
        </div>
        
        <div class="content-tabs">
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                        <i class="fas fa-users"></i> All Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="adminTabContent">
                <!-- Users Tab -->
                <div class="tab-pane fade show active" id="users" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3><i class="fas fa-users"></i> All Users</h3>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadAllUsers()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Grade</th>
                                    <th>Stars</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3><i class="fas fa-chart-bar"></i> System Analytics</h3>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadAnalytics()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4" id="statsCards">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Users</h5>
                                    <h2 id="totalUsers">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Students</h5>
                                    <h2 id="totalStudents">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Teachers</h5>
                                    <h2 id="totalTeachers">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Stars</h5>
                                    <h2 id="totalStars">-</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>User Roles Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="roleChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Student Grade Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="gradeChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <h3><i class="fas fa-cog"></i> System Settings</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>System Health</h5>
                                </div>
                                <div class="card-body">
                                    <p><i class="fas fa-check-circle text-success"></i> Database: Connected</p>
                                    <p><i class="fas fa-check-circle text-success"></i> API: Online</p>
                                    <p><i class="fas fa-check-circle text-success"></i> All systems operational</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>System Information</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Version:</strong> 1.0.0</p>
                                    <p><strong>Database:</strong> SQLite</p>
                                    <p><strong>API Status:</strong> <span class="badge bg-success">Online</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="dashboard">
        
        <div class="dashboard-header">
            <div class="user-info">
                <div>
                    <h2><i class="fas fa-chalkboard-teacher"></i> Teacher Dashboard</h2>
                    <p>Welcome back, <span id="teacherName">Teacher</span>!</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="testSync()" title="Test Sync">
                        <i class="fas fa-sync-alt"></i> Test Sync
                    </button>
                </div>
            </div>
        </div>
        
        <div class="content-tabs">
            <ul class="nav nav-tabs" id="teacherTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="classrooms-tab" data-bs-toggle="tab" data-bs-target="#classrooms" type="button" role="tab">
                        <i class="fas fa-chalkboard"></i> My Classrooms
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab">
                        <i class="fas fa-plus"></i> Create Content
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="competitions-tab" data-bs-toggle="tab" data-bs-target="#competitions" type="button" role="tab">
                        <i class="fas fa-trophy"></i> Competitions
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="teacherTabContent">
                <!-- Classrooms Tab -->
                <div class="tab-pane fade show active" id="classrooms" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>My Classrooms</h3>
                        <button class="btn btn-primary" onclick="showCreateClassroomModal()">
                            <i class="fas fa-plus"></i> Create New Classroom
                        </button>
                    </div>
                      <div class="row">
                        <div class="col-md-6">
                            <div class="module-card">
                                <h4>Grade 7 Math - Room 101</h4>
                                <p>Students: 24 | Active: 18</p>
                                <div class="classroom-code-section mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="text-muted">Classroom Code:</span>
                                        <div class="d-flex align-items-center">
                                            <code class="classroom-code me-2" id="math7Code">MATH7-ABC123</code>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="copyClassroomCode('MATH7-ABC123')" title="Copy Code">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="regenerateClassroomCode('math7')" title="Generate New Code">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="viewClassroom('math7')">View Students</button>
                                    <button class="btn btn-success" onclick="createQuiz('math7')">Create Quiz</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="module-card">
                                <h4>Grade 8 Science - Room 203</h4>
                                <p>Students: 22 | Active: 20</p>
                                <div class="classroom-code-section mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="text-muted">Classroom Code:</span>
                                        <div class="d-flex align-items-center">
                                            <code class="classroom-code me-2" id="science8Code">SCI8-XYZ789</code>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="copyClassroomCode('SCI8-XYZ789')" title="Copy Code">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="regenerateClassroomCode('science8')" title="Generate New Code">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="viewClassroom('science8')">View Students</button>
                                    <button class="btn btn-success" onclick="createQuiz('science8')">Create Quiz</button>
                        </div>
                      </div>
                        </div>
                      </div>
                </div>
                
                <!-- Create Content Tab -->
                <div class="tab-pane fade" id="create" role="tabpanel">
                    <h3>Create Content</h3>
                      <div class="row">
                        <div class="col-md-4">
                            <div class="game-card">
                                <div class="game-icon text-primary">📝</div>
                                <div class="game-title">Create Quiz</div>
                                <div class="game-description">Create custom quizzes for your students</div>
                                <button class="play-btn" onclick="createQuiz()">Create Quiz</button>
                        </div>
                      </div>
                        <div class="col-md-4">
                            <div class="game-card">
                                <div class="game-icon text-success">🏆</div>
                                <div class="game-title">Start Competition</div>
                                <div class="game-description">Create engaging competitions</div>
                                <button class="play-btn" onclick="createCompetition()">Start Competition</button>
                        </div>
                      </div>
                        <div class="col-md-4">
                            <div class="game-card">
                                <div class="game-icon text-warning">📊</div>
                                <div class="game-title">View Analytics</div>
                                <div class="game-description">Track student progress and performance</div>
                                <button class="play-btn" onclick="viewAnalytics()">View Analytics</button>
                    </div>
                    </div>
                  </div>
                </div>
                
                <!-- Competitions Tab -->
                <div class="tab-pane fade" id="competitions" role="tabpanel">
                    <h3>Active Competitions</h3>
                    <div class="module-card">
                        <h4>Math Speed Challenge</h4>
                        <p>Ends in 2 days | 15 participants</p>
                        <div class="btn-group">
                            <button class="btn btn-primary">View Leaderboard</button>
                            <button class="btn btn-warning">Edit Competition</button>
              </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="dashboard">
        
        <div class="dashboard-header">
            <div class="user-info">
                <div>
                    <h2><i class="fas fa-user-graduate"></i> Student Dashboard</h2>
                    <p>Welcome back, <span id="studentName">Student</span>!</p>
                </div>
                <div class="stars-display">
                    <i class="fas fa-star"></i> <span id="studentStars">50</span> Stars
                    <small class="text-muted ms-2" id="syncStatus" style="display: none;">
                        <i class="fas fa-sync-alt fa-spin"></i> Syncing...
                    </small>
                </div>
            </div>
        </div>
        
        <div class="content-tabs">
            <ul class="nav nav-tabs" id="studentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning" type="button" role="tab">
                        <i class="fas fa-book"></i> Learning Modules
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="games-tab" data-bs-toggle="tab" data-bs-target="#games" type="button" role="tab">
                        <i class="fas fa-gamepad"></i> Games
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button" role="tab">
                        <i class="fas fa-chart-line"></i> Progress
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="studentTabContent">
                <!-- Learning Tab -->
                <div class="tab-pane fade show active" id="learning" role="tabpanel">
                    <h3>Learning Modules</h3>
                    <p>Complete modules to earn stars and unlock games!</p>
                    
                    <!-- Classroom Section -->
                    <div class="module-card mb-4">
                        <div class="module-header">
                            <div class="module-title">Join Classroom</div>
                            <div class="module-stars">+5 ⭐</div>
                  </div>
                        <div class="module-description">
                            Join your teacher's classroom to access custom quizzes and competitions!
                  </div>
                        <div class="module-actions">
                            <button class="btn btn-primary" onclick="showJoinClassroom()">Join Classroom</button>
                </div>
              </div>
              
                    <div class="learning-modules">
                        <div class="module-card" id="module1">
                            <div class="module-header">
                                <div class="module-title">Grade 3 Math Test Prep</div>
                                <div class="module-stars">+10 ⭐</div>
                    </div>
                            <div class="module-description">
                                Master addition, subtraction, multiplication, and division for state testing. Includes practice problems and test strategies.
                            </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <small>Progress: <span id="module1Progress">0</span>%</small>
                            </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module1')">Start Test Prep</button>
                    </div>
                  </div>
                  
                        <div class="module-card" id="module2">
                            <div class="module-header">
                                <div class="module-title">Grade 4 Math Practice</div>
                                <div class="module-stars">+12 ⭐</div>
            </div>
                            <div class="module-description">
                                Fractions, decimals, geometry, and measurement for standardized tests. Practice with real test questions.
              </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                   </div>
                                <small>Progress: <span id="module2Progress">0</span>%</small>
                 </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module2')">Start Test Prep</button>
                 </div>
               </div>
                        
                        <div class="module-card" id="module3">
                            <div class="module-header">
                                <div class="module-title">Grade 7 Writing Practice</div>
                                <div class="module-stars">+15 ⭐</div>
                      </div>
                            <div class="module-description">
                                Argumentative essay writing with rubric-based scoring. Practice with real writing prompts and feedback.
                            </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <small>Progress: <span id="module3Progress">0</span>%</small>
                            </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module3')">Start Test Prep</button>
                    </div>
                  </div>
                  
                        <div class="module-card" id="module4">
                            <div class="module-header">
                                <div class="module-title">Grade 8 Algebra Prep</div>
                                <div class="module-stars">+18 ⭐</div>
            </div>
                            <div class="module-description">
                                Linear equations, slope, and algebraic reasoning for high school readiness tests.
              </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                      </div>
                                <small>Progress: <span id="module4Progress">0</span>%</small>
                    </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module4')">Start Test Prep</button>
                  </div>
                </div>
                
                        <div class="module-card" id="module5">
                            <div class="module-header">
                                <div class="module-title">Test-Taking Strategies</div>
                                <div class="module-stars">+8 ⭐</div>
                    </div>
                            <div class="module-description">
                                Master general test strategies, time management, and anxiety reduction techniques.
                            </div>
                            <div class="module-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <small>Progress: <span id="module5Progress">0</span>%</small>
                            </div>
                            <div class="module-actions">
                                <button class="btn btn-primary" onclick="startModule('module5')">Start Learning</button>
                            </div>
                        </div>
                    </div>
                  </div>
                  
                <!-- Games Tab -->
                <div class="tab-pane fade" id="games" role="tabpanel">
                    <h3>Games</h3>
                    <p>Spend stars to play games and have fun!</p>
                    
                    <div class="games-grid">
                        <div class="game-card" id="flappyGameCard">
                            <div class="game-icon text-warning">🎮</div>
                            <div class="game-title">Flappy Bird</div>
                            <div class="game-cost">Cost: 10 ⭐</div>
                            <div class="game-description">Test your reflexes and timing!</div>
                            <button class="play-btn" onclick="playGame('flappy')" id="flappyBtn">Play Game</button>
                    </div>
                        
                        <div class="game-card" id="snakesGameCard">
                            <div class="game-icon text-success">🐍</div>
                            <div class="game-title">Snakes</div>
                            <div class="game-cost">Cost: 15 ⭐</div>
                            <div class="game-description">Control the snake and grow longer!</div>
                            <button class="play-btn" onclick="playGame('snakes')" id="snakesBtn">Play Game</button>
                        </div>
                        
                        <div class="game-card" id="memoryGameCard">
                            <div class="game-icon text-danger">🧠</div>
                            <div class="game-title">Memory Game</div>
                            <div class="game-cost">Cost: 12 ⭐</div>
                            <div class="game-description">Challenge your memory skills!</div>
                            <button class="play-btn" onclick="playGame('memory')" id="memoryBtn">Play Game</button>
                        </div>
                    </div>
                  </div>
                  
                <!-- Progress Tab -->
                <div class="tab-pane fade" id="progress" role="tabpanel">
                    <h3>Your Progress</h3>
                    <p>Track your learning journey and achievements.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="module-card">
                                <h4>Total Stars Earned</h4>
                                <div class="stars-display" style="font-size: 2rem;">
                                    <i class="fas fa-star"></i> <span id="totalStars">50</span>
                    </div>
                      </div>
                    </div>
                        <div class="col-md-6">
                            <div class="module-card">
                                <h4>Modules Completed</h4>
                                <div class="text-success" style="font-size: 2rem;">
                                    <i class="fas fa-trophy"></i> <span id="completedModules">0</span>
                  </div>
                </div>
              </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let userStars = 0;
        let userGrade = null;
        let moduleProgress = {
            module1: 0,
            module2: 0,
            module3: 0,
            module4: 0,
            module5: 0
        };
        let completedModules = 0;
        
        // Theme management
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        // Load saved user data from localStorage and sync with database
        async function loadSavedUserData() {
            const savedUser = localStorage.getItem('currentUser');
            const savedStars = localStorage.getItem('userStars');
            const savedGrade = localStorage.getItem('userGrade');
            
            console.log('Loading saved user data:', {
                hasUser: !!savedUser,
                savedStars: savedStars,
                savedGrade: savedGrade
            });
            
            if (savedUser && savedStars && savedGrade) {
                try {
                    currentUser = JSON.parse(savedUser);
                    userGrade = savedGrade;
                    userStars = parseInt(savedStars) || 0; // Set userStars from localStorage
                    
                    console.log('Loaded from localStorage:', {
                        user: `${currentUser.firstName} ${currentUser.lastName}`,
                        stars: userStars,
                        grade: userGrade
                    });
                    
                    // Sync with database to get latest data
                    await syncWithDatabase();
                    
                    // Start periodic sync with database
                    startPeriodicSync();
                    
                    // If user is logged in, show appropriate dashboard
                    if (currentUser.role === 'student') {
                        showStudentDashboard();
                    } else if (currentUser.role === 'teacher') {
                        showTeacherDashboard();
                    } else if (currentUser.role === 'admin') {
                        showAdminDashboard();
                    }
                } catch (error) {
                    console.error('Error loading saved user data:', error);
                    clearSavedUserData();
                }
            } else {
                console.log('No saved user data found, showing login page');
            }
        }
        
        // Sync user data with database
        async function syncWithDatabase() {
            if (!currentUser) {
                console.log('No current user, skipping sync');
                return;
            }
            
            try {
                console.log('Starting sync with database...');
                console.log('Current local stars:', userStars);
                console.log('Current user ID:', currentUser.id);
                
                // First, get latest user data from database
                console.log('Fetching latest data from database...');
                const latestUser = await apiCall(`users/${currentUser.id}`);
                
                if (latestUser) {
                    console.log('Database user data:', {
                        id: latestUser.id,
                        firstName: latestUser.firstName,
                        lastName: latestUser.lastName,
                        stars: latestUser.stars,
                        completedModules: latestUser.completedModules,
                        gamesPlayed: latestUser.gamesPlayed
                    });
                    
                    // Update local variables with database values
                    const oldStars = userStars;
                    userStars = latestUser.stars;
                    currentUser.stars = latestUser.stars;
                    currentUser.completedModules = latestUser.completedModules;
                    currentUser.completedQuizzes = latestUser.completedQuizzes;
                    currentUser.gamesPlayed = latestUser.gamesPlayed;
                    currentUser.recentActivity = latestUser.recentActivity;
                    
                    // Save updated data to localStorage
                    saveUserData();
                    
                    console.log('Sync completed:', {
                        user: `${currentUser.firstName} ${currentUser.lastName}`,
                        oldStars: oldStars,
                        newStars: userStars,
                        completedModules: currentUser.completedModules,
                        gamesPlayed: currentUser.gamesPlayed
                    });
                } else {
                    console.log('No user data received from database');
                }
            } catch (error) {
                console.error('Failed to sync with database:', error);
                // Fallback to localStorage data
                const localStars = parseInt(localStorage.getItem('userStars')) || 0;
                console.log('Falling back to localStorage stars:', localStars);
                userStars = localStars;
            }
        }
        
        // Save current state to database
        async function saveToDatabase() {
            if (!currentUser) {
                console.log('No current user, cannot save to database');
                return;
            }
            
            try {
                // Ensure we have the correct data format for the User model
                const dataToSave = {
                    id: currentUser.id,
                    email: currentUser.email,
                    password: currentUser.password,
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    grade: currentUser.grade,
                    role: currentUser.role,
                    stars: userStars,
                    completedModules: currentUser.completedModules || '[]',
                    completedQuizzes: currentUser.completedQuizzes || '[]',
                    gamesPlayed: currentUser.gamesPlayed || 0,
                    recentActivity: currentUser.recentActivity || '[]',
                    // Don't send createdAt and lastLogin as they might cause validation issues
                    // The API will handle these automatically
                    isActive: currentUser.isActive !== undefined ? currentUser.isActive : true
                };
                
                console.log('Saving to database:', {
                    userId: currentUser.id,
                    stars: userStars,
                    data: dataToSave
                });
                
                const result = await apiCall(`users/${currentUser.id}`, 'PUT', dataToSave);
                console.log('Successfully saved to database:', result);
            } catch (error) {
                console.error('Failed to save to database:', error);
                console.error('Error details:', {
                    message: error.message,
                    currentUser: currentUser,
                    userStars: userStars
                });
                throw error; // Re-throw so sync knows it failed
            }
        }
        
        // Save user data to localStorage
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('userStars', userStars.toString());
                localStorage.setItem('userGrade', userGrade || '');
            }
        }
        
        // Clear saved user data
        function clearSavedUserData() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userStars');
            localStorage.removeItem('userGrade');
        }
        
        // Periodic sync with database (every 2 minutes)
        function startPeriodicSync() {
            if (currentUser) {
                setInterval(async () => {
                    showSyncIndicator();
                    await syncWithDatabase();
                    updateStarsDisplay();
                    updateGameAvailability();
                    hideSyncIndicator();
                }, 120000); // Sync every 2 minutes
            }
        }
        
        // Show sync indicator
        function showSyncIndicator() {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.style.display = 'inline';
            }
        }
        
        // Hide sync indicator
        function hideSyncIndicator() {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.style.display = 'none';
            }
        }
        
        // Test sync function for debugging
        async function testSync() {
            console.log('=== MANUAL SYNC TEST ===');
            console.log('Current user:', currentUser);
            console.log('Current stars:', userStars);
            
            try {
                showSyncIndicator();
                await syncWithDatabase();
                updateStarsDisplay();
                updateGameAvailability();
                hideSyncIndicator();
                console.log('Manual sync test completed successfully');
            } catch (error) {
                console.error('Manual sync test failed:', error);
                hideSyncIndicator();
            }
        }
        
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api/';
        
        // API Helper Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                console.log('API Call:', `${API_BASE_URL}${endpoint}`, { method, data });
                console.log('Data being sent:', JSON.stringify(data, null, 2));
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('API Success:', result);
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // Test content data
        const testContent = {
            module1: {
                title: "Grade 3 Math Test Prep",
                questions: [
                    {
                        question: "What is 7 × 8?",
                        options: ["56", "54", "58", "60"],
                        correct: 0,
                        explanation: "7 × 8 = 56. You can think of this as 7 groups of 8, or 8 + 8 + 8 + 8 + 8 + 8 + 8 = 56."
                    },
                    {
                        question: "Sarah has 24 stickers. She wants to put them equally into 6 bags. How many stickers will be in each bag?",
                        options: ["3", "4", "5", "6"],
                        correct: 1,
                        explanation: "24 ÷ 6 = 4. This is a division problem where we're sharing 24 stickers equally among 6 bags."
                    },
                    {
                        question: "Which fraction is equivalent to 1/2?",
                        options: ["2/4", "1/3", "3/4", "2/3"],
                        correct: 0,
                        explanation: "1/2 = 2/4 because both represent the same amount. 1/2 means 1 out of 2 parts, and 2/4 means 2 out of 4 parts."
                    }
                ]
            },
            module2: {
                title: "Grade 4 Math Practice",
                questions: [
                    {
                        question: "What is 3/4 + 1/4?",
                        options: ["4/8", "1", "4/4", "2/4"],
                        correct: 1,
                        explanation: "3/4 + 1/4 = 4/4 = 1. When adding fractions with the same denominator, add the numerators."
                    },
                    {
                        question: "Convert 0.5 to a fraction.",
                        options: ["1/2", "5/10", "1/5", "5/1"],
                        correct: 0,
                        explanation: "0.5 = 5/10 = 1/2. The decimal 0.5 represents half of a whole."
                    }
                ]
            },
            module3: {
                title: "Grade 7 Writing Practice",
                prompt: "Write an argumentative essay about whether students should have homework on weekends. Support your position with at least two reasons and evidence.",
                rubric: {
                    thesis: "Clear position statement (10 points)",
                    evidence: "Two or more supporting reasons with evidence (20 points)",
                    organization: "Logical structure with introduction, body, conclusion (15 points)",
                    language: "Appropriate word choice and sentence variety (10 points)",
                    conventions: "Correct grammar, spelling, and punctuation (5 points)"
                }
            },
            module4: {
                title: "Grade 8 Algebra Prep",
                questions: [
                    {
                        question: "Solve for x: 2x + 5 = 13",
                        options: ["x = 4", "x = 6", "x = 8", "x = 9"],
                        correct: 0,
                        explanation: "2x + 5 = 13, so 2x = 13 - 5 = 8, therefore x = 8 ÷ 2 = 4"
                    },
                    {
                        question: "What is the slope of the line y = 3x + 2?",
                        options: ["2", "3", "5", "6"],
                        correct: 1,
                        explanation: "In the equation y = mx + b, m is the slope. So the slope of y = 3x + 2 is 3."
                    }
                ]
            },
            module5: {
                title: "Test-Taking Strategies",
                strategies: [
                    "Read all directions carefully before starting",
                    "Answer easy questions first, then return to difficult ones",
                    "Use process of elimination for multiple choice questions",
                    "Show all work for math problems, even if not required",
                    "Manage time effectively - don't spend too long on one question",
                    "Review answers if time permits",
                    "Stay calm and focused throughout the test"
                ]
            }
        };

        // Role selection
        function selectRole(role) {
            // Remove active class from all role buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected role
            event.target.classList.add('active');
            
            // Hide all forms
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Show selected form
            document.getElementById(role + 'Form').classList.add('active');
        }
        
        // Show registration form
        function showRegistration() {
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById('studentRegistration').classList.add('active');
        }
        
        // Show login form
        function showLogin() {
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById('studentForm').classList.add('active');
        }
        
        // Student registration
        async function register(role, event) {
            event.preventDefault();
            
            if (role === 'student') {
                const name = document.getElementById('regStudentName').value;
                const id = document.getElementById('regStudentId').value;
                const grade = document.getElementById('regStudentGrade').value;
                const password = document.getElementById('regStudentPassword').value;
                const confirmPassword = document.getElementById('regStudentConfirmPassword').value;
                
                if (!name || !id || !grade || !password || !confirmPassword) {
                    alert('Please fill in all fields');
            return;
          }

                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                try {
                    // Create user object
                    const [firstName, ...lastNameParts] = name.split(' ');
                    const lastName = lastNameParts.join(' ') || '';
                    
                    const newUser = {
                        firstName: firstName,
                        lastName: lastName,
                        email: `${id}@student.qualityeducation.com`,
                        password: password,
                        role: 'student',
                        grade: `Grade ${grade}`,
                        stars: 50,
                        completedModules: '[]',
                        completedQuizzes: '[]',
                        gamesPlayed: 0,
                        recentActivity: '[]',
                        isActive: true
                    };
                    
                    // Register user via API
                    await apiCall('users', 'POST', newUser);
                    
                    alert('Registration successful! You can now login.');
                    showLogin();
                } catch (error) {
                    alert('Registration failed. Please try again.');
                    console.error('Registration error:', error);
                }
            }
        }

        // Theme toggle function
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
                document.getElementById('themeText').textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-moon';
                document.getElementById('themeText').textContent = 'Dark Mode';
            }
        }
        
        // Initialize theme on page load
        function initializeTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
                document.getElementById('themeText').textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-moon';
                document.getElementById('themeText').textContent = 'Dark Mode';
            }
        }
        
        // Grade-based module access
        function getModuleAccess(grade) {
            const gradeNum = parseInt(grade);
            const access = {
                module1: gradeNum >= 3, // Grade 3 Math
                module2: gradeNum >= 4, // Grade 4 Math
                module3: gradeNum >= 7, // Grade 7 Writing
                module4: gradeNum >= 8, // Grade 8 Algebra
                module5: gradeNum >= 3  // Test strategies (all grades)
            };
            return access;
        }
        
        // Update module visibility based on grade
        function updateModuleAccess() {
            if (!userGrade) return;
            
            const access = getModuleAccess(userGrade);
            
            Object.keys(access).forEach(moduleId => {
                const module = document.getElementById(moduleId);
                if (module) {
                    if (access[moduleId]) {
                        module.style.display = 'block';
                        module.classList.remove('locked');
        } else {
                        module.style.display = 'none';
                        module.classList.add('locked');
                    }
                }
            });
        }
        
        // New universal login (infers role from API response)
        async function loginAuto(event) {
            event.preventDefault();
            
            const userId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!userId || !password) {
                alert('Please enter both ID and password');
            return;
          }
          
            try {
                let email = userId;
                
                // Check if it's a known demo user and convert to proper email format
                const demoUsers = {
                    'harry.potter': 'harry.potter@hogwarts.edu',
                    'hermione.granger': 'hermione.granger@hogwarts.edu',
                    'ron.weasley': 'ron.weasley@hogwarts.edu',
                    'luna.lovegood': 'luna.lovegood@hogwarts.edu',
                    'draco.malfoy': 'draco.malfoy@hogwarts.edu',
                    'albus.dumbledore': 'albus.dumbledore@hogwarts.edu',
                    'minerva.mcgonagall': 'minerva.mcgonagall@hogwarts.edu',
                    'severus.snape': 'severus.snape@hogwarts.edu',
                    'admin': 'admin@qualityeducation.com'
                };
                
                // Check if userId is already a full email address
                if (userId.includes('@')) {
                    email = userId; // Use as-is if it's already an email
                } else if (demoUsers[userId]) {
                    email = demoUsers[userId]; // Use demo user mapping
                } else {
                    // Fallback: try common domains in order
                    const candidates = [
                        `${userId}@student.qualityeducation.com`,
                        `${userId}@teacher.qualityeducation.com`,
                        `${userId}@qualityeducation.com`
                    ];
                    email = candidates[0];
                }
                
                // Login via API
                console.log('Login attempt:', { email, password, userId });
                const user = await apiCall('users/login', 'POST', {
                    email: email,
                    password: password
                });
                console.log('Login response:', user);
                
                if (user) {
                    console.log('Login successful for user:', {
                        id: user.id,
                        name: `${user.firstName} ${user.lastName}`,
                        stars: user.stars,
                        role: user.role
                    });
                    
                    currentUser = {
                        id: user.id,
                        role: user.role,
                        name: `${user.firstName} ${user.lastName}`,
                        grade: user.grade,
                        stars: user.stars,
                        email: user.email,
                        firstName: user.firstName,
                        lastName: user.lastName
                    };
                    
                    userGrade = user.grade;
                    userStars = user.stars; // Use actual star count from database
                    
                    console.log('Set userStars to:', userStars);
                    
                    // Update lastLogin in database
                    try {
                        await apiCall(`users/${user.id}`, 'PUT', {
                            ...user,
                            lastLogin: new Date().toISOString()
                        });
                    } catch (updateError) {
                        console.warn('Failed to update lastLogin:', updateError);
                    }
                    
                    // Save user data to localStorage
                    saveUserData();
                    
                    // Start periodic sync with database
                    startPeriodicSync();
                    
                    if (user.role === 'student') {
                        showStudentDashboard();
                    } else if (user.role === 'teacher') {
                        showTeacherDashboard();
                    } else if (user.role === 'admin') {
                        showAdminDashboard();
                    }
                }
            } catch (error) {
                alert('Invalid credentials. Please try again.');
                console.error('Login error:', error);
            }
        }

        // Show admin dashboard
        function showAdminDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminDashboard').classList.add('active');
            
            // Show universal menu
            document.getElementById('universalMenu').style.display = 'block';
            
            // Update admin name
            const adminName = (currentUser.firstName || 'Admin') + ' ' + (currentUser.lastName || 'User');
            document.getElementById('adminName').textContent = adminName;
            
            // Load initial data
            loadAllUsers();
            loadAnalytics();
        }
        
        // Load all users for admin dashboard
        async function loadAllUsers() {
            try {
                const users = await apiCall('users', 'GET');
                const tbody = document.getElementById('usersTableBody');
                
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>${user.email}</td>
                        <td><span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'teacher' ? 'info' : 'success'}">${user.role}</span></td>
                        <td>${user.grade || 'N/A'}</td>
                        <td><i class="fas fa-star text-warning"></i> ${user.stars || 0}</td>
                        <td><span class="badge bg-${user.isActive ? 'success' : 'secondary'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load users</td></tr>';
            }
        }
        
        // Load analytics data
        async function loadAnalytics() {
            try {
                // Get all users first to calculate analytics
                const users = await apiCall('users', 'GET');
                
                if (!users || users.length === 0) {
                    // No users found
                    document.getElementById('totalUsers').textContent = '0';
                    document.getElementById('totalStudents').textContent = '0';
                    document.getElementById('totalTeachers').textContent = '0';
                    document.getElementById('totalStars').textContent = '0';
                    createRoleChart({});
                    createGradeChart({});
                    return;
                }
                
                // Calculate analytics from user data
                const analytics = {
                    totalUsers: users.length,
                    students: users.filter(u => u.role === 'student').length,
                    teachers: users.filter(u => u.role === 'teacher').length,
                    admins: users.filter(u => u.role === 'admin').length,
                    totalStars: users.reduce((sum, u) => sum + (u.stars || 0), 0),
                    roleDistribution: {
                        'Students': users.filter(u => u.role === 'student').length,
                        'Teachers': users.filter(u => u.role === 'teacher').length,
                        'Admins': users.filter(u => u.role === 'admin').length
                    },
                    gradeDistribution: {}
                };
                
                // Calculate grade distribution for students
                const students = users.filter(u => u.role === 'student');
                students.forEach(student => {
                    const grade = student.grade || 'Unknown';
                    analytics.gradeDistribution[grade] = (analytics.gradeDistribution[grade] || 0) + 1;
                });
                
                // Update stats cards
                document.getElementById('totalUsers').textContent = analytics.totalUsers;
                document.getElementById('totalStudents').textContent = analytics.students;
                document.getElementById('totalTeachers').textContent = analytics.teachers;
                document.getElementById('totalStars').textContent = analytics.totalStars;
                
                // Create charts
                createRoleChart(analytics.roleDistribution);
                createGradeChart(analytics.gradeDistribution);
            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Show error in stats cards
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('totalStudents').textContent = 'Error';
                document.getElementById('totalTeachers').textContent = 'Error';
                document.getElementById('totalStars').textContent = 'Error';
            }
        }
        
        // Create role distribution chart
        function createRoleChart(roleData) {
            const ctx = document.getElementById('roleChart');
            if (!ctx) return;
            
            // Clear any existing chart
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            const labels = Object.keys(roleData);
            const data = Object.values(roleData);
            
            if (labels.length === 0 || data.every(val => val === 0)) {
                // Show "No data" message
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const ctx2d = ctx.getContext('2d');
                ctx2d.font = '16px Arial';
                ctx2d.fillStyle = '#666';
                ctx2d.textAlign = 'center';
                ctx2d.fillText('No data available', ctx.width / 2, ctx.height / 2);
                return;
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#dc3545', '#0dcaf0', '#198754'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Create grade distribution chart
        function createGradeChart(gradeData) {
            const ctx = document.getElementById('gradeChart');
            if (!ctx) return;
            
            // Clear any existing chart
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            const labels = Object.keys(gradeData);
            const data = Object.values(gradeData);
            
            if (labels.length === 0 || data.every(val => val === 0)) {
                // Show "No data" message
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const ctx2d = ctx.getContext('2d');
                ctx2d.font = '16px Arial';
                ctx2d.fillStyle = '#666';
                ctx2d.textAlign = 'center';
                ctx2d.fillText('No student data available', ctx.width / 2, ctx.height / 2);
                return;
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Students',
                        data: data,
                        backgroundColor: '#198754',
                        borderColor: '#0f5132',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        
        // Show teacher dashboard
        function showTeacherDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('teacherDashboard').classList.add('active');
            
            // Show universal menu
            document.getElementById('universalMenu').style.display = 'block';
            
            // Update teacher name
            const teacherName = (currentUser.firstName || 'Teacher') + ' ' + (currentUser.lastName || 'User');
            document.getElementById('teacherName').textContent = teacherName;
            
            // Start periodic sync for teachers too
            startPeriodicSync();
        }
        
        // Show student dashboard
        function showStudentDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('studentDashboard').classList.add('active');
            
            // Show universal menu
            document.getElementById('universalMenu').style.display = 'block';
            
            // Update student name and grade display
            const studentName = (currentUser.firstName || 'Student') + ' ' + (currentUser.lastName || 'User');
            document.getElementById('studentName').textContent = studentName;
            
            // Update module access based on grade
            updateModuleAccess();
            
            updateStarsDisplay();
            updateGameAvailability();
            
            // Start periodic sync
            startPeriodicSync();
        }
        
        // Show join classroom modal
        function showJoinClassroom() {
            const modalHtml = `
                <div class="modal fade" id="joinClassroomModal" tabindex="-1" aria-labelledby="joinClassroomModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="joinClassroomModalLabel">Join Classroom</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="classroomCodeInput" class="form-label">Classroom Code</label>
                                    <input type="text" class="form-control" id="classroomCodeInput" placeholder="Enter classroom code (e.g., MATH7-ABC123)" style="text-transform: uppercase;">
                                    <div class="form-text">Ask your teacher for the classroom code</div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>How to join:</strong><br>
                                    1. Get the classroom code from your teacher<br>
                                    2. Enter the code above<br>
                                    3. Click "Join Classroom"<br>
                                    4. You'll earn 5 stars for joining!
                                </div>
                                <div class="alert alert-light">
                                    <i class="fas fa-lightbulb"></i>
                                    <strong>Example codes for testing:</strong><br>
                                    <code>MATH7-ABC123</code> - Grade 7 Math<br>
                                    <code>SCI8-XYZ789</code> - Grade 8 Science<br>
                                    <code>MATH7-DEF456</code> - Grade 7 Math (Alternative)<br>
                                    <code>SCI8-GHI789</code> - Grade 8 Science (Alternative)
                                </div>
                                <div class="alert alert-warning" id="joinError" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span id="joinErrorMessage">Invalid classroom code. Please check with your teacher.</span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="joinClassroom()">Join Classroom</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('joinClassroomModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('joinClassroomModal'));
            modal.show();
            
            // Clear any previous error messages
            const errorAlert = document.getElementById('joinError');
            if (errorAlert) {
                errorAlert.style.display = 'none';
            }
        }
        
        async function joinClassroom() {
            const code = document.getElementById('classroomCodeInput').value.trim().toUpperCase();
            
            if (!code) {
                showJoinError('Please enter a classroom code.');
                return;
            }
            
            try {
                // In a real app, this would validate the code against the database
                // For now, we'll simulate validation with some example codes
                const validCodes = ['MATH7-ABC123', 'SCI8-XYZ789', 'MATH7-DEF456', 'SCI8-GHI789'];
                
                if (validCodes.includes(code)) {
                    // Award stars for joining classroom
                    userStars += 5;
                    updateStarsDisplay();
                    saveUserData();
                    saveToDatabase();
                    
                    // Show success message
                    alert(`Successfully joined classroom with code ${code}!\n\nYou earned 5 stars for joining!`);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('joinClassroomModal'));
                    modal.hide();
                    
                    // In a real app, this would update the student's classroom assignment in the database
                    console.log(`Student ${currentUser.email} joined classroom with code: ${code}`);
                    
                } else {
                    showJoinError('Invalid classroom code. Please check with your teacher.');
                }
                
            } catch (error) {
                console.error('Error joining classroom:', error);
                showJoinError('An error occurred. Please try again.');
            }
        }
        
        function showJoinError(message) {
            const errorAlert = document.getElementById('joinError');
            const errorMessage = document.getElementById('joinErrorMessage');
            
            if (errorAlert && errorMessage) {
                errorMessage.textContent = message;
                errorAlert.style.display = 'block';
            }
        }
        
        // Teacher functions
        async function viewClassroom(classroomId) {
            try {
                console.log('Fetching students for classroom:', classroomId);
                
                // For now, we'll show all students since we don't have classroom assignments in the database yet
                const response = await apiCall('users', 'GET');
                console.log('API Response:', response);
                
                const allUsers = response || [];
                console.log('All users:', allUsers);
                
                // Filter for students only
                const students = allUsers.filter(user => user.role === 'student');
                console.log('Filtered students:', students);
                
                if (students.length === 0) {
                    alert('No students found in this classroom.');
                    return;
                }
                
                // Create a modal to display students
                const modalHtml = `
                    <div class="modal fade" id="studentsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Classroom Students</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="list-group">
                                        ${students.map(student => `
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>${student.firstName} ${student.lastName}</strong>
                                                    <br>
                                                    <small class="text-muted">Grade ${student.grade} • ${student.stars} stars</small>
                                                </div>
                                                <div>
                                                    <span class="badge bg-primary">${student.completedModules || 0} modules completed</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('studentsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('studentsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error fetching students:', error);
                alert('Error loading students. Please try again.');
            }
        }
        
        function createQuiz(classroomId) {
            // Show quiz creation modal
            showQuizCreationModal(classroomId);
        }
        
        function showQuizCreationModal(classroomId) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="quizCreationModal" tabindex="-1" aria-labelledby="quizCreationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="quizCreationModalLabel">Create New Quiz</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="quizForm">
                                    <div class="mb-3">
                                        <label for="quizTitle" class="form-label">Quiz Title</label>
                                        <input type="text" class="form-control" id="quizTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="quizDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizSubject" class="form-label">Subject</label>
                                        <select class="form-select" id="quizSubject" required>
                                            <option value="">Select Subject</option>
                                            <option value="math">Mathematics</option>
                                            <option value="english">English Language Arts</option>
                                            <option value="science">Science</option>
                                            <option value="social-studies">Social Studies</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizGrade" class="form-label">Target Grade Level</label>
                                        <select class="form-select" id="quizGrade" required>
                                            <option value="">Select Grade</option>
                                            <option value="3">Grade 3</option>
                                            <option value="4">Grade 4</option>
                                            <option value="5">Grade 5</option>
                                            <option value="6">Grade 6</option>
                                            <option value="7">Grade 7</option>
                                            <option value="8">Grade 8</option>
                                            <option value="9">Grade 9</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizTimeLimit" class="form-label">Time Limit (minutes)</label>
                                        <input type="number" class="form-control" id="quizTimeLimit" min="5" max="120" value="30">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Question Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="multipleChoice" checked>
                                            <label class="form-check-label" for="multipleChoice">
                                                Multiple Choice
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="trueFalse">
                                            <label class="form-check-label" for="trueFalse">
                                                True/False
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="shortAnswer">
                                            <label class="form-check-label" for="shortAnswer">
                                                Short Answer
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="essay">
                                            <label class="form-check-label" for="essay">
                                                Essay Questions
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="questionCount" class="form-label">Number of Questions</label>
                                        <input type="number" class="form-control" id="questionCount" min="5" max="50" value="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Difficulty Level</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="difficulty" id="easy" value="easy">
                                            <label class="form-check-label" for="easy">
                                                Easy
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="difficulty" id="medium" value="medium" checked>
                                            <label class="form-check-label" for="medium">
                                                Medium
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="difficulty" id="hard" value="hard">
                                            <label class="form-check-label" for="hard">
                                                Hard
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveQuiz()">Create Quiz</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('quizCreationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('quizCreationModal'));
            modal.show();
        }
        
        function saveQuiz() {
            const quizData = {
                title: document.getElementById('quizTitle').value,
                description: document.getElementById('quizDescription').value,
                subject: document.getElementById('quizSubject').value,
                grade: document.getElementById('quizGrade').value,
                timeLimit: document.getElementById('quizTimeLimit').value,
                questionTypes: {
                    multipleChoice: document.getElementById('multipleChoice').checked,
                    trueFalse: document.getElementById('trueFalse').checked,
                    shortAnswer: document.getElementById('shortAnswer').checked,
                    essay: document.getElementById('essay').checked
                },
                questionCount: document.getElementById('questionCount').value,
                difficulty: document.querySelector('input[name="difficulty"]:checked').value,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString()
            };
            
            // Validate form
            if (!quizData.title || !quizData.subject || !quizData.grade) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Save quiz (in a real app, this would save to database)
            console.log('Quiz created:', quizData);
            
            // Show success message
            alert(`Quiz "${quizData.title}" created successfully!`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quizCreationModal'));
            modal.hide();
            
            // Update teacher's quiz count (if we track this)
            if (currentUser.quizzesCreated) {
                currentUser.quizzesCreated++;
            } else {
                currentUser.quizzesCreated = 1;
            }
            
            // Save updated user data
            saveUserData();
            saveToDatabase();
        }
        
        function createCompetition() {
            alert('Competition creation tool coming soon! This will allow teachers to create engaging competitions for their students.');
        }
        
        function viewAnalytics() {
            alert('Analytics dashboard coming soon! This will show detailed student progress and performance metrics.');
        }
        
        // Classroom code management functions
        function copyClassroomCode(code) {
            navigator.clipboard.writeText(code).then(function() {
                // Show success feedback
                const button = event.target.closest('button');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check text-success"></i>';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy code. Please try again.');
            });
        }
        
        function regenerateClassroomCode(classroomId) {
            // Generate a new classroom code
            const prefix = classroomId.toUpperCase().replace(/\d/g, '');
            const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            const newCode = `${prefix}-${randomCode}`;
            
            // Update the display
            const codeElement = document.getElementById(`${classroomId}Code`);
            if (codeElement) {
                codeElement.textContent = newCode;
            }
            
            // Update the copy button onclick
            const copyButton = codeElement.parentElement.querySelector('button[onclick*="copyClassroomCode"]');
            if (copyButton) {
                copyButton.setAttribute('onclick', `copyClassroomCode('${newCode}')`);
            }
            
            // Show success message
            alert(`New classroom code generated: ${newCode}\n\nShare this code with your students so they can join your classroom.`);
            
            // In a real app, this would save to the database
            console.log(`Generated new code for ${classroomId}: ${newCode}`);
        }
        
        function generateClassroomCode(className, roomNumber) {
            // Generate a classroom code based on class name and room number
            const prefix = className.replace(/\s+/g, '').substring(0, 4).toUpperCase();
            const roomCode = roomNumber.toString().padStart(3, '0');
            const randomCode = Math.random().toString(36).substring(2, 5).toUpperCase();
            return `${prefix}-${roomCode}${randomCode}`;
        }
        
        function showCreateClassroomModal() {
            const modalHtml = `
                <div class="modal fade" id="createClassroomModal" tabindex="-1" aria-labelledby="createClassroomModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createClassroomModalLabel">Create New Classroom</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createClassroomForm">
                                    <div class="mb-3">
                                        <label for="className" class="form-label">Class Name</label>
                                        <input type="text" class="form-control" id="className" placeholder="e.g., Grade 7 Math" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="roomNumber" class="form-label">Room Number</label>
                                        <input type="text" class="form-control" id="roomNumber" placeholder="e.g., 101" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="subject" class="form-label">Subject</label>
                                        <select class="form-select" id="subject" required>
                                            <option value="">Select Subject</option>
                                            <option value="math">Mathematics</option>
                                            <option value="english">English Language Arts</option>
                                            <option value="science">Science</option>
                                            <option value="social-studies">Social Studies</option>
                                            <option value="history">History</option>
                                            <option value="art">Art</option>
                                            <option value="music">Music</option>
                                            <option value="physical-education">Physical Education</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="gradeLevel" class="form-label">Grade Level</label>
                                        <select class="form-select" id="gradeLevel" required>
                                            <option value="">Select Grade</option>
                                            <option value="K">Kindergarten</option>
                                            <option value="1">Grade 1</option>
                                            <option value="2">Grade 2</option>
                                            <option value="3">Grade 3</option>
                                            <option value="4">Grade 4</option>
                                            <option value="5">Grade 5</option>
                                            <option value="6">Grade 6</option>
                                            <option value="7">Grade 7</option>
                                            <option value="8">Grade 8</option>
                                            <option value="9">Grade 9</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description (Optional)</label>
                                        <textarea class="form-control" id="description" rows="3" placeholder="Brief description of the class..."></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createNewClassroom()">Create Classroom</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('createClassroomModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createClassroomModal'));
            modal.show();
        }
        
        function createNewClassroom() {
            const className = document.getElementById('className').value;
            const roomNumber = document.getElementById('roomNumber').value;
            const subject = document.getElementById('subject').value;
            const gradeLevel = document.getElementById('gradeLevel').value;
            const description = document.getElementById('description').value;
            
            // Validate form
            if (!className || !roomNumber || !subject || !gradeLevel) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Generate classroom code
            const classroomCode = generateClassroomCode(className, roomNumber);
            
            // Create classroom data
            const classroomData = {
                name: className,
                roomNumber: roomNumber,
                subject: subject,
                gradeLevel: gradeLevel,
                description: description,
                code: classroomCode,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString(),
                students: []
            };
            
            // In a real app, this would save to the database
            console.log('New classroom created:', classroomData);
            
            // Show success message with classroom code
            alert(`Classroom "${className}" created successfully!\n\nClassroom Code: ${classroomCode}\n\nShare this code with your students so they can join your classroom.`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createClassroomModal'));
            modal.hide();
            
            // In a real app, you would refresh the classroom list here
            // For now, we'll just show a message
            alert('Note: In a full implementation, the new classroom would appear in your classroom list.');
        }

        // Start learning module
        function startModule(moduleId) {
            const module = document.getElementById(moduleId);
            const progressElement = document.getElementById(moduleId + 'Progress');
            const progressBar = module.querySelector('.progress-fill');
            
            // Show test content based on module type
            if (moduleId === 'module5') {
                showTestStrategies(moduleId);
            } else if (moduleId === 'module3') {
                showWritingPrompt(moduleId);
            } else {
                showTestQuestions(moduleId);
            }
        }
        
        // Show test questions for math modules
        function showTestQuestions(moduleId) {
            const content = testContent[moduleId];
            const questions = content.questions;
            let currentQuestion = 0;
            let correctAnswers = 0;
            
            // Create modal for test questions
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${content.title}</h5>
                            <button type="button" class="btn-close" onclick="closeTestModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div id="questionContainer">
                                <h6>Question ${currentQuestion + 1} of ${questions.length}</h6>
                                <p class="question-text">${questions[currentQuestion].question}</p>
                                <div class="options-container">
                                    ${questions[currentQuestion].options.map((option, index) => 
                                        `<button class="btn btn-outline-primary option-btn" onclick="selectAnswer(${index}, ${questions[currentQuestion].correct})">${option}</button>`
                                    ).join('')}
                                </div>
                                <div id="explanation" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Explanation:</strong> <span id="explanationText"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">Next Question</button>
                            <button class="btn btn-success" id="finishBtn" onclick="finishTest()" style="display: none;">Finish Test</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Global functions for the test
            window.selectAnswer = function(selectedIndex, correctIndex) {
                const isCorrect = selectedIndex === correctIndex;
                if (isCorrect) correctAnswers++;
                
                // Show explanation
                document.getElementById('explanationText').textContent = questions[currentQuestion].explanation;
                document.getElementById('explanation').style.display = 'block';
                
                // Disable all options
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === questions[currentQuestion].options[correctIndex]) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-success');
                    } else if (btn.textContent === questions[currentQuestion].options[selectedIndex] && !isCorrect) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-danger');
                    }
                });
                
                // Show next button
                if (currentQuestion < questions.length - 1) {
                    document.getElementById('nextBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('finishBtn').style.display = 'inline-block';
                }
            };
            
            window.nextQuestion = function() {
                currentQuestion++;
                if (currentQuestion < questions.length) {
                    document.getElementById('questionContainer').innerHTML = `
                        <h6>Question ${currentQuestion + 1} of ${questions.length}</h6>
                        <p class="question-text">${questions[currentQuestion].question}</p>
                        <div class="options-container">
                            ${questions[currentQuestion].options.map((option, index) => 
                                `<button class="btn btn-outline-primary option-btn" onclick="selectAnswer(${index}, ${questions[currentQuestion].correct})">${option}</button>`
                            ).join('')}
                        </div>
                        <div id="explanation" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Explanation:</strong> <span id="explanationText"></span>
                            </div>
                        </div>
                    `;
                    document.getElementById('nextBtn').style.display = 'none';
                    document.getElementById('finishBtn').style.display = 'none';
                }
            };
            
            window.finishTest = function() {
                const score = Math.round((correctAnswers / questions.length) * 100);
                alert(`Test completed! You scored ${score}% (${correctAnswers}/${questions.length} correct)`);
                closeTestModal();
                completeModule(moduleId);
            };
            
            window.closeTestModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        // Show writing prompt for module 3
        function showWritingPrompt(moduleId) {
            const content = testContent[moduleId];
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${content.title}</h5>
                            <button type="button" class="btn-close" onclick="closeTestModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <h6>Writing Prompt:</h6>
                                <p class="alert alert-light">${content.prompt}</p>
                            </div>
                            <div class="mb-3">
                                <h6>Rubric:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item"><strong>Thesis:</strong> ${content.rubric.thesis}</li>
                                    <li class="list-group-item"><strong>Evidence:</strong> ${content.rubric.evidence}</li>
                                    <li class="list-group-item"><strong>Organization:</strong> ${content.rubric.organization}</li>
                                    <li class="list-group-item"><strong>Language:</strong> ${content.rubric.language}</li>
                                    <li class="list-group-item"><strong>Conventions:</strong> ${content.rubric.conventions}</li>
                                </ul>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Your Essay:</label>
                                <textarea class="form-control" rows="15" id="essayText" placeholder="Write your essay here..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="submitEssay()">Submit Essay</button>
                            <button class="btn btn-secondary" onclick="closeTestModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.submitEssay = function() {
                const essay = document.getElementById('essayText').value;
                if (essay.trim().length < 100) {
                    alert('Please write at least 100 words for your essay.');
                    return;
                }
                alert('Essay submitted! Great job on your writing practice.');
                closeTestModal();
                completeModule(moduleId);
            };
            
            window.closeTestModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        // Show test strategies for module 5
        function showTestStrategies(moduleId) {
            const content = testContent[moduleId];
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${content.title}</h5>
                            <button type="button" class="btn-close" onclick="closeTestModal()"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Essential Test-Taking Strategies:</h6>
                            <ol class="list-group list-group-numbered">
                                ${content.strategies.map(strategy => 
                                    `<li class="list-group-item">${strategy}</li>`
                                ).join('')}
                            </ol>
                            <div class="alert alert-warning mt-3">
                                <strong>Remember:</strong> Practice these strategies regularly to build confidence and improve your test performance!
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="completeStrategies()">I Understand</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.completeStrategies = function() {
                closeTestModal();
                completeModule(moduleId);
            };
            
            window.closeTestModal = function() {
                document.body.removeChild(modal);
            };
        }

        // Complete module
        async function completeModule(moduleId) {
            const module = document.getElementById(moduleId);
            const starsEarned = parseInt(module.querySelector('.module-stars').textContent.match(/\d+/)[0]);
            
            // Add stars
            userStars += starsEarned;
            completedModules++;
            
            // Update progress
            moduleProgress[moduleId] = 100;
            const progressElement = document.getElementById(moduleId + 'Progress');
            const progressBar = module.querySelector('.progress-fill');
            if (progressElement) progressElement.textContent = '100';
            if (progressBar) progressBar.style.width = '100%';
            
            // Update UI
            module.classList.add('completed');
            module.querySelector('.module-actions').innerHTML = '<button class="btn btn-success">Completed!</button>';
            updateStarsDisplay();
            updateGameAvailability();
            
            // Save progress to database
            try {
                const completedModulesList = JSON.parse(currentUser.completedModules || '[]');
                if (!completedModulesList.includes(moduleId)) {
                    completedModulesList.push(moduleId);
                }
                
                // Update currentUser
                currentUser.stars = userStars;
                currentUser.completedModules = JSON.stringify(completedModulesList);
                
                // Save to database and localStorage
                await saveToDatabase();
                saveUserData();
            } catch (error) {
                console.error('Failed to save progress:', error);
            }
            
            alert(`Congratulations! You completed ${testContent[moduleId].title} and earned ${starsEarned} stars!`);
        }

        // Play game
        async function playGame(gameType) {
            const gameCosts = {
                flappy: 10,
                snakes: 15,
                memory: 12
            };
            
            const cost = gameCosts[gameType];
            
            if (userStars >= cost) {
                userStars -= cost;
                updateStarsDisplay();
                updateGameAvailability();
                
                // Save star spending to database
                try {
                    // Update currentUser
                    currentUser.stars = userStars;
                    currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
                    
                    // Save to database and localStorage
                    await saveToDatabase();
                    saveUserData();
                } catch (error) {
                    console.error('Failed to save game play:', error);
                }
                
                // Open game in new window
                const gamePages = {
                    flappy: 'flappy-bird.html',
                    snakes: 'snakes.html',
                    memory: 'memory.html'
                };
                
                const gameWindow = window.open(gamePages[gameType], '_blank', 'width=800,height=700,scrollbars=yes,resizable=yes');
                
                // Focus on the new window
                if (gameWindow) {
                    gameWindow.focus();
          }
        } else {
                alert(`You need ${cost} stars to play this game. You have ${userStars} stars.`);
            }
        }

        // Update stars display
        function updateStarsDisplay() {
            console.log('Updating stars display with value:', userStars);
            document.getElementById('studentStars').textContent = userStars;
            document.getElementById('totalStars').textContent = userStars;
        }

        // Update game availability
        function updateGameAvailability() {
            const gameCosts = {
                flappy: 10,
                snakes: 15,
                memory: 12
            };
            
            Object.keys(gameCosts).forEach(game => {
                const btn = document.getElementById(game + 'Btn');
                const card = document.getElementById(game + 'GameCard');
                
                if (userStars >= gameCosts[game]) {
                    btn.disabled = false;
                    card.classList.remove('locked');
                } else {
                    btn.disabled = true;
                    card.classList.add('locked');
                }
            });
        }

        // Logout
        // Universal Menu Functions
        function toggleUniversalMenu() {
            const menu = document.getElementById('universalMenu');
            menu.classList.toggle('show');
        }
        
        function viewProfile() {
            if (!currentUser) {
                alert('Please log in to view your profile.');
                return;
            }
            
            const fullName = (currentUser.firstName || 'User') + ' ' + (currentUser.lastName || 'Name');
            const profileInfo = `
                <div class="profile-modal">
                    <h4><i class="fas fa-user-circle"></i> Profile Information</h4>
                    <div class="profile-details">
                        <p><strong>Name:</strong> ${fullName}</p>
                        <p><strong>Email:</strong> ${currentUser.email || 'Not provided'}</p>
                        <p><strong>Role:</strong> ${currentUser.role ? currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1) : 'Unknown'}</p>
                        ${currentUser.grade && currentUser.grade !== 'N/A' ? `<p><strong>Grade:</strong> ${currentUser.grade}</p>` : ''}
                        <p><strong>Stars:</strong> <i class="fas fa-star text-warning"></i> ${userStars || 0}</p>
                        <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                    </div>
                </div>
            `;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">My Profile</h5>
                            <button type="button" class="btn-close" onclick="closeProfileModal()"></button>
                        </div>
                        <div class="modal-body">
                            ${profileInfo}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            toggleUniversalMenu(); // Close the menu
        }
        
        function closeProfileModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function logout() {
            console.log('Logging out user:', currentUser);
            
            currentUser = null;
            userGrade = null;
            userStars = 0;
            
            // Clear saved user data
            clearSavedUserData();
            
            // Hide all dashboards
            document.getElementById('studentDashboard').classList.remove('active');
            document.getElementById('teacherDashboard').classList.remove('active');
            document.getElementById('adminDashboard').classList.remove('active');
            
            // Hide universal menu
            document.getElementById('universalMenu').style.display = 'none';
            
            // Show login page
            document.getElementById('loginPage').style.display = 'flex';
            
            // Reset all login forms
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Reset role buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            console.log('Logout completed');
            
            // Refresh the page immediately after logout
            window.location.reload();
        }

        // Listen for messages from game windows
        window.addEventListener('message', function(event) {
            if (event.data.type === 'playGame') {
                const { gameType, cost } = event.data;
                
                if (userStars >= cost) {
                    userStars -= cost;
                    updateStarsDisplay();
                    updateGameAvailability();
                    
                    // Save star spending to database
                    if (currentUser) {
                        // Update currentUser
                        currentUser.stars = userStars;
                        currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
                        
                        // Save to database and localStorage
                        saveToDatabase().then(() => {
                            saveUserData();
                        }).catch(error => {
                            console.error('Failed to save game play:', error);
                        });
                    }
                } else {
                    alert(`You need ${cost} stars to play this game. You have ${userStars} stars.`);
                    // Send message back to game window to prevent play again
                    event.source.postMessage({ type: 'insufficientStars' }, '*');
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initializeTheme();
            await loadSavedUserData(); // Load saved user data first
            // updateStarsDisplay() and updateGameAvailability() are now called within loadSavedUserData()
            // after the user data is fully loaded and synced with the database
        });
    </script>
  </body>
</html>
